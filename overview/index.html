<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"orezzero.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="åˆ†äº«æˆ‘çš„æ—¥å¸¸æŠ€æœ¯åšå®¢">
<meta property="og:type" content="website">
<meta property="og:title" content="Orez çš„åšå®¢">
<meta property="og:url" content="http://orezzero.github.io/overview/index.html">
<meta property="og:site_name" content="Orez çš„åšå®¢">
<meta property="og:description" content="åˆ†äº«æˆ‘çš„æ—¥å¸¸æŠ€æœ¯åšå®¢">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Orez">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://orezzero.github.io/overview/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Orez çš„åšå®¢</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Orez çš„åšå®¢</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-overview">

    <a href="/overview" rel="section"><i class="fa fa-eye fa-fw"></i>overview</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/OrezzerO" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2024/07/25/print_native_with_java_agent/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="åˆ†äº«æˆ‘çš„æ—¥å¸¸æŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/25/print_native_with_java_agent/" class="post-title-link" itemprop="url">ä½¿ç”¨ JavaAgent æ‰“å°æ‰€æœ‰ Native è°ƒç”¨</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-07-25 22:05:03" itemprop="dateCreated datePublished" datetime="2024-07-25T22:05:03+00:00">2024-07-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æˆ‘æ‰“ç®—å¯¹ Java ç½‘ç»œçš„åº•å±‚è¿›è¡Œæ‹†è§£ï¼Œå°† Java ç½‘ç»œæ“ä½œä¸ç³»ç»Ÿè°ƒç”¨å…³è”èµ·æ¥ï¼Œæ¢ç©¶é‚£äº›åœ¨å…¬ä¼—å·ä¸Šé¢‘ç¹å‡ºç°çš„çŸ¥è¯†ç‚¹çš„å®é™…è¿ä½œæ–¹å¼ã€‚é€šè¿‡ strace è™½èƒ½è¿½è¸ªåˆ°ç³»ç»Ÿè°ƒç”¨ï¼Œç„¶è€Œå´éš¾ä»¥æ¸…æ™°è¾¨åˆ«å…·ä½“æ˜¯ç”±å“ªè¡Œ Java ä»£ç å‘èµ·çš„ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™ä¸­é—´ç¼ºå¤±äº†ä¸€å±‚ Native å±‚ã€‚å› æ­¤ï¼Œæˆ‘æœŸæœ›æŠŠè°ƒç”¨è¿‡ç¨‹ä¸­çš„ Native æ–¹æ³•å…¨éƒ¨æ‰“å°å‡ºæ¥ã€‚</p>
<h2 id="åŸç†è§£æ"><a href="#åŸç†è§£æ" class="headerlink" title="åŸç†è§£æ"></a>åŸç†è§£æ</h2><p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒJava Agent èƒ½å¤Ÿç”¨äºå®ç°å­—èŠ‚ç å¢å¼ºã€‚ä½† Java Native æ–¹æ³•ä¸å­˜åœ¨å­—èŠ‚ç ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥è¿›è¡Œå­—èŠ‚ç å¢å¼ºã€‚<br>æˆ‘ä»¬éœ€è¦é‡‡å–è¿‚å›çš„ç­–ç•¥ï¼š</p>
<ol>
<li>å¯¹ Native æ–¹æ³•è¿›è¡Œé‡å‘½åï¼Œå¹¶æ·»åŠ ä¸€ä¸ªå‰ç¼€ã€‚</li>
<li>æ„å»ºä¸€ä¸ªä¸ä¹‹å‰ Native æ–¹æ³•åç§°ç›¸åŒçš„æ™®é€šæ–¹æ³•ã€‚</li>
<li>å€ŸåŠ©å­—èŠ‚ç å¢å¼ºè¿™ä¸ªæ™®é€šæ–¹æ³•ï¼Œå†ç”±è¯¥æ™®é€šæ–¹æ³•å»è°ƒç”¨ Native æ–¹æ³•ã€‚<br>ä¾‹å¦‚ï¼Œå‡è®¾åŸæœ¬çš„ Native æ–¹æ³•åä¸º intern ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶é‡å‘½åä¸º enhance_intern ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªåä¸º intern çš„æ™®é€šæ–¹æ³•ï¼Œåœ¨å­—èŠ‚ç å¢å¼ºè¿™ä¸ªæ–°åˆ›å»ºçš„æ™®é€šæ–¹æ³•åï¼Œç”±å®ƒæ¥è°ƒç”¨ enhance_intern ã€‚è¿™ç§æ–¹å¼å°±å·§å¦™åœ°è§£å†³äº† Native æ–¹æ³•æ— æ³•ç›´æ¥å­—èŠ‚ç å¢å¼ºçš„é—®é¢˜ã€‚</li>
</ol>
<p>ä¸¾ä¸ªå…·ä½“ğŸŒ°:<br>ä¿®æ”¹å‰æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">intern</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹å:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">enhance_intern</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">intern</span><span class="params">()</span>&#123;</span><br><span class="line">  enhance_intern();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å®è·µç»†èŠ‚"><a href="#å®è·µç»†èŠ‚" class="headerlink" title="å®è·µç»†èŠ‚"></a>å®è·µç»†èŠ‚</h2><p>Native æ–¹æ³•åä¸€æ—¦æ›´æ”¹ï¼Œå…¶ä¸å…·ä½“ Native å®ç°çš„æ˜ å°„å…³ç³»ä¾¿ä¼šé­åˆ°ç ´åï¼Œæ­¤æ—¶å°±éœ€è¦å€ŸåŠ© java.lang.instrument.Instrumentation#setNativeMethodPrefix æ¥é‡æ–°æ„å»ºæ˜ å°„å…³ç³»ã€‚è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨åœ¨äºï¼Œå½“ Native æ–¹æ³•æ— æ³•è¢«æ‰¾åˆ°æ—¶ï¼Œé€šè¿‡å»é™¤å‰ç¼€å†æ¬¡å°è¯•å¯»æ‰¾ã€‚</p>
<p>ç„¶è€Œï¼ŒJVM é»˜è®¤å¹¶ä¸æ”¯æŒè®¾ç½® Native æ–¹æ³•å‰ç¼€ï¼Œéœ€è¦åœ¨ JavaAgent çš„ manifest ä¸­ï¼Œè®¾å®š Can-Set-Native-Method-Prefix: true ã€‚</p>
<h2 id="çœ‹çœ‹ä»£ç "><a href="#çœ‹çœ‹ä»£ç " class="headerlink" title="çœ‹çœ‹ä»£ç "></a>çœ‹çœ‹ä»£ç </h2><p>å®ç°è¿™ä¹ˆä¸€ä¸ª Java Agent åªéœ€è¦ä¸¤ä¸ªç±», é‚£å°±ç›´æ¥ä¸Šä»£ç å’Œæ³¨é‡Šäº†:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Premain</span> &#123;</span><br><span class="line">    <span class="comment">// premain æ–¹æ³•ï¼Œåœ¨ Java ä»£ç†çš„é¢„åˆå§‹åŒ–é˜¶æ®µè¢«è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">premain</span><span class="params">(String args, Instrumentation inst)</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ recoverMain æ–¹æ³•è¿›è¡Œç›¸å…³æ“ä½œ</span></span><br><span class="line">        recoverMain(inst);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// agentmain æ–¹æ³•ï¼Œåœ¨ Java ä»£ç†çš„å¯åŠ¨é˜¶æ®µè¢«è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String args, Instrumentation inst)</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ recoverMain æ–¹æ³•è¿›è¡Œç›¸å…³æ“ä½œ</span></span><br><span class="line">        recoverMain(inst);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// recoverMain æ–¹æ³•ï¼Œç”¨äºæ‰§è¡Œæ¢å¤ä¸»æµç¨‹çš„æ“ä½œ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">recoverMain</span><span class="params">(Instrumentation inst)</span> &#123;</span><br><span class="line">        <span class="comment">// è¾“å‡º inst æ˜¯å¦æ”¯æŒæœ¬åœ°æ–¹æ³•å‰ç¼€</span></span><br><span class="line">        System.out.println(inst.isNativeMethodPrefixSupported());</span><br><span class="line">        <span class="comment">// åˆ›å»º NativeWrappingClassFileTransformer ç±»çš„å¯¹è±¡</span></span><br><span class="line">        <span class="type">NativeWrappingClassFileTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeWrappingClassFileTransformer</span>();</span><br><span class="line">        <span class="comment">// å‘ inst æ·»åŠ è½¬æ¢å™¨ï¼Œå¹¶è®¾ç½®ä¸ºå¯ä»¥é‡è½¬æ¢</span></span><br><span class="line">        inst.addTransformer(transformer,<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// ä¸º inst è®¾ç½®æœ¬åœ°æ–¹æ³•å‰ç¼€</span></span><br><span class="line">        inst.setNativeMethodPrefix(transformer, NativeWrappingClassFileTransformer.PREFIX);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NativeWrappingClassFileTransformer</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰ä¸€ä¸ªè¡¨ç¤º BlockHound è¿è¡Œæ—¶ç±»å‹çš„ Type å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Type</span> <span class="variable">BLOCK_HOUND_RUNTIME_TYPE</span> <span class="operator">=</span> Type.getType(<span class="string">&quot;Lreactor/blockhound/BlockHoundRuntime;&quot;</span>);</span><br><span class="line">    <span class="comment">// å®šä¹‰æœ¬åœ°æ–¹æ³•çš„å‰ç¼€å­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX</span> <span class="operator">=</span> <span class="string">&quot;$$BlockHound$$_&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">    NativeWrappingClassFileTransformer() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®ç° ClassFileTransformer æ¥å£çš„ transform æ–¹æ³•</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loader          ç±»åŠ è½½å™¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> className       ç±»å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classBeingRedefined æ­£åœ¨è¢«é‡å®šä¹‰çš„ç±»</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> protectionDomain ä¿æŠ¤åŸŸ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classfileBuffer ç±»æ–‡ä»¶ç¼“å†²åŒº</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è½¬æ¢åçš„å­—èŠ‚æ•°ç»„ï¼Œå¦‚æœä¸è¿›è¡Œè½¬æ¢åˆ™è¿”å› null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] transform(</span><br><span class="line">            ClassLoader loader,</span><br><span class="line">            String className,</span><br><span class="line">            Class&lt;?&gt; classBeingRedefined,</span><br><span class="line">            ProtectionDomain protectionDomain,</span><br><span class="line">            <span class="type">byte</span>[] classfileBuffer</span><br><span class="line">    ) &#123;</span><br><span class="line"><span class="comment">//        if (!className.startsWith(&quot;java/net/&quot;)) &#123;</span></span><br><span class="line"><span class="comment">//            return null;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»º ClassReader å¯¹è±¡æ¥è¯»å–ç±»æ–‡ä»¶ç¼“å†²åŒº</span></span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">cr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(classfileBuffer);</span><br><span class="line">        <span class="comment">// åˆ›å»º ClassWriter å¯¹è±¡ç”¨äºå†™å…¥è½¬æ¢åçš„ç±»</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(cr, ClassWriter.COMPUTE_MAXS);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ¥å— NativeWrappingClassVisitor è¿›è¡Œç±»çš„è®¿é—®å’Œè½¬æ¢</span></span><br><span class="line">            cr.accept(<span class="keyword">new</span> <span class="title class_">NativeWrappingClassVisitor</span>(cw, className), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·å–è½¬æ¢åçš„å­—èŠ‚æ•°ç»„</span></span><br><span class="line">            classfileBuffer = cw.toByteArray();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="comment">// æ‰“å°å¼‚å¸¸å †æ ˆè·Ÿè¸ª</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">// æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿”å›è½¬æ¢åçš„ç±»æ–‡ä»¶å­—èŠ‚æ•°ç»„</span></span><br><span class="line">        <span class="keyword">return</span> classfileBuffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†…éƒ¨é™æ€ç±» NativeWrappingClassVisitorï¼Œç»§æ‰¿è‡ª ClassVisitor</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">NativeWrappingClassVisitor</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å­˜å‚¨ç±»å</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String className;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">        NativeWrappingClassVisitor(ClassVisitor cw, String internalClassName) &#123;</span><br><span class="line">            <span class="comment">// è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°</span></span><br><span class="line">            <span class="built_in">super</span>(ASM7, cw);</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–ç±»å</span></span><br><span class="line">            <span class="built_in">this</span>.className = internalClassName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * é‡å†™ visitMethod æ–¹æ³•ï¼Œå¤„ç†æ–¹æ³•è®¿é—®</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> access          æ–¹æ³•çš„è®¿é—®æ ‡å¿—</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> name            æ–¹æ³•å</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> descriptor      æ–¹æ³•æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> signature       æ–¹æ³•ç­¾å</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> exceptions      æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> æ–¹æ³•è®¿é—®å™¨</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> MethodVisitor <span class="title function_">visitMethod</span><span class="params">(<span class="type">int</span> access,</span></span><br><span class="line"><span class="params">                                         String name,</span></span><br><span class="line"><span class="params">                                         String descriptor,</span></span><br><span class="line"><span class="params">                                         String signature,</span></span><br><span class="line"><span class="params">                                         String[] exceptions)</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ–¹æ³•ä¸æ˜¯æœ¬åœ°æ–¹æ³•</span></span><br><span class="line">            <span class="keyword">if</span> ((access &amp; ACC_NATIVE) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// è°ƒç”¨çˆ¶ç±»çš„ visitMethod æ–¹æ³•</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.visitMethod(access, name, descriptor, signature, exceptions);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è®¿é—®ä¿®æ”¹åçš„æœ¬åœ°æ–¹æ³•</span></span><br><span class="line">            <span class="built_in">super</span>.visitMethod(</span><br><span class="line">                    ACC_NATIVE | ACC_PRIVATE | ACC_FINAL | (access &amp; ACC_STATIC),</span><br><span class="line">                    PREFIX + name,</span><br><span class="line">                    descriptor,</span><br><span class="line">                    signature,</span><br><span class="line">                    exceptions</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è®¿é—®åŸå§‹çš„éæœ¬åœ°æ–¹æ³•</span></span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">delegatingMethodVisitor</span> <span class="operator">=</span> <span class="built_in">super</span>.visitMethod(</span><br><span class="line">                    access &amp; ~ACC_NATIVE, name, descriptor, signature, exceptions);</span><br><span class="line">            delegatingMethodVisitor.visitCode();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è¿”å›è‡ªå®šä¹‰çš„æ–¹æ³•è®¿é—®å™¨</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MethodVisitor</span>(ASM7, delegatingMethodVisitor) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitEnd</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æ·»åŠ æ‰“å°è¯­å¥æ‰“å°æ–¹æ³•å</span></span><br><span class="line">                    visitFieldInsn(GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">                    visitLdcInsn(<span class="string">&quot;Method called: &quot;</span> + className + <span class="string">&quot;.&quot;</span> + name);</span><br><span class="line">                    visitMethodInsn(INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    <span class="type">Type</span> <span class="variable">returnType</span> <span class="operator">=</span> Type.getReturnType(descriptor);</span><br><span class="line">                    Type[] argumentTypes = Type.getArgumentTypes(descriptor);</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">isStatic</span> <span class="operator">=</span> (access &amp; ACC_STATIC)!= <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">if</span> (!isStatic) &#123;</span><br><span class="line">                        visitVarInsn(ALOAD, <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> isStatic? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">for</span> (Type argumentType : argumentTypes) &#123;</span><br><span class="line">                        visitVarInsn(argumentType.getOpcode(ILOAD), index);</span><br><span class="line">                        index += argumentType.getSize();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    visitMethodInsn(</span><br><span class="line">                            isStatic? INVOKESTATIC : INVOKESPECIAL,</span><br><span class="line">                            className,</span><br><span class="line">                            PREFIX + name,</span><br><span class="line">                            descriptor,</span><br><span class="line">                            <span class="literal">false</span></span><br><span class="line">                    );</span><br><span class="line"></span><br><span class="line">                    visitInsn(returnType.getOpcode(IRETURN));</span><br><span class="line">                    visitMaxs(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                    <span class="built_in">super</span>.visitEnd();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/12/19/skywalking_java_api/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="åˆ†äº«æˆ‘çš„æ—¥å¸¸æŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/19/skywalking_java_api/" class="post-title-link" itemprop="url">SkyWalking-java ç®€ä»‹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-19 16:29:59" itemprop="dateCreated datePublished" datetime="2022-12-19T16:29:59+00:00">2022-12-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>æœ€è¿‘åœ¨è°ƒç ”è·¨çº¿ç¨‹ trace, è°ƒç ”äº†è·¨çº¿ç¨‹ skywalking-java (skywalking çš„ java å®¢æˆ·ç«¯) çš„è·¨çº¿ç¨‹ trace å®ç°.</p>
<p>æœ¬æ–‡çš„å†…å®¹åŒ…æ‹¬:</p>
<ol>
<li>skywalking-java api çš„ç®€å•ä½¿ç”¨</li>
<li>skywalking-java api é‡è¦æ¦‚å¿µåŠå¯¹åº”çš„å®ç°</li>
<li>skywalking-java è·¨çº¿ç¨‹ trace æ˜¯å¦‚ä½•å®ç°çš„</li>
<li>skywalking çš„ç“¶é¢ˆä»¥åŠæˆ‘é‡åˆ°çš„é—®é¢˜.</li>
</ol>
<p>å‰ç½®çŸ¥è¯†:</p>
<h1 id="Skywalking-java-api-çš„ç®€å•ä½¿ç”¨"><a href="#Skywalking-java-api-çš„ç®€å•ä½¿ç”¨" class="headerlink" title="Skywalking-java api çš„ç®€å•ä½¿ç”¨"></a>Skywalking-java api çš„ç®€å•ä½¿ç”¨</h1><h2 id="æ™®é€šç”¨æˆ·API"><a href="#æ™®é€šç”¨æˆ·API" class="headerlink" title="æ™®é€šç”¨æˆ·API"></a>æ™®é€šç”¨æˆ·API</h2><p>å®˜æ–¹æ–‡æ¡£ä¸­ <a target="_blank" rel="noopener" href="https://skywalking.apache.org/docs/skywalking-java/v8.13.0/en/setup/service-agent/java-agent/application-toolkit-trace/">Tracing APIs</a> ä¸€èŠ‚ä¸­æœ‰ç”¨æˆ·APIè¯¦ç»†çš„è¯´æ˜. ç®€å•æ¥è¯´,åŠ ä¸€ä¸ª <code>@Tracer</code> æ³¨è§£å°±èƒ½å®Œæˆä¸€èˆ¬ç”¨æˆ·çš„éœ€æ±‚:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Trace</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">methodYouWantToTrace</span><span class="params">(String param1, String param2)</span> &#123;</span><br><span class="line">    <span class="comment">// ActiveSpan.setOperationName(&quot;Customize your own operation name, if this is an entry span, this would be an endpoint name&quot;);</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="ä¸­é—´ä»¶ç”¨æˆ·-API"><a href="#ä¸­é—´ä»¶ç”¨æˆ·-API" class="headerlink" title="ä¸­é—´ä»¶ç”¨æˆ· API"></a>ä¸­é—´ä»¶ç”¨æˆ· API</h2><p>å¯¹äºæ™®é€šç”¨æˆ·æ¥è¯´,ä¸Šé¢è¿™ä¸ªæ¥å£å·²ç»å¤Ÿç”¨äº†, ä½†å¯¹äºä¸­é—´ä»¶ç”¨æˆ·æ¥è¯´, è¦éœ€è¦æ·±å…¥çœ‹ä¸‹éåˆ‡é¢çš„API:</p>
<h3 id="Span-åˆ†ç±»"><a href="#Span-åˆ†ç±»" class="headerlink" title="Span åˆ†ç±»"></a>Span åˆ†ç±»</h3><p><a target="_blank" rel="noopener" href="https://skywalking.apache.org/docs/skywalking-java/v8.13.0/en/setup/service-agent/java-agent/java-plugin-development-guide/">Skywlking ä¸­å°† Span åˆ†ä¸ºä¸‰ç±»</a> :</p>
<ol>
<li><strong>EntrySpan</strong>: ä»£è¡¨ä¸€ä¸ªæœåŠ¡æä¾›è€….</li>
<li><strong>LocalSpan</strong>: ä»£è¡¨ä¸€ä¸ªæ™®é€šæ–¹æ³•.æ³¨æ„,å®ƒæ—¢ä¸ä»£è¡¨ä¸€ä¸ªæœåŠ¡æä¾›è€…, ä¹Ÿä¸ä»£è¡¨æœåŠ¡æ¶ˆè´¹è€….</li>
<li><strong>ExitSpan</strong>: ä»£è¡¨ä¸€ä»½æœåŠ¡æ¶ˆè´¹è€…</li>
</ol>
<p>åˆ›å»ºä¸Šé¢ä¸‰ä¸ª Span çš„æ–¹æ³•åˆ†åˆ«ä¸º <a target="_blank" rel="noopener" href="https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/ContextManager.java">ContextManager.java</a> ä¸­çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> AbstractSpan <span class="title function_">createEntrySpan</span><span class="params">(String endpointName, ContextCarrier carrier)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> AbstractSpan <span class="title function_">createLocalSpan</span><span class="params">(String endpointName)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> AbstractSpan <span class="title function_">createExitSpan</span><span class="params">(String endpointName, ContextCarrier carrier, String remotePeer)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¸Šæ–‡ä¸­ <code>@Tracer</code> æ³¨è§£ç”Ÿæˆçš„å°±æ˜¯ LocalSpan</p>
</blockquote>
<h3 id="è·¨åº”ç”¨ä¼ é€’"><a href="#è·¨åº”ç”¨ä¼ é€’" class="headerlink" title="è·¨åº”ç”¨ä¼ é€’"></a>è·¨åº”ç”¨ä¼ é€’</h3><p>APM éœ€è¦å°†ä¸åŒåº”ç”¨é—´çš„ Span ä¸²è”èµ·æ¥, é€šå¸¸æ¥è¯´æ˜¯åœ¨è¯·æ±‚ä¸­åŠ ä¸Š APM ç›¸å…³çš„ä¿¡æ¯æ¥å®ç°çš„.<br>Skywalking çš„å®ç°ç›´æ¥çœ‹å®˜æ–¹æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://skywalking.apache.org/docs/skywalking-java/v8.13.0/en/setup/service-agent/java-agent/java-plugin-development-guide/#contextcarrier">ContextCarrier</a></p>
<h3 id="Span-çš„æ“ä½œ"><a href="#Span-çš„æ“ä½œ" class="headerlink" title="Span çš„æ“ä½œ"></a>Span çš„æ“ä½œ</h3><p>å¯ä»¥é€šè¿‡ <a target="_blank" rel="noopener" href="https://skywalking.apache.org/docs/skywalking-java/v8.13.0/en/setup/service-agent/java-agent/java-plugin-development-guide/#abstractspan">AbstractSpan æ¥å£</a> æ¥æ“ä½œ Span ,å‘å…¶ä¸­æ·»åŠ ä¿¡æ¯. å¯ä»¥é€šè¿‡ <a target="_blank" rel="noopener" href="https://skywalking.apache.org/docs/skywalking-java/v8.13.0/en/setup/service-agent/java-agent/java-plugin-development-guide/#abstractspan">Async Span APIs</a> æ¥æ“æ§å¼‚æ­¥ Span.</p>
<h3 id="ä¸¾ä¸ªä¾‹å­"><a href="#ä¸¾ä¸ªä¾‹å­" class="headerlink" title="ä¸¾ä¸ªä¾‹å­"></a>ä¸¾ä¸ªä¾‹å­</h3><p>SkyWalking-java ä½¿ç”¨ java agent åœ¨è¿è¡Œæ—¶åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç æ¥åšåˆ°åŸ‹ç‚¹çš„æ³¨å…¥. ä¸åŒçš„ä¸­é—´ä»¶éœ€è¦å®ç°ä¸€ä¸ª SkyWalking æ’ä»¶æ‰èƒ½æ¥å…¥. è¿™éƒ¨åˆ†å†…å®¹å¯ä»¥å‚è€ƒ <a href="https://orezzero.github.io/2022/12/08/bytebuddy_agent_skywalking/">Byte Buddy Agent åˆæ¢â€“ä»¥ SkyWalking-java ä¸ºä¾‹</a> ä¸­ SkyWalking-java ç®€è¦åˆ†æ ä¸€èŠ‚.</p>
<p>å®¢æˆ·ç«¯åŸ‹ç‚¹ä»£ç åŒ…å«å¦‚ä¸‹é€»è¾‘:</p>
<ol>
<li>è·å–è¯·æ±‚ä¿¡æ¯</li>
<li>æ„é€  ExitSpan</li>
<li>å‘è¯·æ±‚ä¸­æ³¨å…¥ SkyWalking header</li>
</ol>
<p>æœåŠ¡ç«¯åŒ…å«å¦‚ä¸‹é€»è¾‘:</p>
<ol>
<li>è·å–è¯·æ±‚ä¿¡æ¯</li>
<li>æ„é€  EntrySpan</li>
<li>å‘è¯·æ±‚ä¸­çš„ SkyWalking header æå–å‡ºæ¥, æ³¨å…¥åˆ°æœ¬åœ°çš„ <code>ContextCarrier</code> ä¸­</li>
</ol>
<p>å¯ä»¥å‚è€ƒè¿™ä¸¤ä¸ªæ–‡ä»¶: <a target="_blank" rel="noopener" href="https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-sdk-plugin/sofarpc-plugin/src/main/java/org/apache/skywalking/apm/plugin/sofarpc/SofaRpcConsumerInterceptor.java">SOFA RPC å®¢æˆ·ç«¯åŸ‹ç‚¹</a> å’Œ <a target="_blank" rel="noopener" href="https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-sdk-plugin/sofarpc-plugin/src/main/java/org/apache/skywalking/apm/plugin/sofarpc/SofaRpcProviderInterceptor.java">SOFA RPC æœåŠ¡ç«¯åŸ‹ç‚¹</a></p>
<h1 id="skywalking-java-api-é‡è¦æ¦‚å¿µåŠå¯¹åº”çš„å®ç°"><a href="#skywalking-java-api-é‡è¦æ¦‚å¿µåŠå¯¹åº”çš„å®ç°" class="headerlink" title="skywalking-java api é‡è¦æ¦‚å¿µåŠå¯¹åº”çš„å®ç°"></a>skywalking-java api é‡è¦æ¦‚å¿µåŠå¯¹åº”çš„å®ç°</h1><h2 id="Trace-ç›¸å…³æ¦‚å¿µ"><a href="#Trace-ç›¸å…³æ¦‚å¿µ" class="headerlink" title="Trace ç›¸å…³æ¦‚å¿µ"></a>Trace ç›¸å…³æ¦‚å¿µ</h2><p><a target="_blank" rel="noopener" href="https://skywalking.apache.org/docs/main/v9.2.0/en/protocols/trace-data-protocol-v3/">Trace Data Protocol v3 </a> æè¿°äº†SkyWalking å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´çš„é€šä¿¡åè®®. å…¶ä¸­å°†é“¾è·¯è¿½è¸ªåˆ’åˆ†ä¸ºä¸‰ä¸ªå±‚æ¬¡:</p>
<ol>
<li>Trace: ä»£è¡¨æ•´ä¸ªé“¾è·¯</li>
<li>Segment: ä»£è¡¨ä¸€ä¸ªè¿›ç¨‹(åº”ç”¨)ä¸­æ‰€æœ‰çš„ Span é›†åˆ</li>
<li>Span: ä»£è¡¨ä¸€ä¸ªæ“ä½œ,æ¯”å¦‚è¯»å–ä¸€æ¬¡DB</li>
</ol>
<p>åˆ†åˆ«çœ‹ä¸‹è¿™ä¸‰ä¸ªå¯¹è±¡çš„å”¯ä¸€æ ‡è¯†æ˜¯æ€ä¹ˆäº§ç”Ÿçš„, å°±èƒ½æ¯”è¾ƒå¥½ç†è§£ä»–ä»¬åˆ†åˆ«ä»£è¡¨ä»€ä¹ˆç»´åº¦:</p>
<p><strong>Trace Id</strong> <br/><br>Trace Id é€šè¿‡ <code>GlobalIdGenerator.generate()</code> äº§ç”Ÿ,åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†:</p>
<ol>
<li>PROCESS_ID: ä»£è¡¨åº”ç”¨ç¨‹åºå®ä¾‹ ID</li>
<li><code>Thread.currentThread().getId()</code>: ä»£è¡¨çº¿ç¨‹ ID</li>
<li>THREAD_ID_SEQUENCE: åŒ…å«ä¸¤ä¸ªéƒ¨åˆ† 1) ä»¥æ¯«ç§’è®°çš„æ—¶é—´æˆ³ 2) çº¿ç¨‹çº§åˆ«çš„ 0 åˆ° 9999 çš„åºå·</li>
</ol>
<p>å¯ä»¥çœ‹å‡º, Trace Id æ˜¯ å®ä¾‹ç»´åº¦+çº¿ç¨‹ç»´åº¦+æ¯«ç§’ç»´åº¦+åºå·ç»´åº¦ ç»„æˆçš„.</p>
<p><strong>æ³¨æ„</strong>: Trace Id æ˜¯ä¼šé€šè¿‡è¯·æ±‚ä¼ é€’åˆ°ä¸Šæ¸¸æœåŠ¡çš„,å¦‚æœä¸‹æ¸¸ä¼ é€’äº† Trace Id ç»™ä¸Šæ¸¸, ä¸Šæ¸¸ä¼šç»§ç»­ä½¿ç”¨è¿™ä¸ª Trace Id</p>
<p><strong>Segment Id</strong> <br/><br>Segment Id çš„ç”Ÿæˆç®—æ³•å’Œ Trace Id æ˜¯ä¸€æ ·çš„.</p>
<p><strong>Span Id</strong> <br/><br>SpanId æ˜¯ä¸€ä¸ªåœ¨ <code>TracingContext</code> ä¸­ç»´æŠ¤çš„,ä» 0 å¼€å§‹çš„åºåˆ—.</p>
<p>æ³¨æ„: è¿™é‡Œçš„ <code>TracingContext</code> æ˜¯ä¸€ä¸ª ThreadLocal å˜é‡, ç”Ÿå‘½å‘¨æœŸå’Œä¸€ä¸ª Segment æƒ³é€š.</p>
<h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><p><strong>ä¸€äº›ç±»å’Œæ•°æ®ç»“æ„</strong></p>
<ol>
<li><strong>Span</strong>: ä¿å­˜äº† spanId,parentSpanId,tags ç­‰æ ‡ç­¾, ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªæ“ä½œ.</li>
<li><strong>Segment</strong>: ä¿å­˜äº† traceSegmentId,relatedGlobalTraceId, Span æ•°ç»„ ç­‰ä¿¡æ¯, ç”¨æ¥è¡¨ç¤ºä¸€ç»„åŒçº¿ç¨‹åŒ traceId çš„ Span é›†åˆ</li>
<li><strong>TracingContext</strong>: ç”¨æ¥æ“ä½œ Segment å’Œ Span çš„å·¥å…·ç±»,æŒæœ‰ TraceSegment å¼•ç”¨, ç»´æŠ¤äº†ä¸€ä¸ª <code>List&lt;Span&gt;</code>  è¡¨ç¤ºçš„æ ˆ. TracingContext å’Œå•ä¸ªçº¿ç¨‹å¯¹åº”, å•ä¸ªTracingContextä¸­åªä¿å­˜è¯¥çº¿ç¨‹å¯¹åº”çš„ Segment å’Œ Span.</li>
<li><strong>ContextManager</strong>: TracingContext çš„æ§åˆ¶ç±», æŒæœ‰ TracingContext çš„ ThreadLocal å¼•ç”¨. ContextManager ä¸­çš„é™æ€æ–¹æ³•ä¼š</li>
</ol>
<p>è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•æ¨¡å¼: ç”¨æˆ·ä½¿ç”¨ <code>ContextManager</code> æ¥æ§åˆ¶ <code>TracingContext</code>. <code>TracingContext</code> æ¥ç”Ÿæˆ <code>Segment</code> å’Œ <code>Span</code> å¯¹è±¡, å¹¶å°†ä»–ä»¬ç»„åˆåˆ°ä¸€èµ·.</p>
<!-- todo çœ‹çœ‹è¦ä¸è¦ä¸¾ä¸ªä¾‹å­ -->


<h1 id="è·¨çº¿ç¨‹-Trace-çš„å®ç°"><a href="#è·¨çº¿ç¨‹-Trace-çš„å®ç°" class="headerlink" title="è·¨çº¿ç¨‹ Trace çš„å®ç°"></a>è·¨çº¿ç¨‹ Trace çš„å®ç°</h1><p>è·¨çº¿ç¨‹Trace åˆ†ä¸ºä¸¤ç§æƒ…å†µ:</p>
<ol>
<li>å•ä¸ª Span è·¨çº¿ç¨‹. ä¹Ÿå°±æ˜¯è¯´, åŒä¸€ä¸ªSpan çš„ <code>start</code> å’Œ <code>stop</code> æ“ä½œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­</li>
<li>æ•´ä½“ Trace è·¨çº¿ç¨‹. ä¹Ÿå°±æ˜¯è¯´â€çˆ¶å­Spanâ€åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­.</li>
</ol>
<p>æˆ‘ä»¬åˆ†åˆ«è®¨è®ºè¿™ä¸¤ç§æƒ…å†µ.</p>
<h2 id="å•-Span-è·¨çº¿ç¨‹"><a href="#å•-Span-è·¨çº¿ç¨‹" class="headerlink" title="å• Span è·¨çº¿ç¨‹"></a>å• Span è·¨çº¿ç¨‹</h2><p>å• Span è·¨çº¿ç¨‹æ˜¯æŒ‡åŒä¸€ä¸ªSpan çš„ <code>start</code> å’Œ <code>stop</code> æ“ä½œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­. ç›´æ¥ä¸Šä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AbstractSpan</span> <span class="variable">mySpan</span> <span class="operator">=</span> ContextManager.createEntrySpan(<span class="string">&quot;mySpan&quot;</span>);</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 3. Propagate the span to any other thread.</span></span><br><span class="line">            <span class="comment">// 4. Once the above steps are all set, call #asyncFinish in any thread.</span></span><br><span class="line">            mySpan.asyncFinish();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 1. Call #prepareForAsync in the original context.</span></span><br><span class="line">        mySpan.prepareForAsync();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable).start();</span><br><span class="line">        <span class="comment">// 2. Run ContextManager#stopSpan in the original context when your job in the current thread is complete.</span></span><br><span class="line">        ContextManager.stopSpan();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢è¿™æ®µä»£ç , åœ¨Mainçº¿ç¨‹ä¸­åˆ›å»ºäº†äº†ä¸€ä¸ª Span ,ä½†åœ¨å­çº¿ç¨‹ä¸­æ‰ç»“æŸè¿™ä¸ª Span. æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹:</p>
<h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>æ•´ä¸ªå• Span è·¨çº¿ç¨‹çš„è¿‡ç¨‹åˆ†ä¸ºå››ä¸ªé˜¶æ®µ,æˆ‘ä»¬åˆ†åˆ«åˆ†æ:</p>
<h4 id="åœ¨åŸå§‹ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨-prepareForAsync-æ–¹æ³•"><a href="#åœ¨åŸå§‹ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨-prepareForAsync-æ–¹æ³•" class="headerlink" title="åœ¨åŸå§‹ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ prepareForAsync æ–¹æ³•"></a>åœ¨åŸå§‹ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ prepareForAsync æ–¹æ³•</h4><p><code>prepareForAsync</code> æ–¹æ³•æ˜¯ Span çš„æ–¹æ³•. å®ƒä¼šæ ‡è®°è¿™ä¸ª Span å¤„äºå¼‚æ­¥æ¨¡å¼, åŒæ—¶åœ¨æ–¹æ³•å†…éƒ¨è°ƒç”¨ <code>ContextManager#awaitFinishAsync</code> æ–¹æ³•. ä¸Šä¸‹æ–‡ä¸­ä¼šé€šè¿‡<code>asyncSpanCounter</code>å­—æ®µè®°å½•å½“å‰ä¸Šä¸‹æ–‡æœ‰å¤šå°‘ Span å¤„äºå¼‚æ­¥æ¨¡å¼ä¸­.</p>
<h4 id="åœ¨åŸå§‹æ–¹æ³•ä¸­è°ƒç”¨-stopSpan-æ–¹æ³•"><a href="#åœ¨åŸå§‹æ–¹æ³•ä¸­è°ƒç”¨-stopSpan-æ–¹æ³•" class="headerlink" title="åœ¨åŸå§‹æ–¹æ³•ä¸­è°ƒç”¨ stopSpan æ–¹æ³•"></a>åœ¨åŸå§‹æ–¹æ³•ä¸­è°ƒç”¨ stopSpan æ–¹æ³•</h4><p>ç”±äºä¸Šä¸€æ­¥è°ƒç”¨äº† <code>prepareForAsync</code>, <code>stopSpan</code> æ–¹æ³•ä¸ä¼šç›´æ¥ç»“æŸ,è€Œæ˜¯<strong>å…ˆ</strong>åˆ¤æ–­å½“å‰ä¸Šä¸‹æ–‡ä¸­<strong>asyncSpanCounter</strong>æ˜¯å¦ä¸º0.ä¸º0çš„è¯ç»“æŸ,é0çš„è¯ä¸ç»“æŸ.</p>
<h4 id="å°†-Span-å¯¹è±¡ä¼ é€’åˆ°å…¶ä»–çº¿ç¨‹ä¸­"><a href="#å°†-Span-å¯¹è±¡ä¼ é€’åˆ°å…¶ä»–çº¿ç¨‹ä¸­" class="headerlink" title="å°† Span å¯¹è±¡ä¼ é€’åˆ°å…¶ä»–çº¿ç¨‹ä¸­"></a>å°† Span å¯¹è±¡ä¼ é€’åˆ°å…¶ä»–çº¿ç¨‹ä¸­</h4><p>å¯ä»¥ä½¿ç”¨é—­åŒ…ä¼ é€’,è¿™å¾ˆå¥½ç†è§£,ä¸åšè¯´æ˜äº†.</p>
<h3 id="åœ¨å­çº¿ç¨‹ä¸­å—²ç”¨-asyncFinish"><a href="#åœ¨å­çº¿ç¨‹ä¸­å—²ç”¨-asyncFinish" class="headerlink" title="åœ¨å­çº¿ç¨‹ä¸­å—²ç”¨ asyncFinish"></a>åœ¨å­çº¿ç¨‹ä¸­å—²ç”¨ asyncFinish</h3><p>è°ƒç”¨ asyncFinish ä¼šé€šçŸ¥è¯¥ Span çš„ä¸Šä¸‹æ–‡, å‡å°‘<code>asyncSpanCounter</code>æ•°é‡.å¹¶ä¸”å†æ¬¡å°è¯•ç»“æŸSpan,å¦‚æœæ­¤æ—¶<strong>asyncSpanCounter</strong>ä¸º0,å°±ç»“æŸSpan,å¦åˆ™ä¸ç»“æŸ.</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>åœ¨å•ä¸ª Span è·¨çº¿ç¨‹çš„åœºæ™¯ä¸‹, è·¨çº¿ç¨‹çš„ Span è¿˜æ˜¯åŸæ¥çš„å¯¹è±¡, å®ƒæŒæœ‰åŸæ¥çº¿ç¨‹ <code>Context</code> çš„å¼•ç”¨, traceId ç­‰ç›¸å…³ä¿¡æ¯éƒ½æ²¡æœ‰å‘ç”Ÿæ”¹å˜.</p>
<h2 id="æ•´ä½“-Trace-è·¨çº¿ç¨‹"><a href="#æ•´ä½“-Trace-è·¨çº¿ç¨‹" class="headerlink" title="æ•´ä½“ Trace è·¨çº¿ç¨‹"></a>æ•´ä½“ Trace è·¨çº¿ç¨‹</h2><p>æ•´ä½“ Trace è·¨çº¿ç¨‹æ˜¯è¯´â€çˆ¶å­Spanâ€åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­.æˆ‘ä»¬ç›´æ¥çœ‹ä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AbstractSpan</span> <span class="variable">mySpan</span> <span class="operator">=</span> ContextManager.createExitSpan(<span class="string">&quot;parent&quot;</span>, <span class="string">&quot;childThread&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">RunnableWrapper</span>(runnable)).start();</span><br><span class="line">        ContextManager.stopSpan(mySpan);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RunnableWrapper</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>, EnhancedInstance &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Object skyWalkingDynamicField;</span><br><span class="line">        <span class="keyword">private</span> Runnable runnable;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">RunnableWrapper</span><span class="params">(Runnable runnable)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ContextManager.isActive()) &#123;</span><br><span class="line">                setSkyWalkingDynamicField(ContextManager.capture());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.runnable = runnable;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">AbstractSpan</span> <span class="variable">span</span> <span class="operator">=</span> ContextManager.createLocalSpan(<span class="string">&quot;runnable.run&quot;</span>);</span><br><span class="line">            span.setComponent(ComponentsDefine.JDK_THREADING);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">storedField</span> <span class="operator">=</span> getSkyWalkingDynamicField();</span><br><span class="line">            <span class="keyword">if</span> (storedField != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">ContextSnapshot</span> <span class="variable">contextSnapshot</span> <span class="operator">=</span> (ContextSnapshot) storedField;</span><br><span class="line">                ContextManager.continued(contextSnapshot);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                runnable.run();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                ContextManager.stopSpan();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">getSkyWalkingDynamicField</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> skyWalkingDynamicField;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSkyWalkingDynamicField</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.skyWalkingDynamicField = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç æ˜¯å°†<code>RunnableInstrumentation</code> çš„ä»£ç å¢å¼ºé€»è¾‘å±•å¼€åå¾—æ¥çš„(æœ‰ç®€åŒ–).æ•´ä½“ Trace è·¨çº¿ç¨‹ä¸»æœ‰ä¸¤ä¸ªä¸»è¦æ­¥éª¤:</p>
<ol>
<li>åˆ›å»º RunnableWrapper å¯¹è±¡çš„æ—¶å€™, åœ¨<strong>æ„é€ å‡½æ•°</strong>ä¸­,å°†å½“å‰çº¿ç¨‹çš„ <code>ContextSnapshot</code> è®¾ç½®åˆ° RunnableWrapper çš„ skyWalkingDynamicFieldå¯¹è±¡ä¸­.</li>
<li>åœ¨å­çº¿ç¨‹æ‰§è¡Œ <code>run</code> æ–¹æ³•æ—¶, åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>Span</code>, å¹¶å°†çˆ¶çº¿ç¨‹çš„ <code>contextSnapshot</code> å½“åšå‚æ•°ä¼ é€’ç»™ <code>continued</code> æ–¹æ³•.</li>
</ol>
<p>ContextSnapshot çš„æ„é€ å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ContextSnapshot <span class="title function_">capture</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ContextSnapshot</span> <span class="variable">snapshot</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContextSnapshot</span>(</span><br><span class="line">        segment.getTraceSegmentId(),  <span class="comment">// segmentId</span></span><br><span class="line">        activeSpan().getSpanId(),     <span class="comment">// spanId</span></span><br><span class="line">        getPrimaryTraceId(),          <span class="comment">// traceId</span></span><br><span class="line">        primaryEndpoint.getName(),    <span class="comment">// parentEndpoint</span></span><br><span class="line">        <span class="built_in">this</span>.correlationContext,     </span><br><span class="line">        <span class="built_in">this</span>.extensionContext</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> snapshot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>continued</code> æ–¹æ³•å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Continue the context from the given snapshot of parent thread.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> snapshot from &#123;<span class="doctag">@link</span> #capture()&#125; in the parent thread. Ref to &#123;<span class="doctag">@link</span> AbstractTracerContext#continued(ContextSnapshot)&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">continued</span><span class="params">(ContextSnapshot snapshot)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (snapshot.isValid()) &#123;</span><br><span class="line">        <span class="type">TraceSegmentRef</span> <span class="variable">segmentRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TraceSegmentRef</span>(snapshot);</span><br><span class="line">        <span class="built_in">this</span>.segment.ref(segmentRef);</span><br><span class="line">        <span class="built_in">this</span>.activeSpan().ref(segmentRef);</span><br><span class="line">        <span class="built_in">this</span>.segment.relatedGlobalTrace(snapshot.getTraceId());</span><br><span class="line">        <span class="built_in">this</span>.correlationContext.continued(snapshot);</span><br><span class="line">        <span class="built_in">this</span>.extensionContext.continued(snapshot);</span><br><span class="line">        <span class="built_in">this</span>.extensionContext.handle(<span class="built_in">this</span>.activeSpan());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>continued</code> æ–¹æ³•é€šè¿‡ <code>ContextSnapshot</code> æ„é€  <code>TraceSegmentRef</code>,è®©å½“å‰çº¿ç¨‹çš„ Segment å’Œ Span å¼•ç”¨åˆ° <code>TraceSegmentRef</code>, ä»è€Œå»ºç«‹èµ·äº†ä¸¤ä¸ªçº¿ç¨‹çš„è”ç³». å½“è¿™ä¸¤ä¸ªçº¿ç¨‹çš„ Segment éƒ½å®Œæˆä¹‹å, å°±ä¼šè¢«å‘é€åˆ° SkyWalking æœåŠ¡ç«¯, æœåŠ¡ç«¯å¯ä»¥æ ¹æ®è¿™ä¸¤ä¸ª Segment ä¹‹é—´çš„å…³ç³»å»ºç«‹èµ·è”ç³».</p>
<h1 id="æˆ‘é‡åˆ°çš„é—®é¢˜"><a href="#æˆ‘é‡åˆ°çš„é—®é¢˜" class="headerlink" title="æˆ‘é‡åˆ°çš„é—®é¢˜"></a>æˆ‘é‡åˆ°çš„é—®é¢˜</h1><p>æˆ‘å†åšä¸€ä¸ªç²¾ç»†åŒ–è€—æ—¶åˆ†æçš„ç¨‹åº,å®ƒå¯ä»¥å®ç°è·¨çº¿ç¨‹çš„ç²¾ç»†åŒ–è€—æ—¶åˆ†æ. ä¸¾ä¸ªRPCçš„ä¾‹å­: å®ƒä¼šè®°å½• IO çº¿ç¨‹ä¸­, è¯·æ±‚åˆ°è¾¾çš„æ—¶é—´&#x2F;IO çº¿ç¨‹å¤„ç†å®Œæˆè¯·æ±‚çš„æ—¶é—´; ç„¶åå°†è¿™äº›æ•°æ®ä¼ é€’ç»™ä¸šåŠ¡çº¿ç¨‹, ä¸šåŠ¡çº¿ç¨‹ç»§ç»­è®°å½• RPC å†…éƒ¨å¤„ç†æ—¶é—´, ä¸šåŠ¡è€—æ—¶ç­‰.</p>
<p>ç°åœ¨é‡åˆ°çš„<strong>é—®é¢˜</strong>æ˜¯:  åœ¨å¤šå±‚çº¿ç¨‹æ± åµŒå¥—çš„åœºæ™¯, å¦‚ä½•ç¡®å®šè¿™ä¸ª Trace çš„ç»“æŸæ—¶é—´?</p>
<p>æƒ³è±¡è¿™ä¹ˆä¸€ä¸ªåœºæ™¯:<br>è°ƒç”¨ä¸€ä¸ª RPC æ¥å£, è¿™ä¸ª RPC æ¥å£ä¼šå†å¦å¤–å¼€å¯ 5 æ¡çº¿ç¨‹æ‰§è¡Œæ‰¹é‡æ•°æ®åº“æ“ä½œ,ç„¶åä¸ç­‰å¾…æ•°æ®åº“æ“ä½œè¿”ä¼šç»“æœ, RPC æå‰è¿”ä¼š.</p>
<p>åœ¨è¿™ç§åœºæ™¯ä¸‹,ä¾›æ¶‰åŠä¸ƒæ¡çº¿ç¨‹: IO çº¿ç¨‹, RPC ä¸šåŠ¡çº¿ç¨‹, æ‰¹é‡æ“ä½œ5æ¡çº¿ç¨‹.è¿™ä¸ƒæ¡çº¿ç¨‹åªçŸ¥é“è‡ªå·±çš„ Span çŠ¶æ€, æ— æ³•å¾—çŸ¥å…¶ä»– Span çš„çŠ¶æ€, ä¹Ÿå°±æ²¡åŠæ³•çŸ¥é“æ•´ä¸ªäº‹åŠ¡ä»€ä¹ˆæ—¶å€™ç»“æŸ(æœ¬çº¿ç¨‹äº‹åŠ¡ç»“æŸçš„æ—¶å€™, å¹¶ä¸æ¸…æ¥šå…¶ä»–çº¿ç¨‹çš„äº‹åŠ¡æ˜¯å¦ç»“æŸ).</p>
<p>å¯¹äº SkyWalking, å®ƒæ²¡æœ‰çº ç»“æ•´ä½“äº‹åŠ¡æœ‰æ²¡æœ‰ç»“æŸ. æ¯ä¸ªçº¿ç¨‹åªå…³å¿ƒè‡ªå·±çš„ Segment æ˜¯å¦ç»“æŸ, ç»“æŸå°±ä¸ŠæŠ¥ç»™ SkyWalking æœåŠ¡ç«¯. åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­, è¿™ä¸ƒæ¡çº¿ç¨‹çš„ Segment æ˜¯æœ‰å…³ç³»çš„, skyWalking å¯ä»¥æ ¹æ®è¿™äº›å…³ç³», å†å°†ä»–ä»¬ç»„åˆèµ·æ¥, ç»Ÿä¸€å±•ç¤º.</p>
<h1 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h1><p><a target="_blank" rel="noopener" href="https://opentracing.io/specification/">https://opentracing.io/specification/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/12/15/transmittable-thread-local_analyze/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="åˆ†äº«æˆ‘çš„æ—¥å¸¸æŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/15/transmittable-thread-local_analyze/" class="post-title-link" itemprop="url">Alibaba transmittable-thread-local åˆ†æ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-15 15:11:25" itemprop="dateCreated datePublished" datetime="2022-12-15T15:11:25+00:00">2022-12-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Alibaba-transmittable-thread-local-æ˜¯ä»€ä¹ˆ"><a href="#Alibaba-transmittable-thread-local-æ˜¯ä»€ä¹ˆ" class="headerlink" title="Alibaba transmittable-thread-local æ˜¯ä»€ä¹ˆ"></a>Alibaba transmittable-thread-local æ˜¯ä»€ä¹ˆ</h1><p><code>TransmittableThreadLocal(TTL)</code>ï¼šåœ¨ä½¿ç”¨çº¿ç¨‹æ± ç­‰ä¼šæ± åŒ–å¤ç”¨çº¿ç¨‹çš„æ‰§è¡Œç»„ä»¶æƒ…å†µä¸‹ï¼Œæä¾›ThreadLocalå€¼çš„ä¼ é€’åŠŸèƒ½ï¼Œè§£å†³å¼‚æ­¥æ‰§è¡Œæ—¶ä¸Šä¸‹æ–‡ä¼ é€’çš„é—®é¢˜ã€‚</p>
<h1 id="ç›¸å…³æ–‡ç« "><a href="#ç›¸å…³æ–‡ç« " class="headerlink" title="ç›¸å…³æ–‡ç« "></a>ç›¸å…³æ–‡ç« </h1><p>ç½‘ä¸Šæœ‰å¾ˆå¤š TTL çš„åŸç†åˆ†æ&#x2F;å®è·µ. TTL ä½œè€…åœ¨ <a target="_blank" rel="noopener" href="https://github.com/alibaba/transmittable-thread-local/issues/123">è¿™é‡Œ</a> åšäº†ä¸€ä¸ªæ±‡æ€». æˆ‘è¿™ç¯‡æ–‡ç« å°±ä¸æ·±å…¥ç»†èŠ‚å±•å¼€äº†, åªå†™ä¸€ç‚¹æˆ‘è‡ªå·±å¯¹ TTL ç¬¼ç»Ÿçš„ç†è§£.</p>
<h1 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h1><h2 id="InheritableThreadLocal-åŸç†"><a href="#InheritableThreadLocal-åŸç†" class="headerlink" title="InheritableThreadLocal åŸç†"></a>InheritableThreadLocal åŸç†</h2><p>åœ¨åˆ›å»º <code>Thread</code> å¯¹è±¡æ—¶ ,ä¼šå¤åˆ¶å¤çˆ¶çº¿ç¨‹çš„ <code>InheritableThreadLocal</code> åˆ°æ–°çš„ <code>Thread</code> å¯¹è±¡, é€šè¿‡è¿™ç§æ–¹å¼çˆ¶çº¿ç¨‹çš„ <code>ThreadLocal</code> ä¼ é€’ç»™å­çº¿ç¨‹. è¿™ç§æ–¹å¼æœ‰å¦‚ä¸‹é—®é¢˜:</p>
<ul>
<li>çº¿ç¨‹æ± åœºæ™¯ä¸‹,æ— æ³•åšåˆ° ThreadLocal çš„ä¼ é€’</li>
<li>ä¼ é€’çš„å‚æ•°æ˜¯é€šç”¨å¼•ç”¨ä¼ é€’, æ— æ³•åšåˆ°å€¼ä¼ é€’.</li>
</ul>
<h2 id="TransmittableThreadLocal-åŸç†"><a href="#TransmittableThreadLocal-åŸç†" class="headerlink" title="TransmittableThreadLocal åŸç†"></a>TransmittableThreadLocal åŸç†</h2><p><code>TransmittableThreadLocal</code> æ˜¯åœ¨åˆ›å»º <code>Runnable</code> çš„æ—¶å€™åšçš„ <code>ThreadLocal</code> ä¼ é€’:</p>
<ol>
<li>åœ¨åˆ›å»º <code>Runnable</code> çš„æ—¶å€™, å°† <code>TransmittableThreadLocal</code> å­˜å‚¨åˆ°ä¸€ä¸ªå¯¹è±¡å±æ€§ä¸­,æ­¤æ—¶æ‰€æœ‰é€»è¾‘åœ¨çˆ¶çº¿ç¨‹ä¸­æ‰§è¡Œ.</li>
<li>åœ¨æ‰§è¡Œ <code>Runnable.run</code> æ—¶, å°†ä¸Šæ–‡å¯¹è±¡ä¸­çš„ <code>TransmittableThreadLocal</code> å–å‡º, å†æ”¾åˆ° <code>ThreadLocal</code> åº”è¯¥åœ¨çš„åœ°æ–¹, è¿™ä¸ªæ­¥éª¤çš„é€»è¾‘åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œ.</li>
</ol>
<p>å¦å¤–<code>TransmittableThreadLocal</code> è¿˜ç•™æœ‰ <code>TtlCopier</code> æ¥å£, å¯ä»¥è‡ªå®šä¹‰å®ç°å€¼ä¼ é€’.</p>
<p>ç®€å•è®²è®² TTL å°±è¿™ä¹ˆä¸€å›äº‹,å½“ç„¶å…¶ä¸­è¿˜æœ‰å¾ˆå¤šç»†èŠ‚éœ€è¦æ³¨æ„, æœ‰éœ€è¦çš„åŒå­¦å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£åŠå®˜æ–¹æ–‡æ¡£æ±‡æ€»åšè¿›ä¸€æ­¥äº†è§£.</p>
<h1 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h1><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/transmittable-thread-local">transmittable-thread-local repo</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/12/08/bytebuddy_agent_skywalking/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="åˆ†äº«æˆ‘çš„æ—¥å¸¸æŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/08/bytebuddy_agent_skywalking/" class="post-title-link" itemprop="url">Byte Buddy Agent åˆæ¢--ä»¥ SkyWalking-java ä¸ºä¾‹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-08 12:08:24" itemprop="dateCreated datePublished" datetime="2022-12-08T12:08:24+00:00">2022-12-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/javaagent/" itemprop="url" rel="index"><span itemprop="name">javaagent</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>byte-buddy-agent æ˜¯ ByteBuddy çš„ä¸€ä¸ªç»„ä»¶, ç”¨äºå¿«é€Ÿæ„å»ºå‡ºä¸€ä¸ª JavaAgent. SkyWalking-java æ˜¯ä¸€ä¸ª SkyWalking ä¸º Java å‡†å¤‡çš„è¿è¡Œæ—¶ä»£ç ç”Ÿæˆå™¨, é€‚é…äº†ä¼—å¤šä¸­é—´ä»¶ä»¥æä¾›å®šåˆ¶çš„ç›‘æ§èƒ½åŠ›.</p>
<p>SkyWalking-java æœ¬è´¨æ˜¯ä¸€ä¸ª java agent ,å¹¶åœ¨å…¶ä¸­ä½¿ç”¨äº† byte-buddy-agent.</p>
<p>æœ¬æ–‡ä¼šä»‹ç» SkyWalking-agent å¦‚ä½•ä½¿ç”¨ byte-buddy-agent æ¥åšåˆ°ä»£ç å¢å¼ºçš„.</p>
<h1 id="ByteBuddy-åŸºç¡€ç”¨æ³•"><a href="#ByteBuddy-åŸºç¡€ç”¨æ³•" class="headerlink" title="ByteBuddy åŸºç¡€ç”¨æ³•"></a>ByteBuddy åŸºç¡€ç”¨æ³•</h1><p>åœ¨æ·±å…¥ SkyWalking-agent å’Œ byte-buddy-agent ä¹‹å‰, æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ ByteBuddy æ˜¯å¦‚ä½•åœ¨è°ƒç”¨ä¸€ä¸ªæ–¹æ³•å‰åæ’å…¥æ—¥å¿—çš„.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MemoryDatabase</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">load</span><span class="params">(String info)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Arrays.asList(info + <span class="string">&quot;: foo&quot;</span>, info + <span class="string">&quot;: bar&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoggerInterceptor</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title function_">log</span><span class="params">(<span class="meta">@SuperCall</span> Callable&lt;List&lt;String&gt;&gt; zuper)</span> <span class="comment">// SuperCall æ³¨è§£ç”¨äºè¡¨ç¤º zuper æ˜¯åŸå§‹æ–¹æ³•çš„è°ƒç”¨.</span></span><br><span class="line">      <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Calling database&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> zuper.call();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;Returned from database&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">MemoryDatabase</span> <span class="variable">loggingDatabase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteBuddy</span>()</span><br><span class="line">  .subclass(MemoryDatabase.class) <span class="comment">// è¢«å¢å¼ºçš„ç±»ç»§æ‰¿äº MemoryDatabase ç±»</span></span><br><span class="line">  .method(named(<span class="string">&quot;load&quot;</span>)) <span class="comment">// è¢«å¢å¼ºçš„æ–¹æ³•åä¸º load</span></span><br><span class="line">  .intercept(MethodDelegation.to(LoggerInterceptor.class)) <span class="comment">// å¢å¼ºæ–¹å¼æ˜¯å°†æ–¹æ³•è°ƒç”¨ä»£ç†åˆ° LoggerInterceptor</span></span><br><span class="line">  .make() <span class="comment">// æ„é€ å‡ºä¸Šè¿°é…ç½®äº§ç”Ÿçš„ç±»çš„å­—èŠ‚ç </span></span><br><span class="line">  .load(getClass().getClassLoader()) <span class="comment">// å°†ä¸Šè¿°é…ç½®äº§ç”Ÿçš„ç±»ç”¨è¿‡ getClass().getClassLoader() åŠ è½½åˆ° jvm ä¸­</span></span><br><span class="line">  .getLoaded() <span class="comment">// è·å–å·²ç»åŠ è½½çš„ Class ç±»å¯¹è±¡</span></span><br><span class="line">  .newInstance(); <span class="comment">// é€šè¿‡é»˜è®¤æ„é€ å‡½æ•°æ„é€ æ–°çš„å¯¹è±¡.</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ˜¯ä¸€ä¸ªç®€å•çš„ ByteBuddy ä¾‹å­. å®ƒå¢å¼ºäº† MemoryDatabase ç±», ä¼šåœ¨è°ƒç”¨ MemoryDatabase.load å‰å,æ‰“å°è¾“å‡ºä¸€äº›ä¿¡æ¯.<br>ByteBuddy API æ¯è¡Œä»£ç çš„å«ä¹‰éƒ½å·²ç»å†™åœ¨æ³¨é‡Šä¸­äº†. å¯ä»¥æƒ³è±¡, åœ¨SkyWalking agent ä¸­, ä¹Ÿæ˜¯æ„é€ äº†ç±»ä¼¼çš„ä»£ç å¢å¼º, åœ¨è°ƒç”¨å‰ååŠ å…¥äº† SkyWalking åŸ‹ç‚¹.</p>
<h1 id="SkyWalking-java-ç®€è¦åˆ†æ"><a href="#SkyWalking-java-ç®€è¦åˆ†æ" class="headerlink" title="SkyWalking-java ç®€è¦åˆ†æ"></a>SkyWalking-java ç®€è¦åˆ†æ</h1><p>æˆ‘ä»¬ä¼šå…ˆåˆ†æä¸­é—´ä»¶å¦‚ä½•æ¥å…¥ SkyWalking-java , ç„¶ååˆ†æ SkyWalking-java å¦‚ä½•æ¥å…¥ byte-buddy-agent.</p>
<h2 id="æ’ä»¶å®šä¹‰"><a href="#æ’ä»¶å®šä¹‰" class="headerlink" title="æ’ä»¶å®šä¹‰"></a>æ’ä»¶å®šä¹‰</h2><p>SkyWalking-java æä¾›äº†ä¸€ç§æ¯”è¾ƒç®€å•çš„ API ,æ¥ä¾›ä¸­é—´ä»¶æ¥å…¥. æˆ‘ä»¬ä»¥ SOFA RPC ä¸ºä¾‹å­çœ‹ä¸‹.</p>
<p>ä¸€ä¸ªåŸ‹ç‚¹çš„æ¥å…¥ä»£ç åªæœ‰ä¸¤ä¸ªç±»,ä»¥åŠä¸€ä¸ªé…ç½®æ–‡ä»¶,ç›´æ¥ä¸Šä»£ç :</p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-sdk-plugin/sofarpc-plugin/src/main/java/org/apache/skywalking/apm/plugin/sofarpc/SofaRpcConsumerInstrumentation.java">SofaRpcConsumerInstrumentation.java:</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SofaRpcConsumerInstrumentation</span> <span class="keyword">extends</span> <span class="title class_">ClassInstanceMethodsEnhancePluginDefine</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ENHANCE_CLASS</span> <span class="operator">=</span> <span class="string">&quot;com.alipay.sofa.rpc.filter.ConsumerInvoker&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">INTERCEPT_CLASS</span> <span class="operator">=</span> <span class="string">&quot;org.apache.skywalking.apm.plugin.sofarpc.SofaRpcConsumerInterceptor&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ClassMatch <span class="title function_">enhanceClass</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> NameMatch.byName(ENHANCE_CLASS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ConstructorInterceptPoint[] getConstructorsInterceptPoints() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> InstanceMethodsInterceptPoint[] getInstanceMethodsInterceptPoints() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InstanceMethodsInterceptPoint</span>[] &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InstanceMethodsInterceptPoint</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> ElementMatcher&lt;MethodDescription&gt; <span class="title function_">getMethodsMatcher</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> named(<span class="string">&quot;invoke&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> String <span class="title function_">getMethodsInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> INTERCEPT_CLASS;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isOverrideArgs</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SofaRpcConsumerInstrumentation ç»§æ‰¿äº† ClassInstanceMethodsEnhancePluginDefine ,å®šä¹‰äº† SOFA RPC æ’ä»¶å¦‚ä½•å·¥ä½œ,å®ƒé€šè¿‡æ¥å£æŒ‡å®šäº†ä¸‰ä¸ªå±æ€§:</p>
<ol>
<li>enhanceClass: éœ€è¦å¢å¼ºå“ªä¸ªç±», è¿™é‡Œæ˜¯å¢å¼º <code>com.alipay.sofa.rpc.filter.ConsumerInvoker</code></li>
<li>getConstructorsInterceptPoints: æŒ‡å®šæ„é€ å‡½æ•°å¦‚ä½•å¢å¼º: è¿™ä¸ªæ’ä»¶ä¸éœ€è¦æ„é€ å‡½æ•°å¢å¼º</li>
<li>getInstanceMethodsInterceptPoints: æŒ‡å®šæ–¹æ³•å¦‚ä½•å¢å¼º, è¿™é‡Œè¿”å›äº†ä¸€ä¸ª <code>InstanceMethodsInterceptPoint</code> æ•°ç»„, æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€ä¸ªå¢å¼ºç‚¹</li>
</ol>
<p>æ¥ç€æˆ‘ä»¬çœ‹ä¸‹ <code>InstanceMethodsInterceptPoint</code> æ˜¯æ€ä¹ˆå®šä¹‰çš„:</p>
<ul>
<li>getMethodsMatcher: æŒ‡å®šäº†å¦‚ä½•æ‰¾åˆ°éœ€è¦å¢å¼ºçš„æ–¹æ³•, è¿™é‡ŒæŒ‡å®šçš„æ˜¯åä¸º <code>invoke</code> çš„æ–¹æ³•</li>
<li>getMethodsInterceptor: æŒ‡å®šå¦‚ä½•å¢å¼ºåˆšåˆšæŒ‡å®šçš„<code>invoke</code>æ–¹æ³•, è¿™é‡ŒæŒ‡å®šçš„æ˜¯ <code>org.apache.skywalking.apm.plugin.sofarpc.SofaRpcConsumerInterceptor</code>ç±», è¿™ä¸ªç±»ä¸‹æ–‡ä¼šåˆ†æ.</li>
<li>isOverrideArgs: è¿™ä¸ªå±æ€§æŒ‡å®šäº†æ˜¯å¦éœ€è¦ä¿®æ”¹ä¿®æ”¹ <code>invoke</code> çš„å…¥å‚,è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬ä¸éœ€è¦ä¿®æ”¹,æ‰€ä»¥è¿”å› <code>false</code></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-sdk-plugin/sofarpc-plugin/src/main/java/org/apache/skywalking/apm/plugin/sofarpc/SofaRpcConsumerInterceptor.java">SofaRpcConsumerInterceptor.java:</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SofaRpcConsumerInterceptor</span> <span class="keyword">implements</span> <span class="title class_">InstanceMethodsAroundInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SKYWALKING_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;skywalking.&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeMethod</span><span class="params">(EnhancedInstance objInst, Method method, Object[] allArguments, Class&lt;?&gt;[] argumentsTypes,</span></span><br><span class="line"><span class="params">                             MethodInterceptResult result)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// çœç•¥ä¸€äº›ä»£ç </span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ContextCarrier</span> <span class="variable">contextCarrier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContextCarrier</span>();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">operationName</span> <span class="operator">=</span> generateOperationName(providerInfo, sofaRequest);</span><br><span class="line">        <span class="type">AbstractSpan</span> <span class="variable">span</span> <span class="operator">=</span> ContextManager.createExitSpan(operationName, contextCarrier, host + <span class="string">&quot;:&quot;</span> + port);</span><br><span class="line">        span.setComponent(ComponentsDefine.SOFARPC);</span><br><span class="line">        SpanLayer.asRPCFramework(span);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">afterMethod</span><span class="params">(EnhancedInstance objInst, Method method, Object[] allArguments, Class&lt;?&gt;[] argumentsTypes,</span></span><br><span class="line"><span class="params">                              Object ret)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">SofaResponse</span> <span class="variable">result</span> <span class="operator">=</span> (SofaResponse) ret;</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">null</span> &amp;&amp; result.isError()) &#123;</span><br><span class="line">            dealException((Throwable) result.getAppResponse());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ContextManager.stopSpan();</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMethodException</span><span class="params">(EnhancedInstance objInst, Method method, Object[] allArguments,</span></span><br><span class="line"><span class="params">                                      Class&lt;?&gt;[] argumentsTypes, Throwable t)</span> &#123;</span><br><span class="line">        dealException(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SofaRpcConsumerInterceptor</code> ä¼šé‡è½½ä¸‰ä¸ªæ–¹æ³•, åˆ†åˆ«åœ¨ <code>com.alipay.sofa.rpc.filter.ConsumerInvoker#invoke()</code> è°ƒç”¨ä¹‹å‰,ä¹‹å,ä»¥åŠå‘ç”Ÿå¼‚å¸¸æ—¶è¢«å›è°ƒ.</p>
<p>é…ç½®æ–‡ä»¶ä¸º:<br><a target="_blank" rel="noopener" href="https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-sdk-plugin/sofarpc-plugin/src/main/resources/skywalking-plugin.def">skywalking-plugin.def</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sofarpc=org.apache.skywalking.apm.plugin.sofarpc.SofaRpcConsumerInstrumentation</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé¢é…ç½®äº† <code>SofaRpcConsumerInstrumentation</code> ç±».</p>
<h2 id="é€‚é…-ByteBuddy"><a href="#é€‚é…-ByteBuddy" class="headerlink" title="é€‚é… ByteBuddy"></a>é€‚é… ByteBuddy</h2><p>é€šè¿‡ä¸Šæ–‡çš„é…æ–‡ä»¶,SkyWalking-java å¯ä»¥è·å–åˆ°æ‰€æœ‰çš„ PluginDefine ç±». SkyWalking-java ä¼šåŠ è½½è¿™äº›ç±», å¹¶å°†ä»–ä»¬ç»Ÿä¸€äº¤ç»™ <code>PluginFinder</code> ç®¡ç†.</p>
<p><code>PluginFinder</code> çš„ <code>buildMatch()</code> æ–¹æ³•ç”Ÿæˆä¸€ä¸ª ElementMatcher æ¥åŒ¹é…åˆ°æ‰€æœ‰éœ€è¦è¢«åŠ è½½çš„ç±»å‹. ä»¥ SOFA RPC ä¸ºä¾‹å°±æ˜¯ <code>com.alipay.sofa.rpc.filter.ConsumerInvoker</code> ç±».</p>
<p><code>PluginFinder</code> ä¼šè¢«ä¼ é€’ç»™ <code>org.apache.skywalking.apm.agent.SkyWalkingAgent.Transformer</code> æ¥æ„é€ ä¸€ä¸ª <code>AgentBuilder.Transformer</code>. å¯ä»¥è¢«ä¸Šé¢ ElementMatcher åŒ¹é…çš„ç±»,éƒ½ä¼šè¢« Transformer å¢å¼º.</p>
<p>å¢å¼ºé€»è¾‘å¦‚ä¸‹:</p>
<ul>
<li>å¤„ç†æ¯ä¸ªåŒ¹é… ElementMatcher çš„ç±»</li>
<li>é€šè¿‡ <code>PluginFinder</code> æ‰¾åˆ°è¿™ä¸ªç±»å¯¹åº”çš„ <code>PluginDefine</code></li>
<li>è°ƒç”¨ <code>PluginDefine</code> çš„ <code>define</code> æ–¹æ³•å¯¹æ–¹æ³•è¿›è¡Œå¢å¼º:<ul>
<li>è·å– <code>PluginDefine</code> å®šä¹‰çš„ <code>InstanceMethodsInterceptPoints</code></li>
<li>éå† <code>InstanceMethodsInterceptPoints</code>, é€šè¿‡ <code>MethodsMatcher</code> ç¡®å®šéœ€è¦å¢å¼ºçš„æ–¹æ³•, é€šè¿‡ <code>getMethodsInterceptor</code> è·å–å¦‚ä½•å¢å¼ºæ–¹æ³•. å¹¶å°† Interceptor æ³¨å…¥åˆ° <code>InstMethodsInter</code> ä¸­.</li>
<li>å°† <code>MethodsMatcher</code> å’Œ <code>InstMethodsInter</code> ä¼ é€’ç»™ ByteBuddy å°±å®Œæˆäº† JavaAgent çš„é…ç½®.</li>
</ul>
</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹ <code>InstMethodsInter</code> æ˜¯ä»€ä¹ˆ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InstMethodsInter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ILog</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LogManager.getLogger(InstMethodsInter.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * An &#123;<span class="doctag">@link</span> InstanceMethodsAroundInterceptor&#125; This name should only stay in &#123;<span class="doctag">@link</span> String&#125;, the real &#123;<span class="doctag">@link</span> Class&#125;</span></span><br><span class="line"><span class="comment">     * type will trigger classloader failure. If you want to know more, please check on books about Classloader or</span></span><br><span class="line"><span class="comment">     * Classloader appointment mechanism.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> InstanceMethodsAroundInterceptor interceptor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> instanceMethodsAroundInterceptorClassName class full name.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InstMethodsInter</span><span class="params">(String instanceMethodsAroundInterceptorClassName, ClassLoader classLoader)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            interceptor = InterceptorInstanceLoader.load(instanceMethodsAroundInterceptorClassName, classLoader);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PluginException</span>(<span class="string">&quot;Can&#x27;t create InstanceMethodsAroundInterceptor.&quot;</span>, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Intercept the target instance method.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj          target class instance.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> allArguments all method arguments</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> method       method description.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> zuper        the origin call ref.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the return value of target instance method.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception only throw exception because of zuper.call() or unexpected exception in sky-walking ( This is a</span></span><br><span class="line"><span class="comment">     *                   bug, if anything triggers this condition ).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RuntimeType</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(<span class="meta">@This</span> Object obj, <span class="meta">@AllArguments</span> Object[] allArguments, <span class="meta">@SuperCall</span> Callable&lt;?&gt; zuper,</span></span><br><span class="line"><span class="params">        <span class="meta">@Origin</span> Method method)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">EnhancedInstance</span> <span class="variable">targetObject</span> <span class="operator">=</span> (EnhancedInstance) obj;</span><br><span class="line"></span><br><span class="line">        <span class="type">MethodInterceptResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodInterceptResult</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            interceptor.beforeMethod(targetObject, method, allArguments, method.getParameterTypes(), result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            LOGGER.error(t, <span class="string">&quot;class[&#123;&#125;] before method[&#123;&#125;] intercept failure&quot;</span>, obj.getClass(), method.getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!result.isContinue()) &#123;</span><br><span class="line">                ret = result._ret();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ret = zuper.call();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                interceptor.handleMethodException(targetObject, method, allArguments, method.getParameterTypes(), t);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t2) &#123;</span><br><span class="line">                LOGGER.error(t2, <span class="string">&quot;class[&#123;&#125;] handle method[&#123;&#125;] exception failure&quot;</span>, obj.getClass(), method.getName());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> t;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ret = interceptor.afterMethod(targetObject, method, allArguments, method.getParameterTypes(), ret);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                LOGGER.error(t, <span class="string">&quot;class[&#123;&#125;] after method[&#123;&#125;] intercept failure&quot;</span>, obj.getClass(), method.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><code>InstMethodsInter</code> ä¸ä¸Šæ–‡ <em>ByteBuddy åŸºç¡€ç”¨æ³•</em> ä¸­çš„ <code>LoggerInterceptor</code> æ˜¯åŒä¸€ç±»å‹çš„ä¸œè¥¿, ByteBuddy ä¼šå°†éœ€è¦å¢å¼ºçš„ç±»ä»£ç†ç»™ <code>intercept</code> æ–¹æ³•. å¯ä»¥çœ‹ <code>intercept</code> æ–¹æ³•çš„å‚æ•°ä¸Šéƒ½å¸¦ä¸Šäº† <code>ByteBuddy</code> çš„æ³¨è§£:</p>
<ul>
<li><strong>This</strong>: ä»£è¡¨å½“å‰ä»£ç†ç±»çš„å®ä¾‹</li>
<li><strong>AllArguments</strong>: åŸå§‹è°ƒç”¨çš„å‚æ•°åˆ—è¡¨</li>
<li><strong>SuperCall</strong>: ä»£è¡¨åŸå§‹è°ƒç”¨</li>
<li><strong>Origin</strong>: ä»£è¡¨åŸå§‹æ–¹æ³•</li>
</ul>
<p>é€šè¿‡ <code>InstMethodsInter</code> , SkyWalking-java åœ¨éœ€è¦å¢å¼ºçš„æ–¹æ³•å‰ååŠå¼‚å¸¸å¤„ç†é˜¶æ®µå¢åŠ äº†ä¸€äº›å›è°ƒ, å›è°ƒç»™ <code>PluginDefine</code> ä¸­å®šä¹‰çš„ <code>Interceptor</code>.</p>
<h1 id="ByteBuddy-Agent-åŸç†ç®€ä»‹"><a href="#ByteBuddy-Agent-åŸç†ç®€ä»‹" class="headerlink" title="ByteBuddy Agent  åŸç†ç®€ä»‹"></a>ByteBuddy Agent  åŸç†ç®€ä»‹</h1><p>åœ¨å¼€å§‹ç¤¾ä»‹ç» ByteBuddy åŸç†ä¹‹å‰, å¯ä»¥å…ˆçœ‹ä¸‹ <a href="/2022/11/24/javaagent_introduction/">Java Agent åŸç†ç®€ä»‹</a> æ¥å›é¡¾ä¸‹åŸç”Ÿ javaagent æ˜¯æ€ä¹ˆå·¥ä½œçš„:</p>
<p>æˆ‘ä»¬å‘ <code>Instrumentation</code> æ³¨å†Œä¸€äº› <code>Transformer</code>,åœ¨ç±»åŠ è½½æœŸé—´ <code>Transformer</code> çš„ <code>transform</code> æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨. <code>transform</code> æ–¹æ³•ä¼šä¿®æ”¹ç±»çš„äºŒè¿›åˆ¶è¡¨ç¤º(å­—èŠ‚ç ), ä»è€Œå®ç°ç±»å¢å¼º.</p>
<p>é‚£ä¹ˆ ByteBuddy æ˜¯å¦‚ä½•é€‚é…åŸç”Ÿ javaagent è¿™ç§æ¨¡å¼çš„å‘¢?</p>
<p>ByteBuddy å†…éƒ¨æœ‰ä¸€ä¸ªé€‚é…å™¨ <code>net.bytebuddy.agent.builder.AgentBuilder.Default.ExecutingTransformer</code> å°†åŸç”Ÿ transform æ–¹æ³•é€‚é…åˆ° <code>net.bytebuddy.agent.builder.AgentBuilder.Transformer</code> çš„æ–¹æ³•ä¸Š. ç„¶åé€šè¿‡ <code>net.bytebuddy.dynamic.DynamicType.Builder</code> æ„é€ æ–°çš„ç±»çš„å­—èŠ‚ç , è¿”å›ç»™ <code>Instrumentation</code>.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/12/06/byte_buddy_simple_example_intro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="åˆ†äº«æˆ‘çš„æ—¥å¸¸æŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/06/byte_buddy_simple_example_intro/" class="post-title-link" itemprop="url">ä¸€ä¸ªç®€å•çš„ Byte Buddy ä¾‹å­åŠåŸç†ç®€è¿°</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-06 17:08:06" itemprop="dateCreated datePublished" datetime="2022-12-06T17:08:06+00:00">2022-12-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/javaagent/" itemprop="url" rel="index"><span itemprop="name">javaagent</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h1><h2 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h2><p>æˆ‘ä»¬æœ‰ä¸€ä¸ªç±» EchoA, å®ƒæœ‰ä¸€ä¸ªæ–¹æ³• <code>echo</code> è¿”å›å€¼æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸² <code>&quot;A&quot;</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EchoA</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">echo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;A&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æƒ³è¦é€šè¿‡ ByteBuddy æ¥åŠ¨æ€ç”Ÿæˆä¸€ä¸ªç±», å®ƒçš„ echo æ–¹æ³•è¿”å›å­—ç¬¦ä¸² <code>&quot;B&quot;</code>.</p>
<h2 id="ByteBuddy-å®ç°"><a href="#ByteBuddy-å®ç°" class="headerlink" title="ByteBuddy å®ç°"></a>ByteBuddy å®ç°</h2><p>æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆå†™:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ ByteBuddy å¼€å§‹æ„é€ ä¸€ä¸ªç±»</span></span><br><span class="line">    DynamicType.Unloaded&lt;EchoA&gt; newClass = <span class="keyword">new</span> <span class="title class_">ByteBuddy</span>()</span><br><span class="line">            .subclass(EchoA.class) <span class="comment">// æ–°çš„ç±»ç»§æ‰¿äº EchoA</span></span><br><span class="line">            .method(ElementMatchers.named(<span class="string">&quot;echo&quot;</span>)) <span class="comment">// å¯¹æ–¹æ³• echo åšå¢å¼º</span></span><br><span class="line">            .intercept(FixedValue.value(<span class="string">&quot;B&quot;</span>)) <span class="comment">// å¢å¼ºå†…å®¹æ˜¯è¿”å›ä¸€ä¸ªå›ºå®šå€¼ &quot;B&quot;</span></span><br><span class="line">            .make(); <span class="comment">// æ„é€ è¿™ä¸ª class</span></span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; dynamicType = newClass</span><br><span class="line">            .load(EchoA.class.getClassLoader()) <span class="comment">// ä½¿ç”¨ EchoA çš„ç±»åŠ è½½å™¨åŠ è½½è¿™ä¸ªç±»</span></span><br><span class="line">            .getLoaded(); <span class="comment">// è·å–è¢«åŠ è½½çš„ç±»</span></span><br><span class="line">    <span class="type">EchoA</span> <span class="variable">echoA</span> <span class="operator">=</span> (EchoA) dynamicType.getDeclaredConstructor().newInstance(); <span class="comment">// ä½¿ç”¨åå°„è°ƒç”¨æ„é€ å‡½æ•°, æ„é€ æ–°çš„ç±»çš„å®ä¾‹</span></span><br><span class="line">    System.out.println(echoA.getClass().getName()); <span class="comment">// æ‰“å°æ–°ç±»ç±»å</span></span><br><span class="line">    System.out.println(echoA.echo()); <span class="comment">// è°ƒç”¨ echo æ–¹æ³•å¹¶æ‰“å°ç»“æœ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢è¿™ä¸ª main æ–¹æ³•åŠ¨æ€ç”Ÿæˆäº†ä¸€ä¸ªç±», å¹¶è°ƒç”¨è¿™ä¸ªç±»çš„ <code>echo</code> æ–¹æ³•,è¿”å›äº†å­—ç¬¦ä¸² <code>&quot;B&quot;</code>.</p>
<h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><h2 id="å­—èŠ‚ç è§†è§’-æ”¹å˜äº†ä»€ä¹ˆ"><a href="#å­—èŠ‚ç è§†è§’-æ”¹å˜äº†ä»€ä¹ˆ" class="headerlink" title="å­—èŠ‚ç è§†è§’: æ”¹å˜äº†ä»€ä¹ˆ"></a>å­—èŠ‚ç è§†è§’: æ”¹å˜äº†ä»€ä¹ˆ</h2><p>ByteBuddy å¯ä»¥ç”Ÿæˆå­—èŠ‚ç ,ä½†æ˜¯ä¸ä¼šç”Ÿæˆ Java æºç ,æˆ‘ä»¬å°±ä»å­—èŠ‚ç å±‚é¢çœ‹çœ‹, ByteBuddy åšäº†ä»€ä¹ˆ.</p>
<p>å…ˆçœ‹ä¸‹åŸå§‹çš„ EchoA å­—èŠ‚ç (éƒ¨åˆ†):<br><img src="/images/ByteBuddy1.jpg" alt="EchoA"></p>
<p>echo æ–¹æ³•çš„å­—èŠ‚ç å¦‚ä¸‹:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0 ldc #8 &lt;B&gt;</span><br><span class="line">2 areturn</span><br></pre></td></tr></table></figure>
<p><strong>ldc</strong> æŒ‡ä»¤ä¼šå°†å¸¸é‡æ± ä¸­çš„å¸¸é‡å…¥æ ˆ, è¿™é‡Œæ˜¯å°†å¸¸é‡æ± ç¬¬å…«ä¸ªå¸¸é‡(ä¹Ÿå°±æ˜¯<code>&quot;A&quot;</code>) å…¥æ ˆ. <strong>areturn</strong> æŒ‡ä»¤å°†æ ˆä¸­æ•°æ®ä½œä¸ºè¿”å›å€¼è¿”å›.</p>
<p>ç”Ÿæˆçš„æ–°ç±», ä¹Ÿæ˜¯ç±»ä¼¼çš„é€»è¾‘:<br><img src="/images/ByteBuddy2.jpg" alt="EchoB"></p>
<h2 id="æºç è§†è§’-æ€ä¹ˆå®ç°çš„"><a href="#æºç è§†è§’-æ€ä¹ˆå®ç°çš„" class="headerlink" title="æºç è§†è§’: æ€ä¹ˆå®ç°çš„"></a>æºç è§†è§’: æ€ä¹ˆå®ç°çš„</h2><p>ByteBuddy æ˜¯ä¸€ä¸ªå¯¹ ASM å­—èŠ‚ç æ¡†æ¶çš„å°è£…. ByteBuddy å¯¹å­—èŠ‚ç æ“ä½œåšäº†å¤šä¸ªå±‚æ¬¡çš„å°è£…, ç”¨æˆ·å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨å®ƒ, ä½†è¦ç†è§£å®ƒçš„è¿è¡ŒåŸç†, æœ‰æ¯”è¾ƒé™¡å³­çš„å­¦ä¹ æ›²çº¿. ä¸‹é¢æˆ‘ä»¬ç®¡ä¸­çª¥è±¹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DynamicType.Unloaded&lt;EchoA&gt; newClass = <span class="keyword">new</span> <span class="title class_">ByteBuddy</span>()</span><br><span class="line">        .subclass(EchoA.class) <span class="comment">// æ–°çš„ç±»ç»§æ‰¿äº EchoA</span></span><br><span class="line">        .method(ElementMatchers.named(<span class="string">&quot;echo&quot;</span>)) <span class="comment">// å¯¹æ–¹æ³•åä¸º echo åšå¢å¼º</span></span><br><span class="line">        .intercept(FixedValue.value(<span class="string">&quot;B&quot;</span>)) <span class="comment">// å¢å¼ºå†…å®¹æ˜¯è¿”å›ä¸€ä¸ªå›ºå®šå€¼ &quot;B&quot;</span></span><br><span class="line">        .make(); <span class="comment">// æ„é€ è¿™ä¸ª class</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç€é‡åˆ†æè¿™æ®µä»£ç :<code>subclass</code>,<code>method</code>,<code>intercept</code> è¿™ä¸‰ä¸ªæ–¹æ³•éƒ½æ˜¯å¯¹ ByteBuddy å¯¹è±¡è¿›è¡Œè®¾ç½®,æ²¡æœ‰è¿›è¡Œå…·ä½“å­—èŠ‚ç æ“ä½œ.</p>
<blockquote>
<p>ç”±äº BtyeBuddy æ¡†æ¶ä¸­ç”¨äº†å¾ˆå¤šä¸å¯å˜ç±», è¿™ä¸‰ä¸ªæ–¹æ³•çš„è¿”å›å€¼éƒ½æ˜¯ä¸€ä¸ªæ–°çš„ ByteBuddy å®ä¾‹.</p>
</blockquote>
<p>æœ€åçš„ <code>make</code> æ–¹æ³•å°†ä¼šè¿›è¡Œå­—èŠ‚ç å¢å¼º,äº§ç”Ÿæ–°çš„ç±»çš„å­—èŠ‚ç .æˆ‘ä»¬å…·ä½“çœ‹ä¸‹ <code>make</code> æ–¹æ³•å†…éƒ¨.</p>
<p>net.bytebuddy.dynamic.DynamicType.Builder.AbstractBase.UsingTypeWriter#make(net.bytebuddy.dynamic.TypeResolutionStrategy):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DynamicType.Unloaded&lt;U&gt; <span class="title function_">make</span><span class="params">(TypeResolutionStrategy typeResolutionStrategy, TypePool typePool)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> toTypeWriter(typePool).make(typeResolutionStrategy.resolve());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>make</code> æ–¹æ³•å†…éƒ¨ä½¿ç”¨ä¼šæ„é€ ä¸€ä¸ª TypeWriter å»åšå…·ä½“çš„ <code>make</code> æ“ä½œ.<br>æ„é€  TypeWriter çš„è¿‡ç¨‹å‚è€ƒä¸‹é¢ä»£ç çš„æ³¨é‡Š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> TypeWriter&lt;T&gt; <span class="title function_">toTypeWriter</span><span class="params">(TypePool typePool)</span> &#123;</span><br><span class="line">    MethodRegistry.<span class="type">Compiled</span> <span class="variable">methodRegistry</span> <span class="operator">=</span> constructorStrategy   <span class="comment">// constructorStrategy è§„å®šäº†å¦‚ä½•æ„é€ æ–°ç±»çš„æ„é€ å‡½æ•°, ByteBuddy éµå¾ªçº¦å®šä¼˜äºé…ç½®çš„åŸåˆ™, constructorStrategy æœ‰ä¸€ä¸ªé»˜è®¤å€¼,è¿™é‡Œæˆ‘ä»¬ä¸å±•å¼€è®¨è®º.</span></span><br><span class="line">            .inject(instrumentedType, <span class="built_in">this</span>.methodRegistry) <span class="comment">// inject å°†æ„é€ å‡½æ•°å¦‚ä½•æ„é€ çš„ handler æ’å…¥ methodRegistry,å¹¶è¿”å›è¿™ä¸ª methodRegistry</span></span><br><span class="line">            .prepare(applyConstructorStrategy(instrumentedType), <span class="comment">// prepare æ–¹æ³•ä¼šä¼šæ ¹æ®é…ç½® (ä¹Ÿå°±æ˜¯ä¸Šæ–‡ method å’Œ intercept æ–¹æ³•), å°†æ”¹é€  echo æ–¹æ³•çš„ handler åŠ å…¥ methodRegistry.</span></span><br><span class="line">            <span class="comment">// å…·ä½“æ“ä½œæ˜¯: åœ¨éœ€è¦è¢«æ€å¼ºçš„ç±» EchoA ä¸­, é€šè¿‡ è¿‡æ»¤å™¨(ElementMatchers.named(&quot;echo&quot;)) æ‰¾åˆ°éœ€è¦è¢«å¢å¼ºçš„</span></span><br><span class="line">            æ–¹æ³• echo , ç„¶åå°†è¿™ä¸ªæ–¹æ³•å’Œè¿™ä¸ªæ–¹æ³•å¦‚ä½•è¢«å¢å¼º (è¿”å›å›ºå®šå€¼ value FixedValue.value(<span class="string">&quot;B&quot;</span>)) æ’å…¥åˆ° methodRegistry</span><br><span class="line">                    methodGraphCompiler,</span><br><span class="line">                    typeValidation,</span><br><span class="line">                    visibilityBridgeStrategy,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InstrumentableMatcher</span>(ignoredMethods))</span><br><span class="line">            .compile(SubclassImplementationTarget.Factory.SUPER_CLASS, classFileVersion); <span class="comment">// compile æ–¹æ³•ä¼šå°†å¯¹åº”çš„ handler å¯¹åº”çš„ ByteCodeAppender å’Œ MethodAttributeAppender å’Œæ–¹æ³•å¯¹åº”èµ·æ¥,å¹¶ç¼“å­˜èµ·æ¥.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// æœ€åå°†å‡†å¤‡å¥½çš„å¯¹è±¡ç»„ç»‡æˆ TypeWriter è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> TypeWriter.Default.&lt;T&gt;forCreation(methodRegistry,</span><br><span class="line">            auxiliaryTypes,</span><br><span class="line">            fieldRegistry.compile(methodRegistry.getInstrumentedType()),</span><br><span class="line">            recordComponentRegistry.compile(methodRegistry.getInstrumentedType()),</span><br><span class="line">            typeAttributeAppender,</span><br><span class="line">            asmVisitorWrapper,</span><br><span class="line">            classFileVersion,</span><br><span class="line">            annotationValueFilterFactory,</span><br><span class="line">            annotationRetention,</span><br><span class="line">            auxiliaryTypeNamingStrategy,</span><br><span class="line">            implementationContextFactory,</span><br><span class="line">            typeValidation,</span><br><span class="line">            classWriterStrategy,</span><br><span class="line">            typePool);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ„é€ å®Œæˆ TypeWriter ä¹‹å, é€šè¿‡ make æ–¹æ³•æœ€ç»ˆæ„é€ å‡ºæ–°çš„ç±»çš„å­—èŠ‚ç , make æ–¹æ³•è°ƒç”¨<code>net.bytebuddy.dynamic.scaffold.TypeWriter.Default.ForCreation#create</code> create æ–¹æ³•, create æ–¹æ³•è°ƒç”¨ ASM æ¡†æ¶çš„æ–¹æ³•, å°†ä¸Šè¿°å‡†å¤‡å¥½çš„ ByteCodeAppender åº”ç”¨åˆ°è¢«å¢å¼ºçš„ç±»ä¸Š.</p>
<h1 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h1><p><a target="_blank" rel="noopener" href="https://bytebuddy.net/#/tutorial">ByteBuddy å®˜æ–¹æ•™ç¨‹</a>: å¦‚æœæƒ³è¦å¿«é€Ÿä¸Šæ‰‹ ByteBuddy, çœ‹è¿™ä¸ªå®˜æ–¹æ•™ç¨‹æœ€ç›´æ¥.<br><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se11/html/index.html">The JavaÂ® Virtual Machine Specification Java SE 11 Edition</a> æƒ³äº†è§£å­—èŠ‚ç å¯ä»¥çœ‹è¿™ä¸ªæ–‡æ¡£</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/12/06/git_ssh_dns_problem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="åˆ†äº«æˆ‘çš„æ—¥å¸¸æŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/06/git_ssh_dns_problem/" class="post-title-link" itemprop="url">è®°ä¸€æ¬¡ Github æ— æ³•ä½¿ç”¨ git å®¢æˆ·ç«¯çš„é—®é¢˜</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-06 14:26:25" itemprop="dateCreated datePublished" datetime="2022-12-06T14:26:25+00:00">2022-12-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Common/" itemprop="url" rel="index"><span itemprop="name">Common</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h1><p>ä½¿ç”¨ git push ä»£ç åˆ° github. ç›´æ¥å¡ä½äº†, è¿‡äº†å¾ˆé•¿æ—¶é—´æŠ¥é”™. æ‰§è¡Œ <code>telent github.com 22</code>æ— æ³•è¿é€š.</p>
<h1 id="è§£å†³æ–¹æ¡ˆåŠåŸå› "><a href="#è§£å†³æ–¹æ¡ˆåŠåŸå› " class="headerlink" title="è§£å†³æ–¹æ¡ˆåŠåŸå› "></a>è§£å†³æ–¹æ¡ˆåŠåŸå› </h1><h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p>å°† DNS è§£ææœåŠ¡å™¨é…ç½®ä¸º <code>8.8.8.8</code>.</p>
<h1 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h1><p>å¥½åœ¨è‡ªå·±æœ‰å¦ä¸€å°æœºå™¨, å¯ä»¥è¿ä¸Š github. æ¯”å¯¹ä¸¤å°æœºå™¨, å¯ä»¥å‘ç°, å‡ºé—®é¢˜çš„æœºå™¨ github.com åŸŸåè§£æå‡ºæ¥æ˜¯ä¸€ä¸ªè´µå·çš„IP: <code>182.43.124.6</code>. è€Œæ²¡å‡ºé—®é¢˜çš„æœºå™¨,è§£æå‡ºæ¥çš„æ˜¯æ–°åŠ å¡çš„IP: <code>20.205.243.166</code>.<br>åè€… telnet ç»“æœ:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># telnet 20.205.243.166 22</span><br><span class="line">Trying 20.205.243.166...</span><br><span class="line">Connected to github.com.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">SSH-2.0-babeld-cd305013</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° SSH çš„è¿”å›, è¿™æ˜¯èƒ½æ­£å¸¸è¿æ¥çš„.</p>
<p>å‡ºé—®é¢˜çš„æœºå™¨æ²¡æœ‰æŒ‡å®š DNS æœåŠ¡å™¨, æ²¡å‡ºé—®é¢˜çš„æœºå™¨æŒ‡å®šäº† 8.8.8.8.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/11/28/remote-login-use-ssh/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="åˆ†äº«æˆ‘çš„æ—¥å¸¸æŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/28/remote-login-use-ssh/" class="post-title-link" itemprop="url">ä½¿ç”¨ SSH å®ç°è¿œç¨‹ç™»å½•å†…ç½‘æœºå™¨ (MacOS)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-28 17:12:32" itemprop="dateCreated datePublished" datetime="2022-11-28T17:12:32+00:00">2022-11-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Common/" itemprop="url" rel="index"><span itemprop="name">Common</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ç°åœ¨æˆ‘çš„ä¸»åŠ›å¼€å‘æœºå™¨æ˜¯å°å°å¼æœº, æœ‰æ—¶å€™å‡ºé—¨åœ¨å¤–, å°±æ²¡åŠæ³•æ“æ§è¿™å°æœºå™¨äº†. æˆ‘è§£å†³è¿™ä¸ªé—®é¢˜çš„<strong>åŸºæœ¬æ€è·¯</strong>æ˜¯: ç§Ÿç”¨ä¸€å°äº‘ä¸Šå¸¦å…¬ç½‘åŸŸåçš„æœºå™¨,ç„¶åå°†æœ¬åœ° 22 ç«¯å£æ˜ å°„åˆ°äº‘æœåŠ¡å™¨ä¸Š. è¿™æ ·å°±å¯ä»¥å°†äº‘æœåŠ¡å™¨ä½œä¸ºä¸€å°è·³æ¿æœº,ç™»å½•æˆ‘æœ¬åœ°çš„æœºå™¨äº†.</p>
<h1 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h1><ul>
<li>å°†æœ¬åœ° 22 ç«¯å£æ˜ å°„åˆ°äº‘ä¸Šæœºå™¨</li>
<li>è®©æœ¬åœ°æœºå™¨å¼€æœºè¿è¡Œè„šæœ¬,è‡ªåŠ¨å®Œæˆä¸Šè¿°å·¥ä½œ</li>
</ul>
<h1 id="å®ç°æ­¥éª¤"><a href="#å®ç°æ­¥éª¤" class="headerlink" title="å®ç°æ­¥éª¤"></a>å®ç°æ­¥éª¤</h1><h2 id="å‡†å¤‡å·¥ä½œ-è´­ä¹°ä¸€å°äº‘æœåŠ¡å™¨"><a href="#å‡†å¤‡å·¥ä½œ-è´­ä¹°ä¸€å°äº‘æœåŠ¡å™¨" class="headerlink" title="å‡†å¤‡å·¥ä½œ:è´­ä¹°ä¸€å°äº‘æœåŠ¡å™¨"></a>å‡†å¤‡å·¥ä½œ:è´­ä¹°ä¸€å°äº‘æœåŠ¡å™¨</h2><p>æˆ‘ä¹°çš„çš„æ˜¯ä¸€å°2C4G,è…¾è®¯äº‘æœåŠ¡å™¨.è¶åŒ11+æ–°äººä¼˜æƒ ,åªè¦100å…ƒ&#x2F;å¹´.éœ€è¦è·å–è¿™å°æœºå™¨çš„IP,è®¾ç½® ssh å…¬é’¥,è®©æœ¬åœ°æœºå™¨å¯ä»¥é€šè¿‡shell<strong>å…å¯†</strong>ç™»å½•äº‘æœåŠ¡å™¨.</p>
<h2 id="æœ¬åœ°æœºå™¨é…ç½®"><a href="#æœ¬åœ°æœºå™¨é…ç½®" class="headerlink" title="æœ¬åœ°æœºå™¨é…ç½®"></a>æœ¬åœ°æœºå™¨é…ç½®</h2><p>æ„é€ ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶:<br>remote_ssh.sh:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">PORT=&#x27;8888&#x27;</span><br><span class="line">n=1</span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">  echo &quot;try $n&quot;</span><br><span class="line">  ssh -o ExitOnForwardFailure=yes -R 8888:localhost:22 -N root@cloud_ip</span><br><span class="line">  n=$((n+1))</span><br><span class="line">  echo &quot;fail $n&quot;</span><br><span class="line">  sleep 15</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªè„šæœ¬ä¼šå°†äº‘æœåŠ¡å™¨ä¸Šçš„ 8888 æ”¶åˆ°çš„è¯·æ±‚è½¬å‘ç»™æœ¬åœ°22ç«¯å£, ä¹Ÿå°±æ˜¯æœ¬åœ° sshd ç›‘å¬çš„ç«¯å£. åŒæ—¶å¦‚æœæ“ä½œå¤±è´¥,å°±ä¼š15såé‡è¯•.<br>å˜é‡è¯´æ˜:</p>
<ul>
<li><strong>root</strong>: ç™»å½•äº‘æœåŠ¡å™¨çš„ç”¨æˆ·å,æ ¹æ®ä½ çš„éœ€è¦ä¿®æ”¹</li>
<li><strong>cloud_ip</strong>: äº‘æœåŠ¡å™¨çš„å…¬ç½‘ip</li>
<li><strong>-o ExitOnForwardFailure&#x3D;yes</strong>: è®¾ç½®å¦‚æœç«¯å£è½¬å‘å¼€å¯å¤±è´¥å°±é€€å‡ºçš„é€‰é¡¹</li>
</ul>
<p>startup.sh:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">curday=`date +%Y-%m-%d`</span><br><span class="line"></span><br><span class="line">nohup bash ~/git/shell/remote_ssh.sh 2&gt;&amp;1 &gt;~/git/shell/logs/remote_ssh$curday.log &amp;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªè„šæœ¬ä¼šæ‰§è¡Œ <code>remote_ssh.sh</code> è¿™ä¸ªè„šæœ¬,å¹¶å°†æ—¥å¿—è¾“å‡ºåˆ°<code>~/git/shell/logs/</code>æ–‡ä»¶å¤¹ä¸­.</p>
<p>å°†<code>startup.sh</code>çš„é»˜è®¤æ‰“å¼€æ–¹å¼ä¿®æ”¹ä¸º Term æˆ–è€… iTerm.</p>
<p>åœ¨ç³»ç»Ÿè®¾ç½®-&gt;ç”¨æˆ·ä¸ç¾¤ç»„å°† startup.sh æ·»åŠ åˆ°ç™»å½•é¡¹.</p>
<h2 id="äº‘ä¸Šæœºå™¨é…ç½®"><a href="#äº‘ä¸Šæœºå™¨é…ç½®" class="headerlink" title="äº‘ä¸Šæœºå™¨é…ç½®"></a>äº‘ä¸Šæœºå™¨é…ç½®</h2><p>ä¿®æ”¹ <code>/etc/ssh/sshd_config</code> æ–‡ä»¶, æ·»åŠ å¦‚ä¸‹é…ç½®:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ClientAliveInterval 10</span><br><span class="line">ClientAliveCountMax 1</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸¤ä¸ªé…ç½®ä¼šå¼€å¯æœåŠ¡ç«¯ shhd å¯¹äºå®¢æˆ·ç«¯çš„æ¢æ´»,å¦‚æœå®¢æˆ·ç«¯è¿æ¥æ–­å¼€äº†, æœåŠ¡ç«¯ä¹Ÿä¼šå…³é—­è¿æ¥.</p>
<h1 id="é‡åˆ°çš„å‘"><a href="#é‡åˆ°çš„å‘" class="headerlink" title="é‡åˆ°çš„å‘"></a>é‡åˆ°çš„å‘</h1><h2 id="ç«¯å£è½¬å‘å¤±è´¥ä¹‹å-ssh-ä¸é€€å‡º"><a href="#ç«¯å£è½¬å‘å¤±è´¥ä¹‹å-ssh-ä¸é€€å‡º" class="headerlink" title="ç«¯å£è½¬å‘å¤±è´¥ä¹‹å, ssh ä¸é€€å‡º"></a>ç«¯å£è½¬å‘å¤±è´¥ä¹‹å, ssh ä¸é€€å‡º</h2><p>ç«¯å£è½¬å‘å¤±è´¥ä¹‹å, ssh ä¸é€€å‡º,å°±æ²¡åŠæ³•åšé‡è¯•. åœ¨æ·»åŠ  <code>-o ExitOnForwardFailure=yes</code> é€‰é¡¹ä¹‹å,ä¿®å¤äº†è¿™é—®é¢˜.</p>
<h2 id="ssh-æ–­å¼€ä¹‹å-sshd-ä¾ç„¶ç›‘å¬ç«¯å£"><a href="#ssh-æ–­å¼€ä¹‹å-sshd-ä¾ç„¶ç›‘å¬ç«¯å£" class="headerlink" title="ssh æ–­å¼€ä¹‹å, sshd ä¾ç„¶ç›‘å¬ç«¯å£"></a>ssh æ–­å¼€ä¹‹å, sshd ä¾ç„¶ç›‘å¬ç«¯å£</h2><p>ssh æ–­å¼€ä¹‹å, sshd ä¾ç„¶ç›‘å¬ç«¯å£. å½“ ssh ç»§ç»­é‡è¯•å»ºç«‹ç«¯å£è½¬å‘,å› ä¸ºæœåŠ¡ç«¯ sshd ä¾ç„¶å ç”¨ä¹‹å‰é‚£ä¸ªç«¯å£,å¯¼è‡´é‡è¯•å§‹ç»ˆæ— æ³•æˆåŠŸ.<br>è§£å†³æ–¹æ¡ˆæ˜¯ç»™ sshd å¼€å¯æ¢æ´»,æ·»åŠ  ClientAliveInterval å’Œ ClientAliveCountMax é…ç½®.</p>
<h1 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£:"></a>å‚è€ƒæ–‡æ¡£:</h1><p><a target="_blank" rel="noopener" href="https://wangdoc.com/ssh/port-forwarding">SSHæ•™ç¨‹</a>: é˜®ä¸€å³°çš„SSHæ•™ç¨‹, çœ‹å®Œä¸éœ€è¦å¤šé•¿æ—¶é—´,èƒ½å¯¹ SSH æœ‰åˆæ­¥äº†è§£<br><a target="_blank" rel="noopener" href="https://superuser.com/questions/1563605/how-can-a-remote-ssh-tunnel-port-be-closed-on-the-ssh-server-when-the-ssh-comman">how-can-a-remote-ssh-tunnel-port-be-closed-on-the-ssh-server-when-the-ssh-comman</a><br><a target="_blank" rel="noopener" href="https://man.openbsd.org/sshd_config">man:sshd_config</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/11/24/javaagent_introduction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="åˆ†äº«æˆ‘çš„æ—¥å¸¸æŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/24/javaagent_introduction/" class="post-title-link" itemprop="url">Java Agent åŸç†ç®€ä»‹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-24 15:02:39" itemprop="dateCreated datePublished" datetime="2022-11-24T15:02:39+00:00">2022-11-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/javaagent/" itemprop="url" rel="index"><span itemprop="name">javaagent</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Java-Agent-æ˜¯ä»€ä¹ˆ"><a href="#Java-Agent-æ˜¯ä»€ä¹ˆ" class="headerlink" title="Java Agent æ˜¯ä»€ä¹ˆ"></a>Java Agent æ˜¯ä»€ä¹ˆ</h1><p>Java Agent æ˜¯ä¸€ç§å¯ä»¥åŠ¨æ€ä¿®æ”¹ Java ç±»å­—èŠ‚ç çš„æŠ€æœ¯.</p>
<p>ä½¿ç”¨ Java Agent é€šå¸¸æ˜¯ä¸ºäº†åŠ¨æ€å¢åŠ åº”ç”¨çš„åŠŸèƒ½,ä½†è¿™äº›åŠŸèƒ½å’Œä¸»ä½“ä¸šåŠ¡é€»è¾‘æ˜¯ä¸è€¦åˆçš„, æ¯”å¦‚è¯´å„ç§ç›‘æ§\è¯Šæ–­å·¥å…·,ç”šè‡³æœ‰å…¬å¸æ‹¿å®ƒæ¥å®ç° Service Mesh.<br>ä¸¾ä¸¤ä¸ªä¾‹å­:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/apache/skywalking-java">SkyWalking-java</a> SkyWalking ç¤¾åŒºæ¨å‡ºçš„ Java Agent, ç”¨äºJava åº”ç”¨å¿«é€Ÿæ¥å…¥ SkyWalking</li>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas">Arthas</a> æ˜¯ Alibaba æ¨å‡ºçš„ Java è¯Šæ–­å·¥å…·.</li>
<li>é˜¿é‡Œäº‘ <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/HjQUvTlAXuI3y_azlSh2Pw">Spring Cloud åº”ç”¨ Proxyless Mesh æ¨¡å¼æ¢ç´¢ä¸å®è·µ</a></li>
</ol>
<p>ä¸Šé¢ä¸¤è€…å‡æ˜¯åŸºäº Java Agent å®ç°çš„.</p>
<p>ä½¿ç”¨ Java Agent å¯ä»¥å®ç°å¦‚ä¸‹æŠ€æœ¯ç›®æ ‡:</p>
<ol>
<li>å¯¹æºä»£ç <strong>æ— ä¾µå…¥</strong>çš„æƒ…å†µä¸‹, å®ŒæˆåŠŸèƒ½çš„æ·»åŠ : SkyWalking-java ä¸»è¦åˆ©ç”¨è¿™ä¸€ç‰¹æ€§, å½“æˆ‘ä»¬æœ‰å¾ˆå¤šç³»ç»Ÿéƒ½éœ€è¦æ¥å…¥ç›‘æ§åŸ‹ç‚¹æ—¶, å°±ä¸éœ€è¦å‡çº§æ¯ä¸€ä¸ªåº”ç”¨äº†, æ·»åŠ  Java Agent å³å¯.</li>
<li><strong>è¿è¡Œæ—¶åŠ¨æ€</strong>ä¿®æ”¹åŠŸèƒ½,å®ç°çƒ­éƒ¨ç½². Arthas ä¸»è¦åˆ©ç”¨è¿™ä¸€ç‰¹æ€§, Arths çš„è¯Šæ–­åŠŸèƒ½æ˜¯å¯¹æ€§èƒ½æœ‰å½±å“çš„,åªèƒ½å•ç‹¬é€‰æ‹©ä¸€ä¸¤å°æœåŠ¡å™¨å¼€å¯. å¹¶ä¸”æ•…éšœè¯Šæ–­éœ€è¦æ•…éšœç°åœº,ä¸èƒ½é‡å¯åº”ç”¨, å› æ­¤çƒ­éƒ¨ç½²ç‰¹æ€§å¯¹äº Arthas æ¥è¯´å°±è‡³å…³é‡è¦äº†.</li>
</ol>
<h1 id="Java-Agent-å·¥ä½œåŸç†ç®€ä»‹"><a href="#Java-Agent-å·¥ä½œåŸç†ç®€ä»‹" class="headerlink" title="Java Agent å·¥ä½œåŸç†ç®€ä»‹"></a>Java Agent å·¥ä½œåŸç†ç®€ä»‹</h1><h2 id="Java-Agent-çš„å¯åŠ¨"><a href="#Java-Agent-çš„å¯åŠ¨" class="headerlink" title="Java Agent çš„å¯åŠ¨"></a>Java Agent çš„å¯åŠ¨</h2><p>Java Agent çš„å¯åŠ¨æœ‰ä¸¤ç§æ–¹å¼:</p>
<ol>
<li>åœ¨å¯åŠ¨ Java åº”ç”¨æ—¶,åœ¨ JVM å‚æ•°ä¸­æ·»åŠ  <code>-javaagent:/path/to/your_agent_name.jar</code>.ä¸‹æ–‡ç®€ç§° JVM å‚æ•°æ–¹å¼.</li>
<li>åœ¨è¿è¡Œæ—¶,é€šè¿‡ com.sun.tools.attach.VirtualMachine#loadAgent(java.lang.String) åŠ¨æ€åŠ è½½ Java Agent. ä¸‹æ–‡ç®€ç§°è¿è¡Œæ—¶æ–¹å¼.</li>
</ol>
<blockquote>
<p>è¿™é‡Œå…·ä½“è¯´æ˜ä¸‹è¿è¡Œæ—¶æ–¹å¼çš„å¯åŠ¨: å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª biz.jar æ˜¯æˆ‘ä»¬çš„ä¸šåŠ¡åº”ç”¨,  agent.jar æ˜¯æˆ‘ä»¬çš„ Java Agent. æˆ‘ä»¬å¯ä»¥åœ¨å¯åŠ¨ä¸€ä¸ª attach.jar ,æ¥å°† agent.jar  attach åˆ° biz.jar ä¸Š, æ•´ä¸ªè¿‡ç¨‹æ˜¯ä¸éœ€è¦ä¿®æ”¹ biz.jar çš„.</p>
</blockquote>
<p>ä¸‹é¢æˆ‘ä»¬ä¼šä»å‡ ä¸ªæ–¹é¢æ¥æ¯”è¾ƒè¿™ä¸¤ç§å¯åŠ¨æ–¹å¼:</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">JVM å‚æ•°æ–¹å¼</th>
<th align="left">è¿è¡Œæ—¶æ–¹å¼</th>
</tr>
</thead>
<tbody><tr>
<td align="left">å¯åŠ¨æ—¶æœº</td>
<td align="left">mainå‡½æ•°æ‰§è¡Œä¹‹å‰</td>
<td align="left">åº”ç”¨è¿è¡Œæ—¶</td>
</tr>
<tr>
<td align="left">æ‰§è¡Œçº¿ç¨‹</td>
<td align="left">main çº¿ç¨‹</td>
<td align="left">AttachListener çº¿ç¨‹</td>
</tr>
<tr>
<td align="left">å…¥å£å‡½æ•°</td>
<td align="left">premain()</td>
<td align="left">agentmain()</td>
</tr>
<tr>
<td align="left">ClassLoader</td>
<td align="left">AppClassLoader</td>
<td align="left">AppClassLoader</td>
</tr>
</tbody></table>
<h3 id="Java-Agent-å¯åŠ¨ä»£ç åˆ†æ"><a href="#Java-Agent-å¯åŠ¨ä»£ç åˆ†æ" class="headerlink" title="Java Agent å¯åŠ¨ä»£ç åˆ†æ"></a>Java Agent å¯åŠ¨ä»£ç åˆ†æ</h3><p>åœ¨ JVM æ¥æ”¶åˆ°ç›¸å…³çš„å‚æ•°ä¹‹å, å°±ä¼šè°ƒç”¨ InstrumentationImpl å¯¹è±¡æ‰§è¡Œ agent é€»è¾‘. JVM æ–¹å¼ä¼šè°ƒç”¨ InstrumentationImpl çš„ loadClassAndCallPremain æ–¹æ³•, è¿è¡Œæ—¶æ–¹å¼ä¼šè°ƒç”¨ loadClassAndCallAgentmain æ–¹æ³•.è¿™ä¸¤ä¸ªæ–¹æ³•åº•å±‚éƒ½æ˜¯è°ƒç”¨  loadClassAndStartAgent æ–¹æ³•:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WARNING: the native code knows the name &amp; signature of this method</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span></span><br><span class="line"><span class="title function_">loadClassAndCallPremain</span><span class="params">(    String  classname,</span></span><br><span class="line"><span class="params">                            String  optionsString)</span></span><br><span class="line">        <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">    loadClassAndStartAgent( classname, <span class="string">&quot;premain&quot;</span>, optionsString );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// WARNING: the native code knows the name &amp; signature of this method</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span></span><br><span class="line"><span class="title function_">loadClassAndCallAgentmain</span><span class="params">(  String  classname,</span></span><br><span class="line"><span class="params">                            String  optionsString)</span></span><br><span class="line">        <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">    loadClassAndStartAgent( classname, <span class="string">&quot;agentmain&quot;</span>, optionsString );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ loadClassAndStartAgent æ–¹æ³•ä¸­, é¦–å…ˆè·å– AppClassLoader ,ç„¶åé€šè¿‡ AppClassLoader åŠ è½½ AgentClass ç±».æœ€åé€šè¿‡åå°„è°ƒç”¨ premain æˆ–è€… agentmain æ–¹æ³•.</p>
<p>å› æ­¤æˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®º: <strong>é™¤äº†ä¸Šæ–‡è¡¨æ ¼ä¸­çš„ä¸åŒç‚¹, JVM æ–¹å¼ å’Œ è¿è¡Œæ—¶æ–¹å¼å¯åŠ¨çš„ Java Agent æ²¡ä»€ä¹ˆåŒºåˆ«.</strong></p>
<p>agentmain å’Œ premain æœ‰ä¸€ä¸ªå‚æ•°æ˜¯ Instrumentation , Instrumentationimpl ä¼šå°†è‡ªèº«ä¼ é€’ç»™ agentmain&#x2F;premian æ–¹æ³•.</p>
<h2 id="å®ç°å­—èŠ‚ç ä¿®æ”¹-â€“-Instrumentation-ç®€ä»‹"><a href="#å®ç°å­—èŠ‚ç ä¿®æ”¹-â€“-Instrumentation-ç®€ä»‹" class="headerlink" title="å®ç°å­—èŠ‚ç ä¿®æ”¹ â€“ Instrumentation ç®€ä»‹"></a>å®ç°å­—èŠ‚ç ä¿®æ”¹ â€“ Instrumentation ç®€ä»‹</h2><p>Instrumentation æ˜¯ agentmain&#x2F;premain çš„å…¥å‚, é€šè¿‡è¿™ä¸ªç±», å¯ä»¥å®ç°å­—èŠ‚ç ä¿®æ”¹.</p>
<p>Instrumentation å¯¹äºå­—èŠ‚ç çš„ä¿®æ”¹,å¯ä»¥åˆ†ä¸ºä¸¤ç§å½¢å¼:</p>
<ol>
<li>transform: ä¿®æ”¹å­—èŠ‚ç ,ä¼šåœ¨å­—èŠ‚ç é‡Œé¢æºç§è´§.ç»™ç±»åŠ åˆ‡é¢ç”¨è¿™ç§æ–¹å¼.</li>
<li>redefine: é‡æ–°å®šä¹‰å­—èŠ‚ç , æ¨å€’é‡æ¥. ç›´æ¥ä¿®æ”¹ç±»çš„ä¸šåŠ¡é€»è¾‘ç”¨è¿™ç§æ–¹å¼.</li>
</ol>
<p>redeine æ˜¯ java1.5 å¼•å…¥çš„, è€Œ transform æ˜¯ java 1.6 å¼•å…¥çš„. transform çš„ä½¿ç”¨æ›´æ–¹ä¾¿,å› æ­¤æˆ‘æ¨èä½¿ç”¨ transform è€Œä¸ç”¨ä½¿ç”¨ redeine.</p>
<p>transform åˆåˆ†ä¸ºä¸¤ç±»:</p>
<ol>
<li>transform: åœ¨ç±»ç¬¬ä¸€æ¬¡åŠ è½½æ—¶æ‰§è¡Œ</li>
<li>retransform: è°ƒç”¨ Instrumentation çš„ retransformClasses æ–¹æ³•æ‰‹åŠ¨æ‰§è¡Œ.</li>
</ol>
<h3 id="transform-æ–¹æ³•"><a href="#transform-æ–¹æ³•" class="headerlink" title="transform æ–¹æ³•"></a>transform æ–¹æ³•</h3><p>æˆ‘ä»¬å¯ä»¥å‘ <code>Instrumentation</code> ä¸­æ³¨å†Œ <code>Transformer</code>, å½“ä¸€ä¸ªç±»è¢«åŠ è½½æˆ–è€…è¢«è°ƒç”¨ <code>retransform</code> æ—¶, Transformer çš„ <code>transform</code> æ–¹æ³•ä¼šè¢«è°ƒç”¨. <code>transform</code> æ¥æ”¶ä¸€ä¸ªç”¨æ¥è¡¨ç¤º classFile çš„äºŒè¿›åˆ¶æ•°ç»„, åŒæ—¶è¿”å›ä¸€ä¸ªæ–°çš„è¡¨ç¤ºç±»çš„äºŒè¿›åˆ¶æ•°ç»„.</p>
<p>å¯ä»¥ç”¨ ASM ,ByteBuddy ç­‰æ¡†æ¶æ¥è¯»å–,ä¿®æ”¹è¿™ä¸ªäºŒè¿›åˆ¶æ•°ç»„å¹¶è¿”å›. è¿™æ ·, ä¸€æ¬¡ä»£ç å¢å¼ºå°±å®Œæˆäº†</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/11/23/debug-jvm-on-mac/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="åˆ†äº«æˆ‘çš„æ—¥å¸¸æŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/23/debug-jvm-on-mac/" class="post-title-link" itemprop="url">åœ¨ MacOS ä¸Šè°ƒè¯• JVM</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-23 08:15:17" itemprop="dateCreated datePublished" datetime="2022-11-23T08:15:17+00:00">2022-11-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>æœ€è¿‘åœ¨çœ‹ JVM æºç ,æ²¡æœ‰ debug ç¯å¢ƒå¾ˆä¸æ–¹ä¾¿, éƒ½ä¸çŸ¥é“æ–¹æ³•æ˜¯æ€ä¹ˆè·³è½¬çš„. å› æ­¤æƒ³è¦è‡ªå·±æ­ä¸€ä¸ª debug ç¯å¢ƒ. ç½‘ä¸Šæœ‰å¾ˆå¤šç›¸å…³çš„æ–‡ç« , ä½†æ¯•ç«Ÿä¸æ˜¯ä¸€æ¨¡ä¸€æ ·ç¯å¢ƒ, ä¸€ç‚¹å°å°çš„å·®å¼‚, å°±å¯èƒ½è®©ç¼–è¯‘å¤±è´¥,æµªè´¹å¾ˆå¤šæ—¶é—´.</p>
<p>å› æ­¤æˆ‘é€‰æ‹©é€šè¿‡ brew çš„ç¼–è¯‘æ–¹å¼æ¥, ç¨å¾®ä¿®æ”¹ä¸€ä¸‹å‚æ•°å³å¯è·å¾—æˆ‘ä»¬éœ€è¦çš„ debug ç‰ˆæœ¬ JVM.</p>
<h1 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h1><ul>
<li>Mac Studio M1 Max</li>
<li>macOS Monterey 12.5.1</li>
</ul>
<h1 id="ç¼–è¯‘è¿‡ç¨‹"><a href="#ç¼–è¯‘è¿‡ç¨‹" class="headerlink" title="ç¼–è¯‘è¿‡ç¨‹"></a>ç¼–è¯‘è¿‡ç¨‹</h1><h3 id="å°è¯•ç›´æ¥é€šè¿‡-brew-ç¼–è¯‘-JVM"><a href="#å°è¯•ç›´æ¥é€šè¿‡-brew-ç¼–è¯‘-JVM" class="headerlink" title="å°è¯•ç›´æ¥é€šè¿‡ brew ç¼–è¯‘ JVM"></a>å°è¯•ç›´æ¥é€šè¿‡ brew ç¼–è¯‘ JVM</h3><p>æ‰§è¡Œå‘½ä»¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install --build-from-source --verbose openjdk@11</span><br></pre></td></tr></table></figure>
<p>ç›´æ¥å®‰è£… jdk 11, è¿™ä¸ªå‘½ä»¤ä¼šä»æºç å®‰è£… openjdk11. å¯ä»¥çœ‹ä¸‹èƒ½ä¸èƒ½ç¼–è¯‘æˆåŠŸ. å¦‚æœè¿™ä¸ªå‘½ä»¤ç¼–è¯‘ä¸æˆåŠŸ,åé¢çš„æ­¥éª¤é¡µæ²¡å¿…è¦å°è¯•äº†; å¦‚æœç¼–è¯‘æˆåŠŸäº†, é‚£æˆ‘ä»¬å°±ä¼šæ¯”è¾ƒæœ‰ä¿¡å¿ƒäº†.</p>
<p>è¿™ä¸ªå‘½ä»¤ä¼šè¾“å‡ºå¾ˆå¤šç»†èŠ‚ä¿¡æ¯, è¿™å¾ˆé‡è¦.</p>
<p>ä¸Šè¿°å‘½ä»¤å®é™…ä¸Šæ‰§è¡Œçš„æ˜¯ <a target="_blank" rel="noopener" href="https://github.com/Homebrew/homebrew-core/blob/master/Formula/openjdk%4011.rb">openjdk@11.rb</a>, é€šç›®å½•ä¸‹è¿˜æœ‰ openjdk8,17,19 å¯ä¾›é€‰æ‹©.</p>
<h3 id="brew-ç¼–è¯‘-JVM-çš„è¿‡ç¨‹"><a href="#brew-ç¼–è¯‘-JVM-çš„è¿‡ç¨‹" class="headerlink" title="brew ç¼–è¯‘ JVM çš„è¿‡ç¨‹"></a>brew ç¼–è¯‘ JVM çš„è¿‡ç¨‹</h3><ol>
<li>ä¸‹è½½å¹¶è§£å‹æºç åˆ° <code>/private/tmp/openjdk11xxx</code>ä¸­</li>
<li>ä¸‹è½½å¹¶è§£å‹ boot-jvm åˆ° <code>/private/tmp/openjdk11-boot-jdkxxx</code> ä¸­</li>
<li>æ ¹æ® <a target="_blank" rel="noopener" href="https://github.com/Homebrew/homebrew-core/blob/master/Formula/openjdk%4011.rb">openjdk@11.rb</a> ä¸­çš„é…ç½®æ‰§è¡Œ configure è„šæœ¬</li>
<li>æ‰§è¡Œ make å‘½ä»¤:<code>make images CONF=release</code></li>
<li>åˆ é™¤æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶</li>
</ol>
<p>ä¸ºäº†èƒ½ç¼–è¯‘å‡ºå¯ä»¥ debug çš„ JVM ,æˆ‘ä»¬è¿˜éœ€è¦åšä¸¤ä»¶äº‹æƒ…:</p>
<ol>
<li>åœ¨é…ç½® configure è„šæœ¬æ—¶,æ·»åŠ  debug å‚æ•°</li>
<li>brew åœ¨å®‰è£…å®Œæˆåä¼šå°†æºç åˆ é™¤, æˆ‘ä»¬éœ€è¦å°†æºç ä¿ç•™</li>
</ol>
<h3 id="æ‰‹åŠ¨ç¼–è¯‘-JVM"><a href="#æ‰‹åŠ¨ç¼–è¯‘-JVM" class="headerlink" title="æ‰‹åŠ¨ç¼–è¯‘ JVM"></a>æ‰‹åŠ¨ç¼–è¯‘ JVM</h3><p>æ¥ä¸‹ä¿©æˆ‘ä»¬ä»¿ç…§brew çš„ç¼–è¯‘æ–¹å¼æ‰‹åŠ¨ç¼–è¯‘ JVM:</p>
<ol>
<li>è§£å‹æºç <br>brew å®‰è£…å®Œæˆåä¼šåˆ é™¤æºç ,ä½†æ˜¯ä¸ä¼šåˆ é™¤ä¸‹è½½ä¸‹æ¥çš„æºç å‹ç¼©åŒ…,æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨è§£å‹è¿™ä¸ªå‹ç¼©åŒ…,ç„¶åå°†æºç æ”¾åˆ°æˆ‘ä»¬è‡ªå·±çš„ç›®å½•ä¸­.</li>
</ol>
<p>ç›¸å…³çš„å‘½ä»¤åœ¨ brew ç¼–è¯‘ JVM çš„è¾“å‡ºä¸­æœ‰,å¯ä»¥ç›´æ¥å‚è€ƒ.</p>
<blockquote>
<p>æ³¨æ„: è§£å‹ç›®æ ‡æ–‡ä»¶å¤¹éœ€è¦å·²ç»å­˜åœ¨.</p>
</blockquote>
<ol start="2">
<li><p>è§£å‹ boot jdk<br>åŒä¸Š, æˆ‘ä»¬éœ€è¦å§boot jdk è§£å‹å‡ºæ¥</p>
</li>
<li><p>ä¿®æ”¹ configure å‚æ•°æ‰§è¡Œ configure è„šæœ¬<br>æ‰§è¡Œ configure è„šæœ¬çš„å‚æ•°åœ¨brew è¾“å‡ºä¸­ä¹Ÿæœ‰,å¯ä»¥æŠ„ä¸‹æ¥.æˆ‘ä»¬éœ€è¦å¯¹å…¶ä¸­å‡ ä¸ªå‚æ•°è¿›è¡Œä¿®æ”¹:</p>
</li>
</ol>
<ul>
<li><code>--with-boot-jdk</code> å¦‚æœä¿®æ”¹äº† boot-jdk çš„ä½ç½®,éœ€è¦å°†è¿™ä¸ªå‚æ•°æŒ‡å‘çœŸç¡®çš„ä½ç½®</li>
<li><code>--with-debug-level</code> ä¿®æ”¹ä¸ºfastdebug</li>
<li><code>--with-native-debug-symbols</code> çš„å€¼ä¿®æ”¹ä¸º internal, è¡¨ç¤ºä¼šæŠŠç¬¦å·è¡¨åµŒå…¥åˆ°äºŒè¿›åˆ¶ä¸­,è¿™æ˜¯ debug çš„å…³é”®</li>
</ul>
<p>configure å‘½ä»¤çš„ä¾‹å­</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --disable-hotspot-gtest --disable-warnings-as-errors --with-boot-jdk-jvmargs=-Duser.home=/Users/zhangchengxi/Library/Caches/Homebrew/java_cache --with-boot-jdk=/private/tmp/openjdkA11-20221122-35955-58bnn5/jdk11u-jdk-11.0.16.1-ga/boot-jdk --with-debug-level=fastdebug --with-conf-name=release --with-jvm-variants=server --with-jvm-features=shenandoahgc --with-native-debug-symbols=none --with-vendor-bug-url=https://github.com/Homebrew/homebrew-core/issues --with-vendor-name=Homebrew --with-vendor-url=https://github.com/Homebrew/homebrew-core/issues --with-vendor-version-string=Homebrew --with-vendor-vm-bug-url=https://github.com/Homebrew/homebrew-core/issues --without-version-opt --without-version-pre --enable-dtrace --with-sysroot=/Library/Developer/CommandLineTools/SDKs/MacOSX12.sdk --with-extra-ldflags=-Wl,-rpath,@loader_path/server -headerpad_max_install_names</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜, brew æ‰§è¡Œè¿™ä¸ªå‘½ä»¤æ˜¯å¯ä»¥æˆåŠŸçš„,ä½†æ˜¯æˆ‘æ‰§è¡Œçš„æ—¶å€™, å¿…é¡»æŠŠæœ€åä¸€ä¸ªå‚æ•° headerpad_max_install_names å»æ‰æ‰èƒ½æˆåŠŸ.</p>
</blockquote>
<ol start="4">
<li>æ‰§è¡Œ make å‘½ä»¤: <code>make images CONF=release</code><br>è¿™ä¸ªå‘½ä»¤ä¼šåœ¨ <code>release/images/jdk/</code>  ä¸‹åˆ›å»º JVM çš„äºŒè¿›åˆ¶</li>
</ol>
<p>ä¸Šè¿°æ­¥éª¤å®Œæˆä¹‹å, æˆ‘ä»¬å°±æœ‰äº†å¯ä»¥ç”¨äº debug çš„ JVM äº†.</p>
<h3 id="é€šè¿‡-Vscode-å¯åŠ¨-java-å¹¶-debug"><a href="#é€šè¿‡-Vscode-å¯åŠ¨-java-å¹¶-debug" class="headerlink" title="é€šè¿‡ Vscode å¯åŠ¨ java å¹¶ debug"></a>é€šè¿‡ Vscode å¯åŠ¨ java å¹¶ debug</h3><p>æˆ‘ä»¬é€šè¿‡ vscode æ‰“å¼€ jvm æºç ä¹‹å, å¯ä»¥åœ¨å·¦è¾¹æ‰“å¼€ä¸€ä¸ª debug ç•Œé¢.åœ¨è¿™ä¸ªç•Œé¢ä¸­æœ‰ä¸€ä¸ª<br><code>create a launch.json file</code> çš„æŒ‰é’®, æˆ‘ä»¬ç‚¹å‡»å®ƒ,å°±èƒ½åˆ›å»ºä¸€ä¸ª <code>.vscode/launch.json</code> çš„æ–‡ä»¶.<br>æœ€ç»ˆè¿™ä¸ªæ–‡ä»¶ä¼šé•¿è¿™ä¸ªæ ·å­:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;(lldb) å¯åŠ¨&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppdbg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/your/path/to/jdk/source/build/release/images/jdk/bin/java&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;-Dfile.encoding=UTF-8&quot;</span><span class="punctuation">,</span><span class="string">&quot;-Djava.compiler=NONE&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-classpath&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;/dir/demo/target/classes&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;org.example.Main&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;stopAtEntry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;environment&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;externalConsole&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MIMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lldb&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;targetArchitecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arm64&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p> è¿™é‡Œé¢æœ‰ä¸¤ä¸ªå‚æ•°éœ€è¦ä¿®æ”¹:</p>
<ul>
<li>â€œprogramâ€: ä»£è¡¨ä½ ç¼–è¯‘ç”Ÿæˆçš„ java å‘½ä»¤çš„è·¯å¾„</li>
<li>â€œargsâ€: ä»£è¡¨ java å‘½ä»¤çš„å‚æ•°</li>
</ul>
<blockquote>
<p>å°tips : args å‚æ•°å¯ä»¥åœ¨ JAVA IDE çš„è¾“å‡ºä¸­æ‰¾åˆ°, ä½†éœ€è¦åˆ é™¤å…¶ä¸­æœ‰å…³ IDE çš„ aggent å‚æ•°.</p>
</blockquote>
<p>å‚è€ƒ:<a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/cpp/config-clang-mac#_customize-debugging-with-launchjson">Customize debugging with launch.json</a></p>
<p>é…ç½®å®Œæˆä¹‹å, å°±èƒ½å¼€å§‹ debug äº†.</p>
<h1 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h1><p><a target="_blank" rel="noopener" href="https://openjdk.org/groups/build/doc/building.html">Building the JDK</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/11/23/Create-a-blog/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="åˆ†äº«æˆ‘çš„æ—¥å¸¸æŠ€æœ¯åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez çš„åšå®¢">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/23/Create-a-blog/" class="post-title-link" itemprop="url">åˆ›å»ºä¸€ä¸ªè‡ªå·±çš„åšå®¢</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-23 06:55:58" itemprop="dateCreated datePublished" datetime="2022-11-23T06:55:58+00:00">2022-11-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-28 16:37:53" itemprop="dateModified" datetime="2022-11-28T16:37:53+00:00">2022-11-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Blog/" itemprop="url" rel="index"><span itemprop="name">Blog</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>å‡ å¹´å‰å°±æ­å»ºäº†è‡ªå·±çš„ Github Page, ä½†å½“æ—¶æ­å»ºçš„æ—¶å€™, åšå®¢æ–‡ç« æ²¡æœ‰ä¸Šä¼ åˆ° Github, åªä¸Šä¼ äº†ç”Ÿæˆçš„é™æ€æ–‡ä»¶,è€Œä¸”æ²¡æœ‰è‡ªåŠ¨éƒ¨ç½²çš„èƒ½åŠ›.å‡†å¤‡é‡æ–°æç¬”å†™åšå®¢,å°±é‡æ–°æ­ä¸€å¥—.</p>
<h1 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h1><p>è¿™æ¬¡æ­åšå®¢æœ‰å¦‚ä¸‹æŠ€æœ¯ç›®æ ‡:</p>
<ol>
<li>æ­å»ºå®Œæˆä¹‹å,åªä¾èµ– <strong>æ–‡æœ¬ç¼–è¾‘</strong>+<strong>git</strong> å°±èƒ½å®Œæˆå†™ä½œ, ä¸éœ€è¦å…¶ä»–ä¾èµ–(å°¤å…¶æ˜¯nodeä¾èµ–)</li>
<li>æ–‡æœ¬å†…å®¹ä¸Šä¼  Github ä¹‹å<strong>è‡ªåŠ¨éƒ¨ç½²</strong>.</li>
<li>ä»»ä½•å…¶ä»–äººèƒ½å¤Ÿæ–¹ä¾¿å¤åˆ»è¿™ä¸€å¥—æ–¹æ¡ˆ.</li>
</ol>
<h1 id="å¿«é€Ÿå¤åˆ»æœ¬é¡¹ç›®"><a href="#å¿«é€Ÿå¤åˆ»æœ¬é¡¹ç›®" class="headerlink" title="å¿«é€Ÿå¤åˆ»æœ¬é¡¹ç›®"></a>å¿«é€Ÿå¤åˆ»æœ¬é¡¹ç›®</h1><h2 id="åˆ›å»ºç«™ç‚¹"><a href="#åˆ›å»ºç«™ç‚¹" class="headerlink" title="åˆ›å»ºç«™ç‚¹"></a>åˆ›å»ºç«™ç‚¹</h2><p>å¦‚æœä½ ä¹Ÿæƒ³æ­å»ºä¸€å¥—åšå®¢,è€Œä¸æƒ³æŠ˜è…¾ç¯å¢ƒ,å¯ä»¥ç›´æ¥ Fork <a target="_blank" rel="noopener" href="https://github.com/orezzero/orezzero.github.io">æœ¬é¡¹ç›®</a>,ç„¶åæ”¹åä¸º username.github.io  ï¼Œusername æ˜¯ä½ åœ¨ GitHub ä¸Šçš„ä½¿ç”¨è€…åç§°.<br>å…·ä½“æ­¥éª¤ä¸º:</p>
<ol>
<li>Fork æœ¬é¡¹ç›®,fork æ—¶å¯ä»¥å°† orezzero.github.io æ”¹ä¸º username.github.io  ï¼Œusername æ˜¯ä½ åœ¨ GitHub ä¸Šçš„ä½¿ç”¨è€…åç§°.</li>
<li>è¿›å…¥ä½ çš„ä»“åº“, è¿›å…¥ Action é¡µé¢, ç¡®è®¤ Action åŠŸèƒ½å·²ç»è¢«å¯ç”¨</li>
<li>åˆ é™¤ <code>source/_posts</code> (è¿™é‡Œé¢æ˜¯æˆ‘çš„æ–‡ç« ) é™¤äº† template.md çš„æ–‡ä»¶,åˆ é™¤ <code>sources/images/</code>ä¸­çš„å›¾ç‰‡, ä¿®æ”¹ <code>source/about/index.md</code> ç„¶åæäº¤ä»£ç </li>
<li>ç­‰å¾… Action å®Œæˆ (ç¬¬ä¸€æ¬¡è·‘pages build and deploymentä¼šå¤±è´¥,åˆ«ç®¡ä»–)</li>
<li>åœ¨ä½ çš„ä»“åº“ä¸­è¿›å…¥ Settings &gt; Pages &gt; Sourceï¼Œå¹¶å°† branch æ”¹ä¸º gh-pagesã€‚(åœ¨ç¬¬ä¸€æ¬¡æäº¤ä»£ç ä¹‹å‰,è¿™ä¸ªé…ç½®æ— æ³•ä¿®æ”¹)</li>
<li>æ‰‹åŠ¨è§¦å‘ Action ä¸­çš„ Pages action æˆ–è€…æäº¤ä¸€ä¸ªä¿®æ”¹è§¦å‘ Action,ç­‰å¾… Action å®Œæˆ</li>
<li>è®¿é—® username.github.io å°±èƒ½çœ‹åˆ°ä½ çš„ç«™ç‚¹äº†</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://easyit-blog.github.io/">https://easyit-blog.github.io/</a> å°±æ˜¯è¿™ä¹ˆåˆ›å»ºå‡ºæ¥çš„.</p>
<blockquote>
<p>æœ¬é¡¹ç›®æœ‰ä¸€äº›åŒºåˆ«äºåŸç”Ÿ Next ä¸»é¢˜çš„å®šåˆ¶åŒ–é…ç½®, å¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="https://github.com/OrezzerO/orezzero.github.io/pull/1">PR Modify theme settings #1</a> æ¥è‡ªå®šä¹‰ä½ çš„ä¸»é¢˜.</p>
</blockquote>
<h2 id="å†™ä½œ"><a href="#å†™ä½œ" class="headerlink" title="å†™ä½œ"></a>å†™ä½œ</h2><p>åœ¨ <code>source/_posts</code> æ–‡ä»¶å¤¹ä¸­åˆ›å»º markdown æ–‡ä»¶. Hexo å¯¹äº md çš„æ ¼å¼æœ‰ä¸€å®šè¦æ±‚,éœ€è¦ç”¨è¿™ç§æ ¼å¼å¼€å¤´:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: åˆ›å»ºä¸€ä¸ªè‡ªå·±çš„åšå®¢</span><br><span class="line">date: 2022-11-23 06:55:58</span><br><span class="line">tags:</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå¤´éƒ¨åé¢å°±å¯ä»¥ä¹¦å†™æ­£æ–‡äº†.</p>
<h1 id="æŠ€æœ¯ç»†èŠ‚"><a href="#æŠ€æœ¯ç»†èŠ‚" class="headerlink" title="æŠ€æœ¯ç»†èŠ‚"></a>æŠ€æœ¯ç»†èŠ‚</h1><h2 id="å¦‚ä½•ä»é›¶å¼€å§‹æ­å»º-Hexo"><a href="#å¦‚ä½•ä»é›¶å¼€å§‹æ­å»º-Hexo" class="headerlink" title="å¦‚ä½•ä»é›¶å¼€å§‹æ­å»º Hexo"></a>å¦‚ä½•ä»é›¶å¼€å§‹æ­å»º Hexo</h2><p>æˆ‘ä½¿ç”¨äº† Docker æ¥åˆå§‹åŒ–é¡¹ç›®. é¦–å…ˆæˆ‘é€šè¿‡ <a target="_blank" rel="noopener" href="https://github.com/OrezzerO/orezzero.github.io/blob/main/Dockerfile">Dockerfile</a> åˆ›å»ºäº†ä¸€ä¸ª Hexo é•œåƒ, å¯åŠ¨è¿™ä¸ªé•œåƒå°±ä¼šæ„å»º Hexo çš„åŸºæœ¬ç¯å¢ƒåˆ° &#x2F;blog ç›®å½•ä¸‹. ç„¶åæˆ‘å°†å®¹å™¨ä¸­çš„ &#x2F;blog ç›®å½•æ‹·è´å‡ºæ¥. åŸºæœ¬ç¯å¢ƒå°±æ­å»ºå¥½äº†.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ„å»º docker é•œåƒ</span></span><br><span class="line">docker build -t hexo .</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯åŠ¨ docker å®¹å™¨</span></span><br><span class="line">docker run --name hexo -d  -P hexo</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># æ‹·è´</span></span></span><br><span class="line">docker cp hexo:/blog ./</span><br></pre></td></tr></table></figure>


<h2 id="æœ¬åœ°å¯åŠ¨-Hexo-Server"><a href="#æœ¬åœ°å¯åŠ¨-Hexo-Server" class="headerlink" title="æœ¬åœ°å¯åŠ¨ Hexo Server"></a>æœ¬åœ°å¯åŠ¨ Hexo Server</h2><p>æŒ‰ä¸ŠèŠ‚æ„é€ å¥½é•œåƒä¹‹å, ä½¿ç”¨ docker-compose é…ç½®æ–‡ä»¶å¯åŠ¨ docker-compose å³å¯.</p>
<blockquote>
<p>éœ€è¦å°†é…ç½®æ–‡ä»¶æ”¾åœ¨ hexo ç›®å½•, å¹¶åœ¨è¿™ä¸ªç›®å½•æ‰§è¡Œ docker compose å‘½ä»¤.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯åŠ¨ docker compose</span></span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å…³é—­ docker compose</span></span><br><span class="line">docker-compose down</span><br></pre></td></tr></table></figure>


<h2 id="è‡ªåŠ¨éƒ¨ç½²"><a href="#è‡ªåŠ¨éƒ¨ç½²" class="headerlink" title="è‡ªåŠ¨éƒ¨ç½²"></a>è‡ªåŠ¨éƒ¨ç½²</h2><p>è‡ªåŠ¨éƒ¨ç½²å®Œå…¨ç…§æ¬äº†å®˜ç½‘çš„ <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/github-pages">åœ¨ GitHub Pages ä¸Šéƒ¨ç½² Hexo</a> ååˆ†ç®€å•.</p>
<blockquote>
<p>è‡ªåŠ¨éƒ¨ç½²åœ¨ç½‘ä¸Šæœ‰å¾ˆå¤šæ•™ç¨‹, ä½†æ˜¯è¿™äº›æ•™ç¨‹éƒ½æ²¡æœ‰å®˜ç½‘çš„ç®€å•å¯é .</p>
</blockquote>
<h2 id="é‡åˆ°çš„å‘"><a href="#é‡åˆ°çš„å‘" class="headerlink" title="é‡åˆ°çš„å‘"></a>é‡åˆ°çš„å‘</h2><ol>
<li>ä¸»é¢˜æ–‡ä»¶å¤¹<code>themes/next</code>æ²¡èƒ½æˆåŠŸä¸Šä¼ åˆ° github ä¸Š,å¯¼è‡´ç¼–è¯‘ä¸å‡ºé™æ€é¡µé¢.</li>
</ol>
<h1 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h1><p><a target="_blank" rel="noopener" href="https://theme-next.js.org/docs/getting-started/">Next ä¸»é¢˜æ–‡æ¡£ç«™</a>: è¿™ä¸ªç½‘ç«™æ¯”è¾ƒé‡è¦,å¾ˆå¤šé…ç½®å¯ä»¥å‚è€ƒè¿™é‡Œçš„æ–‡æ¡£.<br><a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo å®˜ç½‘</a><br><a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/github-pages">åœ¨ GitHub Pages ä¸Šéƒ¨ç½² Hexo</a><br><a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/setup">å»ºç«™</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/overview/page/2/">2</a><a class="extend next" rel="next" href="/overview/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Orez"
      src="https://avatars.githubusercontent.com/u/13081689?v=4">
  <p class="site-author-name" itemprop="name">Orez</p>
  <div class="site-description" itemprop="description">åˆ†äº«æˆ‘çš„æ—¥å¸¸æŠ€æœ¯åšå®¢</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/OrezzerO" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;OrezzerO" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:orezzero@163.com" title="E-Mail â†’ mailto:orezzero@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Orez</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
