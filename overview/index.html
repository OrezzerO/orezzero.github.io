<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"orezzero.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="分享我的日常技术博客">
<meta property="og:type" content="website">
<meta property="og:title" content="Orez 的博客">
<meta property="og:url" content="http://orezzero.github.io/overview/index.html">
<meta property="og:site_name" content="Orez 的博客">
<meta property="og:description" content="分享我的日常技术博客">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Orez">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://orezzero.github.io/overview/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Orez 的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Orez 的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-overview">

    <a href="/overview" rel="section"><i class="fa fa-eye fa-fw"></i>overview</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/OrezzerO" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2024/07/25/print_native_with_java_agent/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="分享我的日常技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/25/print_native_with_java_agent/" class="post-title-link" itemprop="url">使用 JavaAgent 打印所有 Native 调用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-07-25 22:05:03" itemprop="dateCreated datePublished" datetime="2024-07-25T22:05:03+00:00">2024-07-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>我打算对 Java 网络的底层进行拆解，将 Java 网络操作与系统调用关联起来，探究那些在公众号上频繁出现的知识点的实际运作方式。通过 strace 虽能追踪到系统调用，然而却难以清晰辨别具体是由哪行 Java 代码发起的系统调用，这中间缺失了一层 Native 层。因此，我期望把调用过程中的 Native 方法全部打印出来。</p>
<h2 id="原理解析"><a href="#原理解析" class="headerlink" title="原理解析"></a>原理解析</h2><p>众所周知，Java Agent 能够用于实现字节码增强。但 Java Native 方法不存在字节码，所以无法直接进行字节码增强。<br>我们需要采取迂回的策略：</p>
<ol>
<li>对 Native 方法进行重命名，并添加一个前缀。</li>
<li>构建一个与之前 Native 方法名称相同的普通方法。</li>
<li>借助字节码增强这个普通方法，再由该普通方法去调用 Native 方法。<br>例如，假设原本的 Native 方法名为 intern ，我们可以将其重命名为 enhance_intern ，然后创建一个名为 intern 的普通方法，在字节码增强这个新创建的普通方法后，由它来调用 enhance_intern 。这种方式就巧妙地解决了 Native 方法无法直接字节码增强的问题。</li>
</ol>
<p>举个具体🌰:<br>修改前方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">intern</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p>修改后:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">enhance_intern</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">intern</span><span class="params">()</span>&#123;</span><br><span class="line">  enhance_intern();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实践细节"><a href="#实践细节" class="headerlink" title="实践细节"></a>实践细节</h2><p>Native 方法名一旦更改，其与具体 Native 实现的映射关系便会遭到破坏，此时就需要借助 java.lang.instrument.Instrumentation#setNativeMethodPrefix 来重新构建映射关系。这个方法的作用在于，当 Native 方法无法被找到时，通过去除前缀再次尝试寻找。</p>
<p>然而，JVM 默认并不支持设置 Native 方法前缀，需要在 JavaAgent 的 manifest 中，设定 Can-Set-Native-Method-Prefix: true 。</p>
<h2 id="看看代码"><a href="#看看代码" class="headerlink" title="看看代码"></a>看看代码</h2><p>实现这么一个 Java Agent 只需要两个类, 那就直接上代码和注释了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Premain</span> &#123;</span><br><span class="line">    <span class="comment">// premain 方法，在 Java 代理的预初始化阶段被调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">premain</span><span class="params">(String args, Instrumentation inst)</span> &#123;</span><br><span class="line">        <span class="comment">// 调用 recoverMain 方法进行相关操作</span></span><br><span class="line">        recoverMain(inst);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// agentmain 方法，在 Java 代理的启动阶段被调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String args, Instrumentation inst)</span> &#123;</span><br><span class="line">        <span class="comment">// 调用 recoverMain 方法进行相关操作</span></span><br><span class="line">        recoverMain(inst);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// recoverMain 方法，用于执行恢复主流程的操作</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">recoverMain</span><span class="params">(Instrumentation inst)</span> &#123;</span><br><span class="line">        <span class="comment">// 输出 inst 是否支持本地方法前缀</span></span><br><span class="line">        System.out.println(inst.isNativeMethodPrefixSupported());</span><br><span class="line">        <span class="comment">// 创建 NativeWrappingClassFileTransformer 类的对象</span></span><br><span class="line">        <span class="type">NativeWrappingClassFileTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeWrappingClassFileTransformer</span>();</span><br><span class="line">        <span class="comment">// 向 inst 添加转换器，并设置为可以重转换</span></span><br><span class="line">        inst.addTransformer(transformer,<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 为 inst 设置本地方法前缀</span></span><br><span class="line">        inst.setNativeMethodPrefix(transformer, NativeWrappingClassFileTransformer.PREFIX);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NativeWrappingClassFileTransformer</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义一个表示 BlockHound 运行时类型的 Type 对象</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Type</span> <span class="variable">BLOCK_HOUND_RUNTIME_TYPE</span> <span class="operator">=</span> Type.getType(<span class="string">&quot;Lreactor/blockhound/BlockHoundRuntime;&quot;</span>);</span><br><span class="line">    <span class="comment">// 定义本地方法的前缀字符串</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX</span> <span class="operator">=</span> <span class="string">&quot;$$BlockHound$$_&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造函数</span></span><br><span class="line">    NativeWrappingClassFileTransformer() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实现 ClassFileTransformer 接口的 transform 方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loader          类加载器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> className       类名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classBeingRedefined 正在被重定义的类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> protectionDomain 保护域</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classfileBuffer 类文件缓冲区</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 转换后的字节数组，如果不进行转换则返回 null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] transform(</span><br><span class="line">            ClassLoader loader,</span><br><span class="line">            String className,</span><br><span class="line">            Class&lt;?&gt; classBeingRedefined,</span><br><span class="line">            ProtectionDomain protectionDomain,</span><br><span class="line">            <span class="type">byte</span>[] classfileBuffer</span><br><span class="line">    ) &#123;</span><br><span class="line"><span class="comment">//        if (!className.startsWith(&quot;java/net/&quot;)) &#123;</span></span><br><span class="line"><span class="comment">//            return null;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建 ClassReader 对象来读取类文件缓冲区</span></span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">cr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(classfileBuffer);</span><br><span class="line">        <span class="comment">// 创建 ClassWriter 对象用于写入转换后的类</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(cr, ClassWriter.COMPUTE_MAXS);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 接受 NativeWrappingClassVisitor 进行类的访问和转换</span></span><br><span class="line">            cr.accept(<span class="keyword">new</span> <span class="title class_">NativeWrappingClassVisitor</span>(cw, className), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取转换后的字节数组</span></span><br><span class="line">            classfileBuffer = cw.toByteArray();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="comment">// 打印异常堆栈跟踪</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">// 抛出异常</span></span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回转换后的类文件字节数组</span></span><br><span class="line">        <span class="keyword">return</span> classfileBuffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内部静态类 NativeWrappingClassVisitor，继承自 ClassVisitor</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">NativeWrappingClassVisitor</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 存储类名</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String className;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造函数</span></span><br><span class="line">        NativeWrappingClassVisitor(ClassVisitor cw, String internalClassName) &#123;</span><br><span class="line">            <span class="comment">// 调用父类构造函数</span></span><br><span class="line">            <span class="built_in">super</span>(ASM7, cw);</span><br><span class="line">            <span class="comment">// 初始化类名</span></span><br><span class="line">            <span class="built_in">this</span>.className = internalClassName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 重写 visitMethod 方法，处理方法访问</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> access          方法的访问标志</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> name            方法名</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> descriptor      方法描述符</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> signature       方法签名</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> exceptions      方法抛出的异常</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> 方法访问器</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> MethodVisitor <span class="title function_">visitMethod</span><span class="params">(<span class="type">int</span> access,</span></span><br><span class="line"><span class="params">                                         String name,</span></span><br><span class="line"><span class="params">                                         String descriptor,</span></span><br><span class="line"><span class="params">                                         String signature,</span></span><br><span class="line"><span class="params">                                         String[] exceptions)</span> &#123;</span><br><span class="line">            <span class="comment">// 如果方法不是本地方法</span></span><br><span class="line">            <span class="keyword">if</span> ((access &amp; ACC_NATIVE) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 调用父类的 visitMethod 方法</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.visitMethod(access, name, descriptor, signature, exceptions);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 访问修改后的本地方法</span></span><br><span class="line">            <span class="built_in">super</span>.visitMethod(</span><br><span class="line">                    ACC_NATIVE | ACC_PRIVATE | ACC_FINAL | (access &amp; ACC_STATIC),</span><br><span class="line">                    PREFIX + name,</span><br><span class="line">                    descriptor,</span><br><span class="line">                    signature,</span><br><span class="line">                    exceptions</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 访问原始的非本地方法</span></span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">delegatingMethodVisitor</span> <span class="operator">=</span> <span class="built_in">super</span>.visitMethod(</span><br><span class="line">                    access &amp; ~ACC_NATIVE, name, descriptor, signature, exceptions);</span><br><span class="line">            delegatingMethodVisitor.visitCode();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回自定义的方法访问器</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MethodVisitor</span>(ASM7, delegatingMethodVisitor) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitEnd</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 添加打印语句打印方法名</span></span><br><span class="line">                    visitFieldInsn(GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">                    visitLdcInsn(<span class="string">&quot;Method called: &quot;</span> + className + <span class="string">&quot;.&quot;</span> + name);</span><br><span class="line">                    visitMethodInsn(INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    <span class="type">Type</span> <span class="variable">returnType</span> <span class="operator">=</span> Type.getReturnType(descriptor);</span><br><span class="line">                    Type[] argumentTypes = Type.getArgumentTypes(descriptor);</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">isStatic</span> <span class="operator">=</span> (access &amp; ACC_STATIC)!= <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">if</span> (!isStatic) &#123;</span><br><span class="line">                        visitVarInsn(ALOAD, <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> isStatic? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">for</span> (Type argumentType : argumentTypes) &#123;</span><br><span class="line">                        visitVarInsn(argumentType.getOpcode(ILOAD), index);</span><br><span class="line">                        index += argumentType.getSize();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    visitMethodInsn(</span><br><span class="line">                            isStatic? INVOKESTATIC : INVOKESPECIAL,</span><br><span class="line">                            className,</span><br><span class="line">                            PREFIX + name,</span><br><span class="line">                            descriptor,</span><br><span class="line">                            <span class="literal">false</span></span><br><span class="line">                    );</span><br><span class="line"></span><br><span class="line">                    visitInsn(returnType.getOpcode(IRETURN));</span><br><span class="line">                    visitMaxs(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                    <span class="built_in">super</span>.visitEnd();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/12/19/skywalking_java_api/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="分享我的日常技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/19/skywalking_java_api/" class="post-title-link" itemprop="url">SkyWalking-java 简介</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-19 16:29:59" itemprop="dateCreated datePublished" datetime="2022-12-19T16:29:59+00:00">2022-12-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>最近在调研跨线程 trace, 调研了跨线程 skywalking-java (skywalking 的 java 客户端) 的跨线程 trace 实现.</p>
<p>本文的内容包括:</p>
<ol>
<li>skywalking-java api 的简单使用</li>
<li>skywalking-java api 重要概念及对应的实现</li>
<li>skywalking-java 跨线程 trace 是如何实现的</li>
<li>skywalking 的瓶颈以及我遇到的问题.</li>
</ol>
<p>前置知识:</p>
<h1 id="Skywalking-java-api-的简单使用"><a href="#Skywalking-java-api-的简单使用" class="headerlink" title="Skywalking-java api 的简单使用"></a>Skywalking-java api 的简单使用</h1><h2 id="普通用户API"><a href="#普通用户API" class="headerlink" title="普通用户API"></a>普通用户API</h2><p>官方文档中 <a target="_blank" rel="noopener" href="https://skywalking.apache.org/docs/skywalking-java/v8.13.0/en/setup/service-agent/java-agent/application-toolkit-trace/">Tracing APIs</a> 一节中有用户API详细的说明. 简单来说,加一个 <code>@Tracer</code> 注解就能完成一般用户的需求:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Trace</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">methodYouWantToTrace</span><span class="params">(String param1, String param2)</span> &#123;</span><br><span class="line">    <span class="comment">// ActiveSpan.setOperationName(&quot;Customize your own operation name, if this is an entry span, this would be an endpoint name&quot;);</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="中间件用户-API"><a href="#中间件用户-API" class="headerlink" title="中间件用户 API"></a>中间件用户 API</h2><p>对于普通用户来说,上面这个接口已经够用了, 但对于中间件用户来说, 要需要深入看下非切面的API:</p>
<h3 id="Span-分类"><a href="#Span-分类" class="headerlink" title="Span 分类"></a>Span 分类</h3><p><a target="_blank" rel="noopener" href="https://skywalking.apache.org/docs/skywalking-java/v8.13.0/en/setup/service-agent/java-agent/java-plugin-development-guide/">Skywlking 中将 Span 分为三类</a> :</p>
<ol>
<li><strong>EntrySpan</strong>: 代表一个服务提供者.</li>
<li><strong>LocalSpan</strong>: 代表一个普通方法.注意,它既不代表一个服务提供者, 也不代表服务消费者.</li>
<li><strong>ExitSpan</strong>: 代表一份服务消费者</li>
</ol>
<p>创建上面三个 Span 的方法分别为 <a target="_blank" rel="noopener" href="https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/context/ContextManager.java">ContextManager.java</a> 中的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> AbstractSpan <span class="title function_">createEntrySpan</span><span class="params">(String endpointName, ContextCarrier carrier)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> AbstractSpan <span class="title function_">createLocalSpan</span><span class="params">(String endpointName)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> AbstractSpan <span class="title function_">createExitSpan</span><span class="params">(String endpointName, ContextCarrier carrier, String remotePeer)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>上文中 <code>@Tracer</code> 注解生成的就是 LocalSpan</p>
</blockquote>
<h3 id="跨应用传递"><a href="#跨应用传递" class="headerlink" title="跨应用传递"></a>跨应用传递</h3><p>APM 需要将不同应用间的 Span 串联起来, 通常来说是在请求中加上 APM 相关的信息来实现的.<br>Skywalking 的实现直接看官方文档 <a target="_blank" rel="noopener" href="https://skywalking.apache.org/docs/skywalking-java/v8.13.0/en/setup/service-agent/java-agent/java-plugin-development-guide/#contextcarrier">ContextCarrier</a></p>
<h3 id="Span-的操作"><a href="#Span-的操作" class="headerlink" title="Span 的操作"></a>Span 的操作</h3><p>可以通过 <a target="_blank" rel="noopener" href="https://skywalking.apache.org/docs/skywalking-java/v8.13.0/en/setup/service-agent/java-agent/java-plugin-development-guide/#abstractspan">AbstractSpan 接口</a> 来操作 Span ,向其中添加信息. 可以通过 <a target="_blank" rel="noopener" href="https://skywalking.apache.org/docs/skywalking-java/v8.13.0/en/setup/service-agent/java-agent/java-plugin-development-guide/#abstractspan">Async Span APIs</a> 来操控异步 Span.</p>
<h3 id="举个例子"><a href="#举个例子" class="headerlink" title="举个例子"></a>举个例子</h3><p>SkyWalking-java 使用 java agent 在运行时动态修改字节码来做到埋点的注入. 不同的中间件需要实现一个 SkyWalking 插件才能接入. 这部分内容可以参考 <a href="https://orezzero.github.io/2022/12/08/bytebuddy_agent_skywalking/">Byte Buddy Agent 初探–以 SkyWalking-java 为例</a> 中 SkyWalking-java 简要分析 一节.</p>
<p>客户端埋点代码包含如下逻辑:</p>
<ol>
<li>获取请求信息</li>
<li>构造 ExitSpan</li>
<li>向请求中注入 SkyWalking header</li>
</ol>
<p>服务端包含如下逻辑:</p>
<ol>
<li>获取请求信息</li>
<li>构造 EntrySpan</li>
<li>向请求中的 SkyWalking header 提取出来, 注入到本地的 <code>ContextCarrier</code> 中</li>
</ol>
<p>可以参考这两个文件: <a target="_blank" rel="noopener" href="https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-sdk-plugin/sofarpc-plugin/src/main/java/org/apache/skywalking/apm/plugin/sofarpc/SofaRpcConsumerInterceptor.java">SOFA RPC 客户端埋点</a> 和 <a target="_blank" rel="noopener" href="https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-sdk-plugin/sofarpc-plugin/src/main/java/org/apache/skywalking/apm/plugin/sofarpc/SofaRpcProviderInterceptor.java">SOFA RPC 服务端埋点</a></p>
<h1 id="skywalking-java-api-重要概念及对应的实现"><a href="#skywalking-java-api-重要概念及对应的实现" class="headerlink" title="skywalking-java api 重要概念及对应的实现"></a>skywalking-java api 重要概念及对应的实现</h1><h2 id="Trace-相关概念"><a href="#Trace-相关概念" class="headerlink" title="Trace 相关概念"></a>Trace 相关概念</h2><p><a target="_blank" rel="noopener" href="https://skywalking.apache.org/docs/main/v9.2.0/en/protocols/trace-data-protocol-v3/">Trace Data Protocol v3 </a> 描述了SkyWalking 客户端和服务端之间的通信协议. 其中将链路追踪划分为三个层次:</p>
<ol>
<li>Trace: 代表整个链路</li>
<li>Segment: 代表一个进程(应用)中所有的 Span 集合</li>
<li>Span: 代表一个操作,比如读取一次DB</li>
</ol>
<p>分别看下这三个对象的唯一标识是怎么产生的, 就能比较好理解他们分别代表什么维度:</p>
<p><strong>Trace Id</strong> <br/><br>Trace Id 通过 <code>GlobalIdGenerator.generate()</code> 产生,包含三个部分:</p>
<ol>
<li>PROCESS_ID: 代表应用程序实例 ID</li>
<li><code>Thread.currentThread().getId()</code>: 代表线程 ID</li>
<li>THREAD_ID_SEQUENCE: 包含两个部分 1) 以毫秒记的时间戳 2) 线程级别的 0 到 9999 的序号</li>
</ol>
<p>可以看出, Trace Id 是 实例维度+线程维度+毫秒维度+序号维度 组成的.</p>
<p><strong>注意</strong>: Trace Id 是会通过请求传递到上游服务的,如果下游传递了 Trace Id 给上游, 上游会继续使用这个 Trace Id</p>
<p><strong>Segment Id</strong> <br/><br>Segment Id 的生成算法和 Trace Id 是一样的.</p>
<p><strong>Span Id</strong> <br/><br>SpanId 是一个在 <code>TracingContext</code> 中维护的,从 0 开始的序列.</p>
<p>注意: 这里的 <code>TracingContext</code> 是一个 ThreadLocal 变量, 生命周期和一个 Segment 想通.</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p><strong>一些类和数据结构</strong></p>
<ol>
<li><strong>Span</strong>: 保存了 spanId,parentSpanId,tags 等标签, 用来表示一个操作.</li>
<li><strong>Segment</strong>: 保存了 traceSegmentId,relatedGlobalTraceId, Span 数组 等信息, 用来表示一组同线程同 traceId 的 Span 集合</li>
<li><strong>TracingContext</strong>: 用来操作 Segment 和 Span 的工具类,持有 TraceSegment 引用, 维护了一个 <code>List&lt;Span&gt;</code>  表示的栈. TracingContext 和单个线程对应, 单个TracingContext中只保存该线程对应的 Segment 和 Span.</li>
<li><strong>ContextManager</strong>: TracingContext 的控制类, 持有 TracingContext 的 ThreadLocal 引用. ContextManager 中的静态方法会</li>
</ol>
<p>这是一个比较简单模式: 用户使用 <code>ContextManager</code> 来控制 <code>TracingContext</code>. <code>TracingContext</code> 来生成 <code>Segment</code> 和 <code>Span</code> 对象, 并将他们组合到一起.</p>
<!-- todo 看看要不要举个例子 -->


<h1 id="跨线程-Trace-的实现"><a href="#跨线程-Trace-的实现" class="headerlink" title="跨线程 Trace 的实现"></a>跨线程 Trace 的实现</h1><p>跨线程Trace 分为两种情况:</p>
<ol>
<li>单个 Span 跨线程. 也就是说, 同一个Span 的 <code>start</code> 和 <code>stop</code> 操作在不同的线程中</li>
<li>整体 Trace 跨线程. 也就是说”父子Span”在不同的线程中.</li>
</ol>
<p>我们分别讨论这两种情况.</p>
<h2 id="单-Span-跨线程"><a href="#单-Span-跨线程" class="headerlink" title="单 Span 跨线程"></a>单 Span 跨线程</h2><p>单 Span 跨线程是指同一个Span 的 <code>start</code> 和 <code>stop</code> 操作在不同的线程中. 直接上代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AbstractSpan</span> <span class="variable">mySpan</span> <span class="operator">=</span> ContextManager.createEntrySpan(<span class="string">&quot;mySpan&quot;</span>);</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 3. Propagate the span to any other thread.</span></span><br><span class="line">            <span class="comment">// 4. Once the above steps are all set, call #asyncFinish in any thread.</span></span><br><span class="line">            mySpan.asyncFinish();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 1. Call #prepareForAsync in the original context.</span></span><br><span class="line">        mySpan.prepareForAsync();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable).start();</span><br><span class="line">        <span class="comment">// 2. Run ContextManager#stopSpan in the original context when your job in the current thread is complete.</span></span><br><span class="line">        ContextManager.stopSpan();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面这段代码, 在Main线程中创建了了一个 Span ,但在子线程中才结束这个 Span. 整个过程如下:</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>整个单 Span 跨线程的过程分为四个阶段,我们分别分析:</p>
<h4 id="在原始上下文中调用-prepareForAsync-方法"><a href="#在原始上下文中调用-prepareForAsync-方法" class="headerlink" title="在原始上下文中调用 prepareForAsync 方法"></a>在原始上下文中调用 prepareForAsync 方法</h4><p><code>prepareForAsync</code> 方法是 Span 的方法. 它会标记这个 Span 处于异步模式, 同时在方法内部调用 <code>ContextManager#awaitFinishAsync</code> 方法. 上下文中会通过<code>asyncSpanCounter</code>字段记录当前上下文有多少 Span 处于异步模式中.</p>
<h4 id="在原始方法中调用-stopSpan-方法"><a href="#在原始方法中调用-stopSpan-方法" class="headerlink" title="在原始方法中调用 stopSpan 方法"></a>在原始方法中调用 stopSpan 方法</h4><p>由于上一步调用了 <code>prepareForAsync</code>, <code>stopSpan</code> 方法不会直接结束,而是<strong>先</strong>判断当前上下文中<strong>asyncSpanCounter</strong>是否为0.为0的话结束,非0的话不结束.</p>
<h4 id="将-Span-对象传递到其他线程中"><a href="#将-Span-对象传递到其他线程中" class="headerlink" title="将 Span 对象传递到其他线程中"></a>将 Span 对象传递到其他线程中</h4><p>可以使用闭包传递,这很好理解,不做说明了.</p>
<h3 id="在子线程中嗲用-asyncFinish"><a href="#在子线程中嗲用-asyncFinish" class="headerlink" title="在子线程中嗲用 asyncFinish"></a>在子线程中嗲用 asyncFinish</h3><p>调用 asyncFinish 会通知该 Span 的上下文, 减少<code>asyncSpanCounter</code>数量.并且再次尝试结束Span,如果此时<strong>asyncSpanCounter</strong>为0,就结束Span,否则不结束.</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在单个 Span 跨线程的场景下, 跨线程的 Span 还是原来的对象, 它持有原来线程 <code>Context</code> 的引用, traceId 等相关信息都没有发生改变.</p>
<h2 id="整体-Trace-跨线程"><a href="#整体-Trace-跨线程" class="headerlink" title="整体 Trace 跨线程"></a>整体 Trace 跨线程</h2><p>整体 Trace 跨线程是说”父子Span”在不同的线程中.我们直接看代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AbstractSpan</span> <span class="variable">mySpan</span> <span class="operator">=</span> ContextManager.createExitSpan(<span class="string">&quot;parent&quot;</span>, <span class="string">&quot;childThread&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">RunnableWrapper</span>(runnable)).start();</span><br><span class="line">        ContextManager.stopSpan(mySpan);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RunnableWrapper</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>, EnhancedInstance &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Object skyWalkingDynamicField;</span><br><span class="line">        <span class="keyword">private</span> Runnable runnable;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">RunnableWrapper</span><span class="params">(Runnable runnable)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ContextManager.isActive()) &#123;</span><br><span class="line">                setSkyWalkingDynamicField(ContextManager.capture());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.runnable = runnable;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">AbstractSpan</span> <span class="variable">span</span> <span class="operator">=</span> ContextManager.createLocalSpan(<span class="string">&quot;runnable.run&quot;</span>);</span><br><span class="line">            span.setComponent(ComponentsDefine.JDK_THREADING);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">storedField</span> <span class="operator">=</span> getSkyWalkingDynamicField();</span><br><span class="line">            <span class="keyword">if</span> (storedField != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">ContextSnapshot</span> <span class="variable">contextSnapshot</span> <span class="operator">=</span> (ContextSnapshot) storedField;</span><br><span class="line">                ContextManager.continued(contextSnapshot);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                runnable.run();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                ContextManager.stopSpan();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">getSkyWalkingDynamicField</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> skyWalkingDynamicField;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSkyWalkingDynamicField</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.skyWalkingDynamicField = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码是将<code>RunnableInstrumentation</code> 的代码增强逻辑展开后得来的(有简化).整体 Trace 跨线程主有两个主要步骤:</p>
<ol>
<li>创建 RunnableWrapper 对象的时候, 在<strong>构造函数</strong>中,将当前线程的 <code>ContextSnapshot</code> 设置到 RunnableWrapper 的 skyWalkingDynamicField对象中.</li>
<li>在子线程执行 <code>run</code> 方法时, 创建一个新的 <code>Span</code>, 并将父线程的 <code>contextSnapshot</code> 当做参数传递给 <code>continued</code> 方法.</li>
</ol>
<p>ContextSnapshot 的构造如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ContextSnapshot <span class="title function_">capture</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ContextSnapshot</span> <span class="variable">snapshot</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContextSnapshot</span>(</span><br><span class="line">        segment.getTraceSegmentId(),  <span class="comment">// segmentId</span></span><br><span class="line">        activeSpan().getSpanId(),     <span class="comment">// spanId</span></span><br><span class="line">        getPrimaryTraceId(),          <span class="comment">// traceId</span></span><br><span class="line">        primaryEndpoint.getName(),    <span class="comment">// parentEndpoint</span></span><br><span class="line">        <span class="built_in">this</span>.correlationContext,     </span><br><span class="line">        <span class="built_in">this</span>.extensionContext</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> snapshot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>continued</code> 方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Continue the context from the given snapshot of parent thread.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> snapshot from &#123;<span class="doctag">@link</span> #capture()&#125; in the parent thread. Ref to &#123;<span class="doctag">@link</span> AbstractTracerContext#continued(ContextSnapshot)&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">continued</span><span class="params">(ContextSnapshot snapshot)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (snapshot.isValid()) &#123;</span><br><span class="line">        <span class="type">TraceSegmentRef</span> <span class="variable">segmentRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TraceSegmentRef</span>(snapshot);</span><br><span class="line">        <span class="built_in">this</span>.segment.ref(segmentRef);</span><br><span class="line">        <span class="built_in">this</span>.activeSpan().ref(segmentRef);</span><br><span class="line">        <span class="built_in">this</span>.segment.relatedGlobalTrace(snapshot.getTraceId());</span><br><span class="line">        <span class="built_in">this</span>.correlationContext.continued(snapshot);</span><br><span class="line">        <span class="built_in">this</span>.extensionContext.continued(snapshot);</span><br><span class="line">        <span class="built_in">this</span>.extensionContext.handle(<span class="built_in">this</span>.activeSpan());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>continued</code> 方法通过 <code>ContextSnapshot</code> 构造 <code>TraceSegmentRef</code>,让当前线程的 Segment 和 Span 引用到 <code>TraceSegmentRef</code>, 从而建立起了两个线程的联系. 当这两个线程的 Segment 都完成之后, 就会被发送到 SkyWalking 服务端, 服务端可以根据这两个 Segment 之间的关系建立起联系.</p>
<h1 id="我遇到的问题"><a href="#我遇到的问题" class="headerlink" title="我遇到的问题"></a>我遇到的问题</h1><p>我再做一个精细化耗时分析的程序,它可以实现跨线程的精细化耗时分析. 举个RPC的例子: 它会记录 IO 线程中, 请求到达的时间&#x2F;IO 线程处理完成请求的时间; 然后将这些数据传递给业务线程, 业务线程继续记录 RPC 内部处理时间, 业务耗时等.</p>
<p>现在遇到的<strong>问题</strong>是:  在多层线程池嵌套的场景, 如何确定这个 Trace 的结束时间?</p>
<p>想象这么一个场景:<br>调用一个 RPC 接口, 这个 RPC 接口会再另外开启 5 条线程执行批量数据库操作,然后不等待数据库操作返会结果, RPC 提前返会.</p>
<p>在这种场景下,供涉及七条线程: IO 线程, RPC 业务线程, 批量操作5条线程.这七条线程只知道自己的 Span 状态, 无法得知其他 Span 的状态, 也就没办法知道整个事务什么时候结束(本线程事务结束的时候, 并不清楚其他线程的事务是否结束).</p>
<p>对于 SkyWalking, 它没有纠结整体事务有没有结束. 每个线程只关心自己的 Segment 是否结束, 结束就上报给 SkyWalking 服务端. 在上面这个例子中, 这七条线程的 Segment 是有关系的, skyWalking 可以根据这些关系, 再将他们组合起来, 统一展示.</p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a target="_blank" rel="noopener" href="https://opentracing.io/specification/">https://opentracing.io/specification/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/12/15/transmittable-thread-local_analyze/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="分享我的日常技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/15/transmittable-thread-local_analyze/" class="post-title-link" itemprop="url">Alibaba transmittable-thread-local 分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-15 15:11:25" itemprop="dateCreated datePublished" datetime="2022-12-15T15:11:25+00:00">2022-12-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Alibaba-transmittable-thread-local-是什么"><a href="#Alibaba-transmittable-thread-local-是什么" class="headerlink" title="Alibaba transmittable-thread-local 是什么"></a>Alibaba transmittable-thread-local 是什么</h1><p><code>TransmittableThreadLocal(TTL)</code>：在使用线程池等会池化复用线程的执行组件情况下，提供ThreadLocal值的传递功能，解决异步执行时上下文传递的问题。</p>
<h1 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h1><p>网上有很多 TTL 的原理分析&#x2F;实践. TTL 作者在 <a target="_blank" rel="noopener" href="https://github.com/alibaba/transmittable-thread-local/issues/123">这里</a> 做了一个汇总. 我这篇文章就不深入细节展开了, 只写一点我自己对 TTL 笼统的理解.</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><h2 id="InheritableThreadLocal-原理"><a href="#InheritableThreadLocal-原理" class="headerlink" title="InheritableThreadLocal 原理"></a>InheritableThreadLocal 原理</h2><p>在创建 <code>Thread</code> 对象时 ,会复制复父线程的 <code>InheritableThreadLocal</code> 到新的 <code>Thread</code> 对象, 通过这种方式父线程的 <code>ThreadLocal</code> 传递给子线程. 这种方式有如下问题:</p>
<ul>
<li>线程池场景下,无法做到 ThreadLocal 的传递</li>
<li>传递的参数是通用引用传递, 无法做到值传递.</li>
</ul>
<h2 id="TransmittableThreadLocal-原理"><a href="#TransmittableThreadLocal-原理" class="headerlink" title="TransmittableThreadLocal 原理"></a>TransmittableThreadLocal 原理</h2><p><code>TransmittableThreadLocal</code> 是在创建 <code>Runnable</code> 的时候做的 <code>ThreadLocal</code> 传递:</p>
<ol>
<li>在创建 <code>Runnable</code> 的时候, 将 <code>TransmittableThreadLocal</code> 存储到一个对象属性中,此时所有逻辑在父线程中执行.</li>
<li>在执行 <code>Runnable.run</code> 时, 将上文对象中的 <code>TransmittableThreadLocal</code> 取出, 再放到 <code>ThreadLocal</code> 应该在的地方, 这个步骤的逻辑在子线程中执行.</li>
</ol>
<p>另外<code>TransmittableThreadLocal</code> 还留有 <code>TtlCopier</code> 接口, 可以自定义实现值传递.</p>
<p>简单讲讲 TTL 就这么一回事,当然其中还有很多细节需要注意, 有需要的同学可以查看官方文档及官方文档汇总做进一步了解.</p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/transmittable-thread-local">transmittable-thread-local repo</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/12/08/bytebuddy_agent_skywalking/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="分享我的日常技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/08/bytebuddy_agent_skywalking/" class="post-title-link" itemprop="url">Byte Buddy Agent 初探--以 SkyWalking-java 为例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-08 12:08:24" itemprop="dateCreated datePublished" datetime="2022-12-08T12:08:24+00:00">2022-12-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/javaagent/" itemprop="url" rel="index"><span itemprop="name">javaagent</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>byte-buddy-agent 是 ByteBuddy 的一个组件, 用于快速构建出一个 JavaAgent. SkyWalking-java 是一个 SkyWalking 为 Java 准备的运行时代码生成器, 适配了众多中间件以提供定制的监控能力.</p>
<p>SkyWalking-java 本质是一个 java agent ,并在其中使用了 byte-buddy-agent.</p>
<p>本文会介绍 SkyWalking-agent 如何使用 byte-buddy-agent 来做到代码增强的.</p>
<h1 id="ByteBuddy-基础用法"><a href="#ByteBuddy-基础用法" class="headerlink" title="ByteBuddy 基础用法"></a>ByteBuddy 基础用法</h1><p>在深入 SkyWalking-agent 和 byte-buddy-agent 之前, 我们先来看下 ByteBuddy 是如何在调用一个方法前后插入日志的.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MemoryDatabase</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">load</span><span class="params">(String info)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Arrays.asList(info + <span class="string">&quot;: foo&quot;</span>, info + <span class="string">&quot;: bar&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoggerInterceptor</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title function_">log</span><span class="params">(<span class="meta">@SuperCall</span> Callable&lt;List&lt;String&gt;&gt; zuper)</span> <span class="comment">// SuperCall 注解用于表示 zuper 是原始方法的调用.</span></span><br><span class="line">      <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Calling database&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> zuper.call();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;Returned from database&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">MemoryDatabase</span> <span class="variable">loggingDatabase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteBuddy</span>()</span><br><span class="line">  .subclass(MemoryDatabase.class) <span class="comment">// 被增强的类继承于 MemoryDatabase 类</span></span><br><span class="line">  .method(named(<span class="string">&quot;load&quot;</span>)) <span class="comment">// 被增强的方法名为 load</span></span><br><span class="line">  .intercept(MethodDelegation.to(LoggerInterceptor.class)) <span class="comment">// 增强方式是将方法调用代理到 LoggerInterceptor</span></span><br><span class="line">  .make() <span class="comment">// 构造出上述配置产生的类的字节码</span></span><br><span class="line">  .load(getClass().getClassLoader()) <span class="comment">// 将上述配置产生的类用过 getClass().getClassLoader() 加载到 jvm 中</span></span><br><span class="line">  .getLoaded() <span class="comment">// 获取已经加载的 Class 类对象</span></span><br><span class="line">  .newInstance(); <span class="comment">// 通过默认构造函数构造新的对象.</span></span><br></pre></td></tr></table></figure>

<p>上面是一个简单的 ByteBuddy 例子. 它增强了 MemoryDatabase 类, 会在调用 MemoryDatabase.load 前后,打印输出一些信息.<br>ByteBuddy API 每行代码的含义都已经写在注释中了. 可以想象, 在SkyWalking agent 中, 也是构造了类似的代码增强, 在调用前后加入了 SkyWalking 埋点.</p>
<h1 id="SkyWalking-java-简要分析"><a href="#SkyWalking-java-简要分析" class="headerlink" title="SkyWalking-java 简要分析"></a>SkyWalking-java 简要分析</h1><p>我们会先分析中间件如何接入 SkyWalking-java , 然后分析 SkyWalking-java 如何接入 byte-buddy-agent.</p>
<h2 id="插件定义"><a href="#插件定义" class="headerlink" title="插件定义"></a>插件定义</h2><p>SkyWalking-java 提供了一种比较简单的 API ,来供中间件接入. 我们以 SOFA RPC 为例子看下.</p>
<p>一个埋点的接入代码只有两个类,以及一个配置文件,直接上代码:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-sdk-plugin/sofarpc-plugin/src/main/java/org/apache/skywalking/apm/plugin/sofarpc/SofaRpcConsumerInstrumentation.java">SofaRpcConsumerInstrumentation.java:</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SofaRpcConsumerInstrumentation</span> <span class="keyword">extends</span> <span class="title class_">ClassInstanceMethodsEnhancePluginDefine</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ENHANCE_CLASS</span> <span class="operator">=</span> <span class="string">&quot;com.alipay.sofa.rpc.filter.ConsumerInvoker&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">INTERCEPT_CLASS</span> <span class="operator">=</span> <span class="string">&quot;org.apache.skywalking.apm.plugin.sofarpc.SofaRpcConsumerInterceptor&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ClassMatch <span class="title function_">enhanceClass</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> NameMatch.byName(ENHANCE_CLASS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ConstructorInterceptPoint[] getConstructorsInterceptPoints() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> InstanceMethodsInterceptPoint[] getInstanceMethodsInterceptPoints() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InstanceMethodsInterceptPoint</span>[] &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InstanceMethodsInterceptPoint</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> ElementMatcher&lt;MethodDescription&gt; <span class="title function_">getMethodsMatcher</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> named(<span class="string">&quot;invoke&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> String <span class="title function_">getMethodsInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> INTERCEPT_CLASS;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isOverrideArgs</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SofaRpcConsumerInstrumentation 继承了 ClassInstanceMethodsEnhancePluginDefine ,定义了 SOFA RPC 插件如何工作,它通过接口指定了三个属性:</p>
<ol>
<li>enhanceClass: 需要增强哪个类, 这里是增强 <code>com.alipay.sofa.rpc.filter.ConsumerInvoker</code></li>
<li>getConstructorsInterceptPoints: 指定构造函数如何增强: 这个插件不需要构造函数增强</li>
<li>getInstanceMethodsInterceptPoints: 指定方法如何增强, 这里返回了一个 <code>InstanceMethodsInterceptPoint</code> 数组, 数组中每个元素代表一个增强点</li>
</ol>
<p>接着我们看下 <code>InstanceMethodsInterceptPoint</code> 是怎么定义的:</p>
<ul>
<li>getMethodsMatcher: 指定了如何找到需要增强的方法, 这里指定的是名为 <code>invoke</code> 的方法</li>
<li>getMethodsInterceptor: 指定如何增强刚刚指定的<code>invoke</code>方法, 这里指定的是 <code>org.apache.skywalking.apm.plugin.sofarpc.SofaRpcConsumerInterceptor</code>类, 这个类下文会分析.</li>
<li>isOverrideArgs: 这个属性指定了是否需要修改修改 <code>invoke</code> 的入参,这个例子中我们不需要修改,所以返回 <code>false</code></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-sdk-plugin/sofarpc-plugin/src/main/java/org/apache/skywalking/apm/plugin/sofarpc/SofaRpcConsumerInterceptor.java">SofaRpcConsumerInterceptor.java:</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SofaRpcConsumerInterceptor</span> <span class="keyword">implements</span> <span class="title class_">InstanceMethodsAroundInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SKYWALKING_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;skywalking.&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeMethod</span><span class="params">(EnhancedInstance objInst, Method method, Object[] allArguments, Class&lt;?&gt;[] argumentsTypes,</span></span><br><span class="line"><span class="params">                             MethodInterceptResult result)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// 省略一些代码</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ContextCarrier</span> <span class="variable">contextCarrier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContextCarrier</span>();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">operationName</span> <span class="operator">=</span> generateOperationName(providerInfo, sofaRequest);</span><br><span class="line">        <span class="type">AbstractSpan</span> <span class="variable">span</span> <span class="operator">=</span> ContextManager.createExitSpan(operationName, contextCarrier, host + <span class="string">&quot;:&quot;</span> + port);</span><br><span class="line">        span.setComponent(ComponentsDefine.SOFARPC);</span><br><span class="line">        SpanLayer.asRPCFramework(span);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">afterMethod</span><span class="params">(EnhancedInstance objInst, Method method, Object[] allArguments, Class&lt;?&gt;[] argumentsTypes,</span></span><br><span class="line"><span class="params">                              Object ret)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">SofaResponse</span> <span class="variable">result</span> <span class="operator">=</span> (SofaResponse) ret;</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">null</span> &amp;&amp; result.isError()) &#123;</span><br><span class="line">            dealException((Throwable) result.getAppResponse());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ContextManager.stopSpan();</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMethodException</span><span class="params">(EnhancedInstance objInst, Method method, Object[] allArguments,</span></span><br><span class="line"><span class="params">                                      Class&lt;?&gt;[] argumentsTypes, Throwable t)</span> &#123;</span><br><span class="line">        dealException(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SofaRpcConsumerInterceptor</code> 会重载三个方法, 分别在 <code>com.alipay.sofa.rpc.filter.ConsumerInvoker#invoke()</code> 调用之前,之后,以及发生异常时被回调.</p>
<p>配置文件为:<br><a target="_blank" rel="noopener" href="https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-sdk-plugin/sofarpc-plugin/src/main/resources/skywalking-plugin.def">skywalking-plugin.def</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sofarpc=org.apache.skywalking.apm.plugin.sofarpc.SofaRpcConsumerInstrumentation</span><br></pre></td></tr></table></figure>
<p>这里面配置了 <code>SofaRpcConsumerInstrumentation</code> 类.</p>
<h2 id="适配-ByteBuddy"><a href="#适配-ByteBuddy" class="headerlink" title="适配 ByteBuddy"></a>适配 ByteBuddy</h2><p>通过上文的配文件,SkyWalking-java 可以获取到所有的 PluginDefine 类. SkyWalking-java 会加载这些类, 并将他们统一交给 <code>PluginFinder</code> 管理.</p>
<p><code>PluginFinder</code> 的 <code>buildMatch()</code> 方法生成一个 ElementMatcher 来匹配到所有需要被加载的类型. 以 SOFA RPC 为例就是 <code>com.alipay.sofa.rpc.filter.ConsumerInvoker</code> 类.</p>
<p><code>PluginFinder</code> 会被传递给 <code>org.apache.skywalking.apm.agent.SkyWalkingAgent.Transformer</code> 来构造一个 <code>AgentBuilder.Transformer</code>. 可以被上面 ElementMatcher 匹配的类,都会被 Transformer 增强.</p>
<p>增强逻辑如下:</p>
<ul>
<li>处理每个匹配 ElementMatcher 的类</li>
<li>通过 <code>PluginFinder</code> 找到这个类对应的 <code>PluginDefine</code></li>
<li>调用 <code>PluginDefine</code> 的 <code>define</code> 方法对方法进行增强:<ul>
<li>获取 <code>PluginDefine</code> 定义的 <code>InstanceMethodsInterceptPoints</code></li>
<li>遍历 <code>InstanceMethodsInterceptPoints</code>, 通过 <code>MethodsMatcher</code> 确定需要增强的方法, 通过 <code>getMethodsInterceptor</code> 获取如何增强方法. 并将 Interceptor 注入到 <code>InstMethodsInter</code> 中.</li>
<li>将 <code>MethodsMatcher</code> 和 <code>InstMethodsInter</code> 传递给 ByteBuddy 就完成了 JavaAgent 的配置.</li>
</ul>
</li>
</ul>
<p>下面我们看下 <code>InstMethodsInter</code> 是什么:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InstMethodsInter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ILog</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LogManager.getLogger(InstMethodsInter.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * An &#123;<span class="doctag">@link</span> InstanceMethodsAroundInterceptor&#125; This name should only stay in &#123;<span class="doctag">@link</span> String&#125;, the real &#123;<span class="doctag">@link</span> Class&#125;</span></span><br><span class="line"><span class="comment">     * type will trigger classloader failure. If you want to know more, please check on books about Classloader or</span></span><br><span class="line"><span class="comment">     * Classloader appointment mechanism.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> InstanceMethodsAroundInterceptor interceptor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> instanceMethodsAroundInterceptorClassName class full name.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InstMethodsInter</span><span class="params">(String instanceMethodsAroundInterceptorClassName, ClassLoader classLoader)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            interceptor = InterceptorInstanceLoader.load(instanceMethodsAroundInterceptorClassName, classLoader);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PluginException</span>(<span class="string">&quot;Can&#x27;t create InstanceMethodsAroundInterceptor.&quot;</span>, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Intercept the target instance method.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj          target class instance.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> allArguments all method arguments</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> method       method description.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> zuper        the origin call ref.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the return value of target instance method.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception only throw exception because of zuper.call() or unexpected exception in sky-walking ( This is a</span></span><br><span class="line"><span class="comment">     *                   bug, if anything triggers this condition ).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RuntimeType</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(<span class="meta">@This</span> Object obj, <span class="meta">@AllArguments</span> Object[] allArguments, <span class="meta">@SuperCall</span> Callable&lt;?&gt; zuper,</span></span><br><span class="line"><span class="params">        <span class="meta">@Origin</span> Method method)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">EnhancedInstance</span> <span class="variable">targetObject</span> <span class="operator">=</span> (EnhancedInstance) obj;</span><br><span class="line"></span><br><span class="line">        <span class="type">MethodInterceptResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodInterceptResult</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            interceptor.beforeMethod(targetObject, method, allArguments, method.getParameterTypes(), result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            LOGGER.error(t, <span class="string">&quot;class[&#123;&#125;] before method[&#123;&#125;] intercept failure&quot;</span>, obj.getClass(), method.getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!result.isContinue()) &#123;</span><br><span class="line">                ret = result._ret();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ret = zuper.call();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                interceptor.handleMethodException(targetObject, method, allArguments, method.getParameterTypes(), t);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t2) &#123;</span><br><span class="line">                LOGGER.error(t2, <span class="string">&quot;class[&#123;&#125;] handle method[&#123;&#125;] exception failure&quot;</span>, obj.getClass(), method.getName());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> t;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ret = interceptor.afterMethod(targetObject, method, allArguments, method.getParameterTypes(), ret);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                LOGGER.error(t, <span class="string">&quot;class[&#123;&#125;] after method[&#123;&#125;] intercept failure&quot;</span>, obj.getClass(), method.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><code>InstMethodsInter</code> 与上文 <em>ByteBuddy 基础用法</em> 中的 <code>LoggerInterceptor</code> 是同一类型的东西, ByteBuddy 会将需要增强的类代理给 <code>intercept</code> 方法. 可以看 <code>intercept</code> 方法的参数上都带上了 <code>ByteBuddy</code> 的注解:</p>
<ul>
<li><strong>This</strong>: 代表当前代理类的实例</li>
<li><strong>AllArguments</strong>: 原始调用的参数列表</li>
<li><strong>SuperCall</strong>: 代表原始调用</li>
<li><strong>Origin</strong>: 代表原始方法</li>
</ul>
<p>通过 <code>InstMethodsInter</code> , SkyWalking-java 在需要增强的方法前后及异常处理阶段增加了一些回调, 回调给 <code>PluginDefine</code> 中定义的 <code>Interceptor</code>.</p>
<h1 id="ByteBuddy-Agent-原理简介"><a href="#ByteBuddy-Agent-原理简介" class="headerlink" title="ByteBuddy Agent  原理简介"></a>ByteBuddy Agent  原理简介</h1><p>在开始社介绍 ByteBuddy 原理之前, 可以先看下 <a href="/2022/11/24/javaagent_introduction/">Java Agent 原理简介</a> 来回顾下原生 javaagent 是怎么工作的:</p>
<p>我们向 <code>Instrumentation</code> 注册一些 <code>Transformer</code>,在类加载期间 <code>Transformer</code> 的 <code>transform</code> 方法就会被调用. <code>transform</code> 方法会修改类的二进制表示(字节码), 从而实现类增强.</p>
<p>那么 ByteBuddy 是如何适配原生 javaagent 这种模式的呢?</p>
<p>ByteBuddy 内部有一个适配器 <code>net.bytebuddy.agent.builder.AgentBuilder.Default.ExecutingTransformer</code> 将原生 transform 方法适配到 <code>net.bytebuddy.agent.builder.AgentBuilder.Transformer</code> 的方法上. 然后通过 <code>net.bytebuddy.dynamic.DynamicType.Builder</code> 构造新的类的字节码, 返回给 <code>Instrumentation</code>.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/12/06/byte_buddy_simple_example_intro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="分享我的日常技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/06/byte_buddy_simple_example_intro/" class="post-title-link" itemprop="url">一个简单的 Byte Buddy 例子及原理简述</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-06 17:08:06" itemprop="dateCreated datePublished" datetime="2022-12-06T17:08:06+00:00">2022-12-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/javaagent/" itemprop="url" rel="index"><span itemprop="name">javaagent</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h1><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>我们有一个类 EchoA, 它有一个方法 <code>echo</code> 返回值是一个字符串 <code>&quot;A&quot;</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EchoA</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">echo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;A&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们想要通过 ByteBuddy 来动态生成一个类, 它的 echo 方法返回字符串 <code>&quot;B&quot;</code>.</p>
<h2 id="ByteBuddy-实现"><a href="#ByteBuddy-实现" class="headerlink" title="ByteBuddy 实现"></a>ByteBuddy 实现</h2><p>我们可以这么写:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 使用 ByteBuddy 开始构造一个类</span></span><br><span class="line">    DynamicType.Unloaded&lt;EchoA&gt; newClass = <span class="keyword">new</span> <span class="title class_">ByteBuddy</span>()</span><br><span class="line">            .subclass(EchoA.class) <span class="comment">// 新的类继承于 EchoA</span></span><br><span class="line">            .method(ElementMatchers.named(<span class="string">&quot;echo&quot;</span>)) <span class="comment">// 对方法 echo 做增强</span></span><br><span class="line">            .intercept(FixedValue.value(<span class="string">&quot;B&quot;</span>)) <span class="comment">// 增强内容是返回一个固定值 &quot;B&quot;</span></span><br><span class="line">            .make(); <span class="comment">// 构造这个 class</span></span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; dynamicType = newClass</span><br><span class="line">            .load(EchoA.class.getClassLoader()) <span class="comment">// 使用 EchoA 的类加载器加载这个类</span></span><br><span class="line">            .getLoaded(); <span class="comment">// 获取被加载的类</span></span><br><span class="line">    <span class="type">EchoA</span> <span class="variable">echoA</span> <span class="operator">=</span> (EchoA) dynamicType.getDeclaredConstructor().newInstance(); <span class="comment">// 使用反射调用构造函数, 构造新的类的实例</span></span><br><span class="line">    System.out.println(echoA.getClass().getName()); <span class="comment">// 打印新类类名</span></span><br><span class="line">    System.out.println(echoA.echo()); <span class="comment">// 调用 echo 方法并打印结果</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面这个 main 方法动态生成了一个类, 并调用这个类的 <code>echo</code> 方法,返回了字符串 <code>&quot;B&quot;</code>.</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><h2 id="字节码视角-改变了什么"><a href="#字节码视角-改变了什么" class="headerlink" title="字节码视角: 改变了什么"></a>字节码视角: 改变了什么</h2><p>ByteBuddy 可以生成字节码,但是不会生成 Java 源码,我们就从字节码层面看看, ByteBuddy 做了什么.</p>
<p>先看下原始的 EchoA 字节码(部分):<br><img src="/images/ByteBuddy1.jpg" alt="EchoA"></p>
<p>echo 方法的字节码如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0 ldc #8 &lt;B&gt;</span><br><span class="line">2 areturn</span><br></pre></td></tr></table></figure>
<p><strong>ldc</strong> 指令会将常量池中的常量入栈, 这里是将常量池第八个常量(也就是<code>&quot;A&quot;</code>) 入栈. <strong>areturn</strong> 指令将栈中数据作为返回值返回.</p>
<p>生成的新类, 也是类似的逻辑:<br><img src="/images/ByteBuddy2.jpg" alt="EchoB"></p>
<h2 id="源码视角-怎么实现的"><a href="#源码视角-怎么实现的" class="headerlink" title="源码视角: 怎么实现的"></a>源码视角: 怎么实现的</h2><p>ByteBuddy 是一个对 ASM 字节码框架的封装. ByteBuddy 对字节码操作做了多个层次的封装, 用户可以很方便的使用它, 但要理解它的运行原理, 有比较陡峭的学习曲线. 下面我们管中窥豹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DynamicType.Unloaded&lt;EchoA&gt; newClass = <span class="keyword">new</span> <span class="title class_">ByteBuddy</span>()</span><br><span class="line">        .subclass(EchoA.class) <span class="comment">// 新的类继承于 EchoA</span></span><br><span class="line">        .method(ElementMatchers.named(<span class="string">&quot;echo&quot;</span>)) <span class="comment">// 对方法名为 echo 做增强</span></span><br><span class="line">        .intercept(FixedValue.value(<span class="string">&quot;B&quot;</span>)) <span class="comment">// 增强内容是返回一个固定值 &quot;B&quot;</span></span><br><span class="line">        .make(); <span class="comment">// 构造这个 class</span></span><br></pre></td></tr></table></figure>

<p>我们着重分析这段代码:<code>subclass</code>,<code>method</code>,<code>intercept</code> 这三个方法都是对 ByteBuddy 对象进行设置,没有进行具体字节码操作.</p>
<blockquote>
<p>由于 BtyeBuddy 框架中用了很多不可变类, 这三个方法的返回值都是一个新的 ByteBuddy 实例.</p>
</blockquote>
<p>最后的 <code>make</code> 方法将会进行字节码增强,产生新的类的字节码.我们具体看下 <code>make</code> 方法内部.</p>
<p>net.bytebuddy.dynamic.DynamicType.Builder.AbstractBase.UsingTypeWriter#make(net.bytebuddy.dynamic.TypeResolutionStrategy):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DynamicType.Unloaded&lt;U&gt; <span class="title function_">make</span><span class="params">(TypeResolutionStrategy typeResolutionStrategy, TypePool typePool)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> toTypeWriter(typePool).make(typeResolutionStrategy.resolve());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>make</code> 方法内部使用会构造一个 TypeWriter 去做具体的 <code>make</code> 操作.<br>构造 TypeWriter 的过程参考下面代码的注释</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> TypeWriter&lt;T&gt; <span class="title function_">toTypeWriter</span><span class="params">(TypePool typePool)</span> &#123;</span><br><span class="line">    MethodRegistry.<span class="type">Compiled</span> <span class="variable">methodRegistry</span> <span class="operator">=</span> constructorStrategy   <span class="comment">// constructorStrategy 规定了如何构造新类的构造函数, ByteBuddy 遵循约定优于配置的原则, constructorStrategy 有一个默认值,这里我们不展开讨论.</span></span><br><span class="line">            .inject(instrumentedType, <span class="built_in">this</span>.methodRegistry) <span class="comment">// inject 将构造函数如何构造的 handler 插入 methodRegistry,并返回这个 methodRegistry</span></span><br><span class="line">            .prepare(applyConstructorStrategy(instrumentedType), <span class="comment">// prepare 方法会会根据配置 (也就是上文 method 和 intercept 方法), 将改造 echo 方法的 handler 加入 methodRegistry.</span></span><br><span class="line">            <span class="comment">// 具体操作是: 在需要被怎强的类 EchoA 中, 通过 过滤器(ElementMatchers.named(&quot;echo&quot;)) 找到需要被增强的</span></span><br><span class="line">            方法 echo , 然后将这个方法和这个方法如何被增强 (返回固定值 value FixedValue.value(<span class="string">&quot;B&quot;</span>)) 插入到 methodRegistry</span><br><span class="line">                    methodGraphCompiler,</span><br><span class="line">                    typeValidation,</span><br><span class="line">                    visibilityBridgeStrategy,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InstrumentableMatcher</span>(ignoredMethods))</span><br><span class="line">            .compile(SubclassImplementationTarget.Factory.SUPER_CLASS, classFileVersion); <span class="comment">// compile 方法会将对应的 handler 对应的 ByteCodeAppender 和 MethodAttributeAppender 和方法对应起来,并缓存起来.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 最后将准备好的对象组织成 TypeWriter 返回</span></span><br><span class="line">    <span class="keyword">return</span> TypeWriter.Default.&lt;T&gt;forCreation(methodRegistry,</span><br><span class="line">            auxiliaryTypes,</span><br><span class="line">            fieldRegistry.compile(methodRegistry.getInstrumentedType()),</span><br><span class="line">            recordComponentRegistry.compile(methodRegistry.getInstrumentedType()),</span><br><span class="line">            typeAttributeAppender,</span><br><span class="line">            asmVisitorWrapper,</span><br><span class="line">            classFileVersion,</span><br><span class="line">            annotationValueFilterFactory,</span><br><span class="line">            annotationRetention,</span><br><span class="line">            auxiliaryTypeNamingStrategy,</span><br><span class="line">            implementationContextFactory,</span><br><span class="line">            typeValidation,</span><br><span class="line">            classWriterStrategy,</span><br><span class="line">            typePool);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造完成 TypeWriter 之后, 通过 make 方法最终构造出新的类的字节码, make 方法调用<code>net.bytebuddy.dynamic.scaffold.TypeWriter.Default.ForCreation#create</code> create 方法, create 方法调用 ASM 框架的方法, 将上述准备好的 ByteCodeAppender 应用到被增强的类上.</p>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><a target="_blank" rel="noopener" href="https://bytebuddy.net/#/tutorial">ByteBuddy 官方教程</a>: 如果想要快速上手 ByteBuddy, 看这个官方教程最直接.<br><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se11/html/index.html">The Java® Virtual Machine Specification Java SE 11 Edition</a> 想了解字节码可以看这个文档</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/12/06/git_ssh_dns_problem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="分享我的日常技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/06/git_ssh_dns_problem/" class="post-title-link" itemprop="url">记一次 Github 无法使用 git 客户端的问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-06 14:26:25" itemprop="dateCreated datePublished" datetime="2022-12-06T14:26:25+00:00">2022-12-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Common/" itemprop="url" rel="index"><span itemprop="name">Common</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>使用 git push 代码到 github. 直接卡住了, 过了很长时间报错. 执行 <code>telent github.com 22</code>无法连通.</p>
<h1 id="解决方案及原因"><a href="#解决方案及原因" class="headerlink" title="解决方案及原因"></a>解决方案及原因</h1><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>将 DNS 解析服务器配置为 <code>8.8.8.8</code>.</p>
<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>好在自己有另一台机器, 可以连上 github. 比对两台机器, 可以发现, 出问题的机器 github.com 域名解析出来是一个贵州的IP: <code>182.43.124.6</code>. 而没出问题的机器,解析出来的是新加坡的IP: <code>20.205.243.166</code>.<br>后者 telnet 结果:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># telnet 20.205.243.166 22</span><br><span class="line">Trying 20.205.243.166...</span><br><span class="line">Connected to github.com.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">SSH-2.0-babeld-cd305013</span><br></pre></td></tr></table></figure>
<p>可以看到 SSH 的返回, 这是能正常连接的.</p>
<p>出问题的机器没有指定 DNS 服务器, 没出问题的机器指定了 8.8.8.8.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/11/28/remote-login-use-ssh/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="分享我的日常技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/28/remote-login-use-ssh/" class="post-title-link" itemprop="url">使用 SSH 实现远程登录内网机器 (MacOS)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-28 17:12:32" itemprop="dateCreated datePublished" datetime="2022-11-28T17:12:32+00:00">2022-11-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Common/" itemprop="url" rel="index"><span itemprop="name">Common</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>现在我的主力开发机器是台台式机, 有时候出门在外, 就没办法操控这台机器了. 我解决这个问题的<strong>基本思路</strong>是: 租用一台云上带公网域名的机器,然后将本地 22 端口映射到云服务器上. 这样就可以将云服务器作为一台跳板机,登录我本地的机器了.</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><ul>
<li>将本地 22 端口映射到云上机器</li>
<li>让本地机器开机运行脚本,自动完成上述工作</li>
</ul>
<h1 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h1><h2 id="准备工作-购买一台云服务器"><a href="#准备工作-购买一台云服务器" class="headerlink" title="准备工作:购买一台云服务器"></a>准备工作:购买一台云服务器</h2><p>我买的的是一台2C4G,腾讯云服务器.趁双11+新人优惠,只要100元&#x2F;年.需要获取这台机器的IP,设置 ssh 公钥,让本地机器可以通过shell<strong>免密</strong>登录云服务器.</p>
<h2 id="本地机器配置"><a href="#本地机器配置" class="headerlink" title="本地机器配置"></a>本地机器配置</h2><p>构造以下两个文件:<br>remote_ssh.sh:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">PORT=&#x27;8888&#x27;</span><br><span class="line">n=1</span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">  echo &quot;try $n&quot;</span><br><span class="line">  ssh -o ExitOnForwardFailure=yes -R 8888:localhost:22 -N root@cloud_ip</span><br><span class="line">  n=$((n+1))</span><br><span class="line">  echo &quot;fail $n&quot;</span><br><span class="line">  sleep 15</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>这个脚本会将云服务器上的 8888 收到的请求转发给本地22端口, 也就是本地 sshd 监听的端口. 同时如果操作失败,就会15s后重试.<br>变量说明:</p>
<ul>
<li><strong>root</strong>: 登录云服务器的用户名,根据你的需要修改</li>
<li><strong>cloud_ip</strong>: 云服务器的公网ip</li>
<li><strong>-o ExitOnForwardFailure&#x3D;yes</strong>: 设置如果端口转发开启失败就退出的选项</li>
</ul>
<p>startup.sh:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">curday=`date +%Y-%m-%d`</span><br><span class="line"></span><br><span class="line">nohup bash ~/git/shell/remote_ssh.sh 2&gt;&amp;1 &gt;~/git/shell/logs/remote_ssh$curday.log &amp;</span><br></pre></td></tr></table></figure>
<p>这个脚本会执行 <code>remote_ssh.sh</code> 这个脚本,并将日志输出到<code>~/git/shell/logs/</code>文件夹中.</p>
<p>将<code>startup.sh</code>的默认打开方式修改为 Term 或者 iTerm.</p>
<p>在系统设置-&gt;用户与群组将 startup.sh 添加到登录项.</p>
<h2 id="云上机器配置"><a href="#云上机器配置" class="headerlink" title="云上机器配置"></a>云上机器配置</h2><p>修改 <code>/etc/ssh/sshd_config</code> 文件, 添加如下配置:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ClientAliveInterval 10</span><br><span class="line">ClientAliveCountMax 1</span><br></pre></td></tr></table></figure>

<p>这两个配置会开启服务端 shhd 对于客户端的探活,如果客户端连接断开了, 服务端也会关闭连接.</p>
<h1 id="遇到的坑"><a href="#遇到的坑" class="headerlink" title="遇到的坑"></a>遇到的坑</h1><h2 id="端口转发失败之后-ssh-不退出"><a href="#端口转发失败之后-ssh-不退出" class="headerlink" title="端口转发失败之后, ssh 不退出"></a>端口转发失败之后, ssh 不退出</h2><p>端口转发失败之后, ssh 不退出,就没办法做重试. 在添加 <code>-o ExitOnForwardFailure=yes</code> 选项之后,修复了这问题.</p>
<h2 id="ssh-断开之后-sshd-依然监听端口"><a href="#ssh-断开之后-sshd-依然监听端口" class="headerlink" title="ssh 断开之后, sshd 依然监听端口"></a>ssh 断开之后, sshd 依然监听端口</h2><p>ssh 断开之后, sshd 依然监听端口. 当 ssh 继续重试建立端口转发,因为服务端 sshd 依然占用之前那个端口,导致重试始终无法成功.<br>解决方案是给 sshd 开启探活,添加 ClientAliveInterval 和 ClientAliveCountMax 配置.</p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档:"></a>参考文档:</h1><p><a target="_blank" rel="noopener" href="https://wangdoc.com/ssh/port-forwarding">SSH教程</a>: 阮一峰的SSH教程, 看完不需要多长时间,能对 SSH 有初步了解<br><a target="_blank" rel="noopener" href="https://superuser.com/questions/1563605/how-can-a-remote-ssh-tunnel-port-be-closed-on-the-ssh-server-when-the-ssh-comman">how-can-a-remote-ssh-tunnel-port-be-closed-on-the-ssh-server-when-the-ssh-comman</a><br><a target="_blank" rel="noopener" href="https://man.openbsd.org/sshd_config">man:sshd_config</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/11/24/javaagent_introduction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="分享我的日常技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/24/javaagent_introduction/" class="post-title-link" itemprop="url">Java Agent 原理简介</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-24 15:02:39" itemprop="dateCreated datePublished" datetime="2022-11-24T15:02:39+00:00">2022-11-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/javaagent/" itemprop="url" rel="index"><span itemprop="name">javaagent</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Java-Agent-是什么"><a href="#Java-Agent-是什么" class="headerlink" title="Java Agent 是什么"></a>Java Agent 是什么</h1><p>Java Agent 是一种可以动态修改 Java 类字节码的技术.</p>
<p>使用 Java Agent 通常是为了动态增加应用的功能,但这些功能和主体业务逻辑是不耦合的, 比如说各种监控\诊断工具,甚至有公司拿它来实现 Service Mesh.<br>举两个例子:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/apache/skywalking-java">SkyWalking-java</a> SkyWalking 社区推出的 Java Agent, 用于Java 应用快速接入 SkyWalking</li>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/arthas">Arthas</a> 是 Alibaba 推出的 Java 诊断工具.</li>
<li>阿里云 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/HjQUvTlAXuI3y_azlSh2Pw">Spring Cloud 应用 Proxyless Mesh 模式探索与实践</a></li>
</ol>
<p>上面两者均是基于 Java Agent 实现的.</p>
<p>使用 Java Agent 可以实现如下技术目标:</p>
<ol>
<li>对源代码<strong>无侵入</strong>的情况下, 完成功能的添加: SkyWalking-java 主要利用这一特性, 当我们有很多系统都需要接入监控埋点时, 就不需要升级每一个应用了, 添加 Java Agent 即可.</li>
<li><strong>运行时动态</strong>修改功能,实现热部署. Arthas 主要利用这一特性, Arths 的诊断功能是对性能有影响的,只能单独选择一两台服务器开启. 并且故障诊断需要故障现场,不能重启应用, 因此热部署特性对于 Arthas 来说就至关重要了.</li>
</ol>
<h1 id="Java-Agent-工作原理简介"><a href="#Java-Agent-工作原理简介" class="headerlink" title="Java Agent 工作原理简介"></a>Java Agent 工作原理简介</h1><h2 id="Java-Agent-的启动"><a href="#Java-Agent-的启动" class="headerlink" title="Java Agent 的启动"></a>Java Agent 的启动</h2><p>Java Agent 的启动有两种方式:</p>
<ol>
<li>在启动 Java 应用时,在 JVM 参数中添加 <code>-javaagent:/path/to/your_agent_name.jar</code>.下文简称 JVM 参数方式.</li>
<li>在运行时,通过 com.sun.tools.attach.VirtualMachine#loadAgent(java.lang.String) 动态加载 Java Agent. 下文简称运行时方式.</li>
</ol>
<blockquote>
<p>这里具体说明下运行时方式的启动: 假设我们有一个 biz.jar 是我们的业务应用,  agent.jar 是我们的 Java Agent. 我们可以在启动一个 attach.jar ,来将 agent.jar  attach 到 biz.jar 上, 整个过程是不需要修改 biz.jar 的.</p>
</blockquote>
<p>下面我们会从几个方面来比较这两种启动方式:</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">JVM 参数方式</th>
<th align="left">运行时方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">启动时机</td>
<td align="left">main函数执行之前</td>
<td align="left">应用运行时</td>
</tr>
<tr>
<td align="left">执行线程</td>
<td align="left">main 线程</td>
<td align="left">AttachListener 线程</td>
</tr>
<tr>
<td align="left">入口函数</td>
<td align="left">premain()</td>
<td align="left">agentmain()</td>
</tr>
<tr>
<td align="left">ClassLoader</td>
<td align="left">AppClassLoader</td>
<td align="left">AppClassLoader</td>
</tr>
</tbody></table>
<h3 id="Java-Agent-启动代码分析"><a href="#Java-Agent-启动代码分析" class="headerlink" title="Java Agent 启动代码分析"></a>Java Agent 启动代码分析</h3><p>在 JVM 接收到相关的参数之后, 就会调用 InstrumentationImpl 对象执行 agent 逻辑. JVM 方式会调用 InstrumentationImpl 的 loadClassAndCallPremain 方法, 运行时方式会调用 loadClassAndCallAgentmain 方法.这两个方法底层都是调用  loadClassAndStartAgent 方法:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WARNING: the native code knows the name &amp; signature of this method</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span></span><br><span class="line"><span class="title function_">loadClassAndCallPremain</span><span class="params">(    String  classname,</span></span><br><span class="line"><span class="params">                            String  optionsString)</span></span><br><span class="line">        <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">    loadClassAndStartAgent( classname, <span class="string">&quot;premain&quot;</span>, optionsString );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// WARNING: the native code knows the name &amp; signature of this method</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span></span><br><span class="line"><span class="title function_">loadClassAndCallAgentmain</span><span class="params">(  String  classname,</span></span><br><span class="line"><span class="params">                            String  optionsString)</span></span><br><span class="line">        <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">    loadClassAndStartAgent( classname, <span class="string">&quot;agentmain&quot;</span>, optionsString );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 loadClassAndStartAgent 方法中, 首先获取 AppClassLoader ,然后通过 AppClassLoader 加载 AgentClass 类.最后通过反射调用 premain 或者 agentmain 方法.</p>
<p>因此我们可以得出一个结论: <strong>除了上文表格中的不同点, JVM 方式 和 运行时方式启动的 Java Agent 没什么区别.</strong></p>
<p>agentmain 和 premain 有一个参数是 Instrumentation , Instrumentationimpl 会将自身传递给 agentmain&#x2F;premian 方法.</p>
<h2 id="实现字节码修改-–-Instrumentation-简介"><a href="#实现字节码修改-–-Instrumentation-简介" class="headerlink" title="实现字节码修改 – Instrumentation 简介"></a>实现字节码修改 – Instrumentation 简介</h2><p>Instrumentation 是 agentmain&#x2F;premain 的入参, 通过这个类, 可以实现字节码修改.</p>
<p>Instrumentation 对于字节码的修改,可以分为两种形式:</p>
<ol>
<li>transform: 修改字节码,会在字节码里面掺私货.给类加切面用这种方式.</li>
<li>redefine: 重新定义字节码, 推倒重来. 直接修改类的业务逻辑用这种方式.</li>
</ol>
<p>redeine 是 java1.5 引入的, 而 transform 是 java 1.6 引入的. transform 的使用更方便,因此我推荐使用 transform 而不用使用 redeine.</p>
<p>transform 又分为两类:</p>
<ol>
<li>transform: 在类第一次加载时执行</li>
<li>retransform: 调用 Instrumentation 的 retransformClasses 方法手动执行.</li>
</ol>
<h3 id="transform-方法"><a href="#transform-方法" class="headerlink" title="transform 方法"></a>transform 方法</h3><p>我们可以向 <code>Instrumentation</code> 中注册 <code>Transformer</code>, 当一个类被加载或者被调用 <code>retransform</code> 时, Transformer 的 <code>transform</code> 方法会被调用. <code>transform</code> 接收一个用来表示 classFile 的二进制数组, 同时返回一个新的表示类的二进制数组.</p>
<p>可以用 ASM ,ByteBuddy 等框架来读取,修改这个二进制数组并返回. 这样, 一次代码增强就完成了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/11/23/debug-jvm-on-mac/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="分享我的日常技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/23/debug-jvm-on-mac/" class="post-title-link" itemprop="url">在 MacOS 上调试 JVM</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-23 08:15:17" itemprop="dateCreated datePublished" datetime="2022-11-23T08:15:17+00:00">2022-11-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-01-13 06:16:47" itemprop="dateModified" datetime="2025-01-13T06:16:47+00:00">2025-01-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>最近在看 JVM 源码,没有 debug 环境很不方便, 都不知道方法是怎么跳转的. 因此想要自己搭一个 debug 环境. 网上有很多相关的文章, 但毕竟不是一模一样环境, 一点小小的差异, 就可能让编译失败,浪费很多时间.</p>
<p>因此我选择通过 brew 的编译方式来, 稍微修改一下参数即可获得我们需要的 debug 版本 JVM.</p>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><ul>
<li>Mac Studio M1 Max</li>
<li>macOS Monterey 12.5.1</li>
</ul>
<h1 id="编译过程"><a href="#编译过程" class="headerlink" title="编译过程"></a>编译过程</h1><h3 id="尝试直接通过-brew-编译-JVM"><a href="#尝试直接通过-brew-编译-JVM" class="headerlink" title="尝试直接通过 brew 编译 JVM"></a>尝试直接通过 brew 编译 JVM</h3><p>执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install --build-from-source --verbose openjdk@11</span><br></pre></td></tr></table></figure>
<p>直接安装 jdk 11, 这个命令会从源码安装 openjdk11. 可以看下能不能编译成功. 如果这个命令编译不成功,后面的步骤页没必要尝试了; 如果编译成功了, 那我们就会比较有信心了.</p>
<p>这个命令会输出很多细节信息, 这很重要.</p>
<p>上述命令实际上执行的是 <a target="_blank" rel="noopener" href="https://github.com/Homebrew/homebrew-core/blob/master/Formula/openjdk%4011.rb">openjdk@11.rb</a>, 通目录下还有 openjdk8,17,19 可供选择.</p>
<h3 id="brew-编译-JVM-的过程"><a href="#brew-编译-JVM-的过程" class="headerlink" title="brew 编译 JVM 的过程"></a>brew 编译 JVM 的过程</h3><ol>
<li>下载并解压源码到 <code>/private/tmp/openjdk11xxx</code>中</li>
<li>下载并解压 boot-jvm 到 <code>/private/tmp/openjdk11-boot-jdkxxx</code> 中</li>
<li>根据 <a target="_blank" rel="noopener" href="https://github.com/Homebrew/homebrew-core/blob/master/Formula/openjdk%4011.rb">openjdk@11.rb</a> 中的配置执行 configure 脚本</li>
<li>执行 make 命令:<code>make images CONF=release</code></li>
<li>删除所有临时文件</li>
</ol>
<p>为了能编译出可以 debug 的 JVM ,我们还需要做两件事情:</p>
<ol>
<li>在配置 configure 脚本时,添加 debug 参数</li>
<li>brew 在安装完成后会将源码删除, 我们需要将源码保留</li>
</ol>
<h3 id="手动编译-JVM"><a href="#手动编译-JVM" class="headerlink" title="手动编译 JVM"></a>手动编译 JVM</h3><p>接下俩我们仿照brew 的编译方式手动编译 JVM:</p>
<ol>
<li>解压源码<br>brew 安装完成后会删除源码,但是不会删除下载下来的源码压缩包,我们可以手动解压这个压缩包,然后将源码放到我们自己的目录中.</li>
</ol>
<p>相关的命令在 brew 编译 JVM 的输出中有,可以直接参考.</p>
<blockquote>
<p>注意: 解压目标文件夹需要已经存在.</p>
</blockquote>
<ol start="2">
<li><p>解压 boot jdk<br>同上, 我们需要吧boot jdk 解压出来</p>
</li>
<li><p>修改 configure 参数执行 configure 脚本<br>执行 configure 脚本的参数在brew 输出中也有,可以抄下来.我们需要对其中几个参数进行修改:</p>
</li>
</ol>
<ul>
<li><code>--with-boot-jdk</code> 如果修改了 boot-jdk 的位置,需要将这个参数指向真确的位置</li>
<li><code>--with-debug-level</code> 修改为fastdebug</li>
<li><code>--with-native-debug-symbols</code> 的值修改为 internal, 表示会把符号表嵌入到二进制中,这是 debug 的关键</li>
</ul>
<p>configure 命令的例子</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --disable-hotspot-gtest --disable-warnings-as-errors --with-boot-jdk-jvmargs=-Duser.home=/Users/zhangchengxi/Library/Caches/Homebrew/java_cache --with-boot-jdk=/private/tmp/openjdkA11-20221122-35955-58bnn5/jdk11u-jdk-11.0.16.1-ga/boot-jdk --with-debug-level=fastdebug --with-conf-name=release --with-jvm-variants=server --with-jvm-features=shenandoahgc --with-native-debug-symbols=none --with-vendor-bug-url=https://github.com/Homebrew/homebrew-core/issues --with-vendor-name=Homebrew --with-vendor-url=https://github.com/Homebrew/homebrew-core/issues --with-vendor-version-string=Homebrew --with-vendor-vm-bug-url=https://github.com/Homebrew/homebrew-core/issues --without-version-opt --without-version-pre --enable-dtrace --with-sysroot=/Library/Developer/CommandLineTools/SDKs/MacOSX12.sdk --with-extra-ldflags=-Wl,-rpath,@loader_path/server -headerpad_max_install_names</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里有个问题, brew 执行这个命令是可以成功的,但是我执行的时候, 必须把最后一个参数 headerpad_max_install_names 去掉才能成功.</p>
</blockquote>
<ol start="4">
<li>执行 make 命令: <code>make images CONF=release</code><br>这个命令会在 <code>release/images/jdk/</code>  下创建 JVM 的二进制</li>
</ol>
<p>上述步骤完成之后, 我们就有了可以用于 debug 的 JVM 了.</p>
<h3 id="通过-Vscode-启动-java-并-debug"><a href="#通过-Vscode-启动-java-并-debug" class="headerlink" title="通过 Vscode 启动 java 并 debug"></a>通过 Vscode 启动 java 并 debug</h3><p>我们通过 vscode 打开 jvm 源码之后, 可以在左边打开一个 debug 界面.在这个界面中有一个<br><code>create a launch.json file</code> 的按钮, 我们点击它,就能创建一个 <code>.vscode/launch.json</code> 的文件.<br>最终这个文件会长这个样子:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;(lldb) 启动&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppdbg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/your/path/to/jdk/source/build/release/images/jdk/bin/java&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;-Dfile.encoding=UTF-8&quot;</span><span class="punctuation">,</span><span class="string">&quot;-Djava.compiler=NONE&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-classpath&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;/dir/demo/target/classes&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;org.example.Main&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;stopAtEntry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;environment&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;externalConsole&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MIMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lldb&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;targetArchitecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arm64&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p> 这里面有两个参数需要修改:</p>
<ul>
<li>“program”: 代表你编译生成的 java 命令的路径</li>
<li>“args”: 代表 java 命令的参数</li>
</ul>
<blockquote>
<p>小tips : args 参数可以在 JAVA IDE 的输出中找到, 但需要删除其中有关 IDE 的 aggent 参数.</p>
</blockquote>
<p>参考:<a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/cpp/config-clang-mac#_customize-debugging-with-launchjson">Customize debugging with launch.json</a></p>
<p>配置完成之后, 就能开始 debug 了.</p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a target="_blank" rel="noopener" href="https://openjdk.org/groups/build/doc/building.html">Building the JDK</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://orezzero.github.io/2022/11/23/Create-a-blog/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/13081689?v=4">
      <meta itemprop="name" content="Orez">
      <meta itemprop="description" content="分享我的日常技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Orez 的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/23/Create-a-blog/" class="post-title-link" itemprop="url">创建一个自己的博客</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-23 06:55:58" itemprop="dateCreated datePublished" datetime="2022-11-23T06:55:58+00:00">2022-11-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-28 16:37:53" itemprop="dateModified" datetime="2022-11-28T16:37:53+00:00">2022-11-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CS/Blog/" itemprop="url" rel="index"><span itemprop="name">Blog</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>几年前就搭建了自己的 Github Page, 但当时搭建的时候, 博客文章没有上传到 Github, 只上传了生成的静态文件,而且没有自动部署的能力.准备重新提笔写博客,就重新搭一套.</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>这次搭博客有如下技术目标:</p>
<ol>
<li>搭建完成之后,只依赖 <strong>文本编辑</strong>+<strong>git</strong> 就能完成写作, 不需要其他依赖(尤其是node依赖)</li>
<li>文本内容上传 Github 之后<strong>自动部署</strong>.</li>
<li>任何其他人能够方便复刻这一套方案.</li>
</ol>
<h1 id="快速复刻本项目"><a href="#快速复刻本项目" class="headerlink" title="快速复刻本项目"></a>快速复刻本项目</h1><h2 id="创建站点"><a href="#创建站点" class="headerlink" title="创建站点"></a>创建站点</h2><p>如果你也想搭建一套博客,而不想折腾环境,可以直接 Fork <a target="_blank" rel="noopener" href="https://github.com/orezzero/orezzero.github.io">本项目</a>,然后改名为 username.github.io  ，username 是你在 GitHub 上的使用者名称.<br>具体步骤为:</p>
<ol>
<li>Fork 本项目,fork 时可以将 orezzero.github.io 改为 username.github.io  ，username 是你在 GitHub 上的使用者名称.</li>
<li>进入你的仓库, 进入 Action 页面, 确认 Action 功能已经被启用</li>
<li>删除 <code>source/_posts</code> (这里面是我的文章) 除了 template.md 的文件,删除 <code>sources/images/</code>中的图片, 修改 <code>source/about/index.md</code> 然后提交代码</li>
<li>等待 Action 完成 (第一次跑pages build and deployment会失败,别管他)</li>
<li>在你的仓库中进入 Settings &gt; Pages &gt; Source，并将 branch 改为 gh-pages。(在第一次提交代码之前,这个配置无法修改)</li>
<li>手动触发 Action 中的 Pages action 或者提交一个修改触发 Action,等待 Action 完成</li>
<li>访问 username.github.io 就能看到你的站点了</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://easyit-blog.github.io/">https://easyit-blog.github.io/</a> 就是这么创建出来的.</p>
<blockquote>
<p>本项目有一些区别于原生 Next 主题的定制化配置, 可以参考 <a target="_blank" rel="noopener" href="https://github.com/OrezzerO/orezzero.github.io/pull/1">PR Modify theme settings #1</a> 来自定义你的主题.</p>
</blockquote>
<h2 id="写作"><a href="#写作" class="headerlink" title="写作"></a>写作</h2><p>在 <code>source/_posts</code> 文件夹中创建 markdown 文件. Hexo 对于 md 的格式有一定要求,需要用这种格式开头:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 创建一个自己的博客</span><br><span class="line">date: 2022-11-23 06:55:58</span><br><span class="line">tags:</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<p>这个头部后面就可以书写正文了.</p>
<h1 id="技术细节"><a href="#技术细节" class="headerlink" title="技术细节"></a>技术细节</h1><h2 id="如何从零开始搭建-Hexo"><a href="#如何从零开始搭建-Hexo" class="headerlink" title="如何从零开始搭建 Hexo"></a>如何从零开始搭建 Hexo</h2><p>我使用了 Docker 来初始化项目. 首先我通过 <a target="_blank" rel="noopener" href="https://github.com/OrezzerO/orezzero.github.io/blob/main/Dockerfile">Dockerfile</a> 创建了一个 Hexo 镜像, 启动这个镜像就会构建 Hexo 的基本环境到 &#x2F;blog 目录下. 然后我将容器中的 &#x2F;blog 目录拷贝出来. 基本环境就搭建好了.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">构建 docker 镜像</span></span><br><span class="line">docker build -t hexo .</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 docker 容器</span></span><br><span class="line">docker run --name hexo -d  -P hexo</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 拷贝</span></span></span><br><span class="line">docker cp hexo:/blog ./</span><br></pre></td></tr></table></figure>


<h2 id="本地启动-Hexo-Server"><a href="#本地启动-Hexo-Server" class="headerlink" title="本地启动 Hexo Server"></a>本地启动 Hexo Server</h2><p>按上节构造好镜像之后, 使用 docker-compose 配置文件启动 docker-compose 即可.</p>
<blockquote>
<p>需要将配置文件放在 hexo 目录, 并在这个目录执行 docker compose 命令.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 docker compose</span></span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭 docker compose</span></span><br><span class="line">docker-compose down</span><br></pre></td></tr></table></figure>


<h2 id="自动部署"><a href="#自动部署" class="headerlink" title="自动部署"></a>自动部署</h2><p>自动部署完全照搬了官网的 <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/github-pages">在 GitHub Pages 上部署 Hexo</a> 十分简单.</p>
<blockquote>
<p>自动部署在网上有很多教程, 但是这些教程都没有官网的简单可靠.</p>
</blockquote>
<h2 id="遇到的坑"><a href="#遇到的坑" class="headerlink" title="遇到的坑"></a>遇到的坑</h2><ol>
<li>主题文件夹<code>themes/next</code>没能成功上传到 github 上,导致编译不出静态页面.</li>
</ol>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a target="_blank" rel="noopener" href="https://theme-next.js.org/docs/getting-started/">Next 主题文档站</a>: 这个网站比较重要,很多配置可以参考这里的文档.<br><a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo 官网</a><br><a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/github-pages">在 GitHub Pages 上部署 Hexo</a><br><a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/setup">建站</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/overview/page/2/">2</a><a class="extend next" rel="next" href="/overview/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Orez"
      src="https://avatars.githubusercontent.com/u/13081689?v=4">
  <p class="site-author-name" itemprop="name">Orez</p>
  <div class="site-description" itemprop="description">分享我的日常技术博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/OrezzerO" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;OrezzerO" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:orezzero@163.com" title="E-Mail → mailto:orezzero@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Orez</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
